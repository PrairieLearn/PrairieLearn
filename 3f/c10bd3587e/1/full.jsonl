{"type":"file-history-snapshot","messageId":"15159e1f-6572-4492-b840-1ee473433deb","snapshot":{"messageId":"15159e1f-6572-4492-b840-1ee473433deb","trackedFileBackups":{},"timestamp":"2026-02-12T17:11:10.859Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:startup","command":"~/.claude/hooks/fix-lsp-plugins.sh"},"parentToolUseID":"a17d0f35-0f98-4316-b8d1-39dff5af0050","toolUseID":"a17d0f35-0f98-4316-b8d1-39dff5af0050","timestamp":"2026-02-12T17:10:29.024Z","uuid":"d4a4e133-e7f8-4f8f-b962-be7ebeeda474"}
{"parentUuid":"d4a4e133-e7f8-4f8f-b962-be7ebeeda474","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:startup","command":"entire hooks claude-code session-start"},"parentToolUseID":"a17d0f35-0f98-4316-b8d1-39dff5af0050","toolUseID":"a17d0f35-0f98-4316-b8d1-39dff5af0050","timestamp":"2026-02-12T17:10:29.040Z","uuid":"14e25398-138a-4c44-8db8-86db51e32cea"}
{"parentUuid":"14e25398-138a-4c44-8db8-86db51e32cea","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"user","message":{"role":"user","content":"the frontend basically needs to use the JSON value for external_grading_enabled -- if it is set in JSON, don't update the posted value. Otherwise, use true/empty string behavior.\n\nor is it easier to resolve this on the backend and not post?"},"uuid":"15159e1f-6572-4492-b840-1ee473433deb","timestamp":"2026-02-12T17:11:01.256Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"bypassPermissions"}
{"parentUuid":"15159e1f-6572-4492-b840-1ee473433deb","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","message":{"model":"claude-opus-4-6","id":"msg_01M3JaCoC7n1RpAm4EC8uncY","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8870,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8870},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YfPJwfBmWKXz3DyMzc","type":"assistant","uuid":"3f1ef799-b99e-428f-85f1-1b3d2d7a3a60","timestamp":"2026-02-12T17:11:13.129Z"}
{"parentUuid":"3f1ef799-b99e-428f-85f1-1b3d2d7a3a60","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","message":{"model":"claude-opus-4-6","id":"msg_01M3JaCoC7n1RpAm4EC8uncY","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user is talking about `external_grading_enabled` in the context of their branch `reteps/question-settings-react`. They're discussing how to handle the `external_grading_enabled` field - whether to handle it on the frontend (using the JSON value if set, otherwise using true/empty string behavior) or resolve it on the backend by not posting. Let me look at the relevant code to understand the context better.","signature":"EsUECkYICxgCKkAufMfLK9JcvdC6hJRavinqZulzmuN/CZCgMdNcuK7W7BGQampnupzaAQL3YCfTp/wmwu/HwMh82npxziL48WhEEgw7UhSAEM5iG76rk7QaDFPef/1Qnl0NU5q2/yIw1mQV9uaRMgED2mG2zBxgfYI+29M08dur605yGno+nnnEjqqXQZGdjWy+1wwpDy8DKqwDGNv2KbC14O2R8Fw5L0diROPYnZRrvbrLZ6KAwluyroCjw4WIOEuvOX2pvtV0RRvp1vxhRJGcEoaTJId/4uccY7CIdJ+qAh5/BfMyqHNMFmJRkogw1EsyppGMMesrTzlGkKmjMemb7yw5X+LBNzf0Pt4zNjW3GULQeTiL5CKFUy7a639q84cVgS5cVkQjsLxvek7jshKTGhBtUSzOBr7AXjTH7mm64cuRcKbdRBRSdocdq2tjb20cUJ49CSHhibM1sLoWHh+uqSKi4p4W3DAUOtOQjBt2/R+fZJL5J3mBo3SBgOc739gi4ikh7Vy8KysqRgMmRfztR8gFUz2C+DEBO58equ7GZ5AxI+VMWLPnwFA4/oMKqRSpMWesCYWankIDA3qVhD2dqIS7nYR8rmGXIF2weOTJp+1FEO7gNrwXsXPlhdu4AbPOix/MfzUCq6k6X7Awd6IagBL0wq0FNIAUTPqXpfmtZuHrYhegdz0j3zlaa6KkQGqILStVTm/vAyZyRqAyV3rXok/eg4B59sDXEZFj9gGh0RGLLoXbuLm83540AMy7PEcbt0uFhM0YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8870,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8870},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YfPJwfBmWKXz3DyMzc","type":"assistant","uuid":"4de109f1-5e20-4dc8-858e-c8fb5eec0a48","timestamp":"2026-02-12T17:11:15.129Z"}
{"parentUuid":"4de109f1-5e20-4dc8-858e-c8fb5eec0a48","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","message":{"model":"claude-opus-4-6","id":"msg_01M3JaCoC7n1RpAm4EC8uncY","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at the current code to understand the context."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8870,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8870},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YfPJwfBmWKXz3DyMzc","type":"assistant","uuid":"c3d8d29e-c482-4dd8-852e-60c38766893c","timestamp":"2026-02-12T17:11:15.645Z"}
{"parentUuid":"c3d8d29e-c482-4dd8-852e-60c38766893c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01M3JaCoC7n1RpAm4EC8uncY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JE7N2wVF3VdP8qEyxDY2yC","name":"Grep","input":{"pattern":"external_grading_enabled","glob":"**/*.{ts,tsx}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8870,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8870},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YfPJwfBmWKXz3DyMzc","type":"assistant","uuid":"0a861ae6-f2c5-45ca-bf51-d463f7266a72","timestamp":"2026-02-12T17:11:16.226Z"}
{"parentUuid":"0a861ae6-f2c5-45ca-bf51-d463f7266a72","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01JE7N2wVF3VdP8qEyxDY2yC","toolUseID":"toolu_01JE7N2wVF3VdP8qEyxDY2yC","timestamp":"2026-02-12T17:11:16.526Z","uuid":"ffecd2b7-fd48-4361-94a6-eaea4e1d27f6"}
{"parentUuid":"0a861ae6-f2c5-45ca-bf51-d463f7266a72","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JE7N2wVF3VdP8qEyxDY2yC","type":"tool_result","content":"Found 9 files\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts\napps/prairielearn/src/lib/db-types.ts\napps/prairielearn/src/lib/client/page-context.test.ts\napps/prairielearn/src/lib/client/safe-db-types.test.ts\napps/prairielearn/src/sync/fromDisk/questions.ts\napps/prairielearn/src/tests/instructorQuestionSettings.test.ts\napps/prairielearn/src/lib/externalGrader.ts\napps/prairielearn/src/ee/lib/billing/plan-grants.ts"}]},"uuid":"165cff0d-5427-4171-9cb1-5a09e811ba2d","timestamp":"2026-02-12T17:11:16.525Z","toolUseResult":{"mode":"files_with_matches","filenames":["apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","apps/prairielearn/src/lib/db-types.ts","apps/prairielearn/src/lib/client/page-context.test.ts","apps/prairielearn/src/lib/client/safe-db-types.test.ts","apps/prairielearn/src/sync/fromDisk/questions.ts","apps/prairielearn/src/tests/instructorQuestionSettings.test.ts","apps/prairielearn/src/lib/externalGrader.ts","apps/prairielearn/src/ee/lib/billing/plan-grants.ts"],"numFiles":9},"sourceToolAssistantUUID":"0a861ae6-f2c5-45ca-bf51-d463f7266a72"}
{"parentUuid":"165cff0d-5427-4171-9cb1-5a09e811ba2d","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01M3JaCoC7n1RpAm4EC8uncY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0165zaL4jWhk642t5xsEkT6Q","name":"Bash","input":{"command":"git diff master...HEAD --name-only","description":"List files changed in this branch"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8870,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8870},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YfPJwfBmWKXz3DyMzc","type":"assistant","uuid":"adf849b8-0923-4550-a4ba-c31b26bbed8d","timestamp":"2026-02-12T17:11:17.183Z"}
{"parentUuid":"adf849b8-0923-4550-a4ba-c31b26bbed8d","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0165zaL4jWhk642t5xsEkT6Q","type":"tool_result","content":".changeset/tagpicker.md\nAGENTS.md\napps/prairielearn/assets/scripts/esm-bundles/hydrated-components/QuestionSettingsForm.ts\napps/prairielearn/assets/scripts/instructorQuestionSettingsClient.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.html.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts\napps/prairielearn/src/schemas/infoQuestion.ts\napps/prairielearn/src/schemas/schemas/infoQuestion.json\napps/prairielearn/src/tests/accessibility/index.test.ts\napps/prairielearn/src/tests/e2e/questionSettings.spec.ts\npackages/ui/src/components/ComboBox.tsx","is_error":false}]},"uuid":"6676ae9c-b594-4a1a-9a4b-4f8e0395a7d9","timestamp":"2026-02-12T17:11:17.539Z","toolUseResult":{"stdout":".changeset/tagpicker.md\nAGENTS.md\napps/prairielearn/assets/scripts/esm-bundles/hydrated-components/QuestionSettingsForm.ts\napps/prairielearn/assets/scripts/instructorQuestionSettingsClient.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.html.tsx\napps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts\napps/prairielearn/src/schemas/infoQuestion.ts\napps/prairielearn/src/schemas/schemas/infoQuestion.json\napps/prairielearn/src/tests/accessibility/index.test.ts\napps/prairielearn/src/tests/e2e/questionSettings.spec.ts\npackages/ui/src/components/ComboBox.tsx","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"adf849b8-0923-4550-a4ba-c31b26bbed8d"}
{"parentUuid":"6676ae9c-b594-4a1a-9a4b-4f8e0395a7d9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01AjzFgQ2WnxuwdcN7tJJA3r","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012d2SUnfKJQfmx8KPvXxnXd","name":"Read","input":{"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":761,"cache_read_input_tokens":44342,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":761},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4Yfsutr2tTtbq6a5e5B","type":"assistant","uuid":"42da4a2e-704b-4e94-bac2-b464b7f9f204","timestamp":"2026-02-12T17:11:20.811Z"}
{"parentUuid":"42da4a2e-704b-4e94-bac2-b464b7f9f204","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_012d2SUnfKJQfmx8KPvXxnXd","toolUseID":"toolu_012d2SUnfKJQfmx8KPvXxnXd","timestamp":"2026-02-12T17:11:20.815Z","uuid":"7108abee-4d78-417c-8e6d-280fdc5148c4"}
{"parentUuid":"42da4a2e-704b-4e94-bac2-b464b7f9f204","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012d2SUnfKJQfmx8KPvXxnXd","type":"tool_result","content":"     1→import * as path from 'path';\n     2→\n     3→import { Router } from 'express';\n     4→import fs from 'fs-extra';\n     5→import * as shlex from 'shlex';\n     6→import { z } from 'zod';\n     7→\n     8→import * as error from '@prairielearn/error';\n     9→import { flash } from '@prairielearn/flash';\n    10→import * as sqldb from '@prairielearn/postgres';\n    11→import { run } from '@prairielearn/run';\n    12→import {\n    13→  ArrayFromStringOrArraySchema,\n    14→  BooleanFromCheckboxSchema,\n    15→  IntegerFromStringOrEmptySchema,\n    16→} from '@prairielearn/zod';\n    17→\n    18→import { b64EncodeUnicode } from '../../lib/base64-util.js';\n    19→import { copyQuestionBetweenCourses } from '../../lib/copy-content.js';\n    20→import { EnumGradingMethodSchema } from '../../lib/db-types.js';\n    21→import { propertyValueWithDefault } from '../../lib/editorUtil.shared.js';\n    22→import {\n    23→  FileModifyEditor,\n    24→  MultiEditor,\n    25→  QuestionCopyEditor,\n    26→  QuestionDeleteEditor,\n    27→  QuestionRenameEditor,\n    28→  getOriginalHash,\n    29→} from '../../lib/editors.js';\n    30→import { features } from '../../lib/features/index.js';\n    31→import { courseRepoContentUrl } from '../../lib/github.js';\n    32→import { idsEqual } from '../../lib/id.js';\n    33→import { getPaths } from '../../lib/instructorFiles.js';\n    34→import { applyKeyOrder } from '../../lib/json.js';\n    35→import { formatJsonWithPrettier } from '../../lib/prettier.js';\n    36→import { startTestQuestion } from '../../lib/question-testing.js';\n    37→import { typedAsyncHandler } from '../../lib/res-locals.js';\n    38→import { validateShortName } from '../../lib/short-name.js';\n    39→import { getCanonicalHost } from '../../lib/url.js';\n    40→import { generateCsrfToken } from '../../middlewares/csrfToken.js';\n    41→import { selectCoursesWithEditAccess } from '../../models/course.js';\n    42→import { selectQuestionByUuid } from '../../models/question.js';\n    43→import { selectTagsByCourseId, selectTagsByQuestionId } from '../../models/tags.js';\n    44→import { selectTopicsByCourseId } from '../../models/topics.js';\n    45→\n    46→import { InstructorQuestionSettings } from './instructorQuestionSettings.html.js';\n    47→import {\n    48→  SelectedAssessmentsSchema,\n    49→  type SharingSetRow,\n    50→  SharingSetRowSchema,\n    51→} from './instructorQuestionSettings.types.js';\n    52→\n    53→const router = Router();\n    54→const sql = sqldb.loadSqlEquiv(import.meta.url);\n    55→\n    56→// This will not correctly handle any filenames that have a comma in them.\n    57→// Currently, we do not have any such filenames in prod so we don't think that\n    58→// escaping commas in individual filenames is necessary.\n    59→const GradedFilesSchema = z\n    60→  .string()\n    61→  .transform((s) =>\n    62→    s\n    63→      .split(',')\n    64→      .map((s) => s.trim())\n    65→      .filter((s) => s !== ''),\n    66→  )\n    67→  .optional();\n    68→\n    69→const ArgumentsSchema = z\n    70→  .string()\n    71→  .transform((s) => shlex.split(s || ''))\n    72→  .optional();\n    73→\n    74→router.post(\n    75→  '/test',\n    76→  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    77→    if (res.locals.question.course_id !== res.locals.course.id) {\n    78→      throw new error.HttpStatusError(403, 'Access denied');\n    79→    }\n    80→    // We use a separate `test/` POST route so that we can always use the\n    81→    // route to distinguish between pages that need to execute course code\n    82→    // (this `test/` handler) and pages that need access to course content\n    83→    // editing (here the plain '/' POST handler).\n    84→    if (req.body.__action === 'test_once') {\n    85→      if (!res.locals.authz_data.has_course_permission_view) {\n    86→        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n    87→      }\n    88→      const jobSequenceId = await startTestQuestion({\n    89→        count: 1,\n    90→        showDetails: true,\n    91→        question: res.locals.question,\n    92→        course_instance: res.locals.course_instance ?? null,\n    93→        course: res.locals.course,\n    94→        user_id: res.locals.user.id,\n    95→        authn_user_id: res.locals.authn_user.id,\n    96→        // Optional variant seed prefix for deterministic testing.\n    97→        // Not exposed in UI - for internal use with automated testing scripts.\n    98→        variantSeedPrefix: req.body.variant_seed_prefix,\n    99→      });\n   100→      res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n   101→    } else if (req.body.__action === 'test_100') {\n   102→      if (!res.locals.authz_data.has_course_permission_view) {\n   103→        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n   104→      }\n   105→      if (res.locals.question.grading_method !== 'External') {\n   106→        const jobSequenceId = await startTestQuestion({\n   107→          count: 100,\n   108→          showDetails: false,\n   109→          question: res.locals.question,\n   110→          course_instance: res.locals.course_instance ?? null,\n   111→          course: res.locals.course,\n   112→          user_id: res.locals.user.id,\n   113→          authn_user_id: res.locals.authn_user.id,\n   114→          // Optional variant seed prefix for deterministic testing.\n   115→          // Not exposed in UI - for internal use with automated testing scripts.\n   116→          variantSeedPrefix: req.body.variant_seed_prefix,\n   117→        });\n   118→        res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n   119→      } else {\n   120→        throw new Error('Not supported for externally-graded questions');\n   121→      }\n   122→    } else {\n   123→      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n   124→    }\n   125→  }),\n   126→);\n   127→\n   128→router.post(\n   129→  '/',\n   130→  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n   131→    if (res.locals.question.course_id !== res.locals.course.id) {\n   132→      throw new error.HttpStatusError(403, 'Access denied');\n   133→    }\n   134→    if (req.body.__action === 'update_question') {\n   135→      const infoPath = path.join(\n   136→        res.locals.course.path,\n   137→        'questions',\n   138→        res.locals.question.qid!,\n   139→        'info.json',\n   140→      );\n   141→      if (!(await fs.pathExists(infoPath))) {\n   142→        throw new error.HttpStatusError(400, 'Question info file does not exist');\n   143→      }\n   144→\n   145→      const body = z\n   146→        .object({\n   147→          orig_hash: z.string(),\n   148→          qid: z.string(),\n   149→          title: z.string(),\n   150→          topic: z.string().optional(),\n   151→          tags: ArrayFromStringOrArraySchema.optional(),\n   152→          grading_method: EnumGradingMethodSchema.optional(),\n   153→          single_variant: BooleanFromCheckboxSchema,\n   154→          show_correct_answer: BooleanFromCheckboxSchema,\n   155→          workspace_image: z.string().optional(),\n   156→          workspace_port: IntegerFromStringOrEmptySchema.nullable().optional(),\n   157→          workspace_home: z.string().optional(),\n   158→          workspace_args: ArgumentsSchema,\n   159→          workspace_rewrite_url: BooleanFromCheckboxSchema,\n   160→          workspace_graded_files: GradedFilesSchema,\n   161→          workspace_enable_networking: BooleanFromCheckboxSchema,\n   162→          workspace_environment: z.string().optional(),\n   163→          external_grading_enabled: BooleanFromCheckboxSchema,\n   164→          external_grading_image: z.string().optional(),\n   165→          external_grading_files: GradedFilesSchema,\n   166→          external_grading_entrypoint: ArgumentsSchema,\n   167→          external_grading_timeout: IntegerFromStringOrEmptySchema.optional(),\n   168→          external_grading_enable_networking: BooleanFromCheckboxSchema,\n   169→          external_grading_environment: z.string().optional(),\n   170→        })\n   171→        .parse(req.body);\n   172→\n   173→      const shortNameValidation = validateShortName(body.qid, res.locals.question.qid ?? undefined);\n   174→      if (!shortNameValidation.valid) {\n   175→        throw new error.HttpStatusError(\n   176→          400,\n   177→          `Invalid QID: ${shortNameValidation.lowercaseMessage}`,\n   178→        );\n   179→      }\n   180→\n   181→      const paths = getPaths(undefined, res.locals);\n   182→\n   183→      const questionInfo = JSON.parse(await fs.readFile(infoPath, 'utf8'));\n   184→\n   185→      const origHash = body.orig_hash;\n   186→      questionInfo.title = body.title;\n   187→      questionInfo.topic = body.topic;\n   188→      questionInfo.tags = propertyValueWithDefault(\n   189→        questionInfo.tags,\n   190→        body.tags,\n   191→        (val: any) => !val || val.length === 0,\n   192→      );\n   193→\n   194→      questionInfo.gradingMethod = propertyValueWithDefault(\n   195→        questionInfo.gradingMethod,\n   196→        body.grading_method,\n   197→        'Internal',\n   198→      );\n   199→\n   200→      questionInfo.singleVariant = propertyValueWithDefault(\n   201→        questionInfo.singleVariant,\n   202→        body.single_variant,\n   203→        false,\n   204→      );\n   205→\n   206→      questionInfo.showCorrectAnswer = propertyValueWithDefault(\n   207→        questionInfo.showCorrectAnswer,\n   208→        body.show_correct_answer,\n   209→        true,\n   210→      );\n   211→\n   212→      const workspaceOptions = {\n   213→        comment: questionInfo.workspaceOptions?.comment ?? undefined,\n   214→        image: propertyValueWithDefault(\n   215→          questionInfo.workspaceOptions?.image,\n   216→          body.workspace_image?.trim(),\n   217→          '',\n   218→        ),\n   219→        port: propertyValueWithDefault(\n   220→          questionInfo.workspaceOptions?.port,\n   221→          body.workspace_port,\n   222→          null,\n   223→        ),\n   224→        home: propertyValueWithDefault(\n   225→          questionInfo.workspaceOptions?.home,\n   226→          body.workspace_home?.trim(),\n   227→          '',\n   228→        ),\n   229→        args: propertyValueWithDefault(\n   230→          questionInfo.workspaceOptions?.args,\n   231→          body.workspace_args,\n   232→          (v: any) => !v || v.length === 0,\n   233→        ),\n   234→        rewriteUrl: propertyValueWithDefault(\n   235→          questionInfo.workspaceOptions?.rewriteUrl,\n   236→          body.workspace_rewrite_url,\n   237→          true,\n   238→        ),\n   239→        gradedFiles: propertyValueWithDefault(\n   240→          questionInfo.workspaceOptions?.gradedFiles,\n   241→          body.workspace_graded_files,\n   242→          (v: any) => !v || v.length === 0,\n   243→        ),\n   244→        enableNetworking: propertyValueWithDefault(\n   245→          questionInfo.workspaceOptions?.enableNetworking,\n   246→          body.workspace_enable_networking,\n   247→          false,\n   248→        ),\n   249→        environment: propertyValueWithDefault(\n   250→          questionInfo.workspaceOptions?.environment,\n   251→          JSON.parse(body.workspace_environment?.replaceAll('\\r\\n', '\\n') || '{}'),\n   252→          (val: any) => !val || Object.keys(val).length === 0,\n   253→        ),\n   254→      };\n   255→\n   256→      // We'll only write the workspace options if the request contains the\n   257→      // required fields. Client-side validation will ensure that these are\n   258→      // present if a workspace is configured.\n   259→      if (workspaceOptions.image && workspaceOptions.port && workspaceOptions.home) {\n   260→        const filteredOptions = Object.fromEntries(\n   261→          Object.entries(\n   262→            propertyValueWithDefault(\n   263→              questionInfo.workspaceOptions,\n   264→              workspaceOptions,\n   265→              (val: any) => !val || Object.keys(val).length === 0,\n   266→            ),\n   267→          ).filter(([_, value]) => value !== undefined),\n   268→        );\n   269→        questionInfo.workspaceOptions =\n   270→          Object.keys(filteredOptions).length > 0\n   271→            ? applyKeyOrder(questionInfo.workspaceOptions, filteredOptions)\n   272→            : undefined;\n   273→      } else {\n   274→        questionInfo.workspaceOptions = undefined;\n   275→      }\n   276→\n   277→      const externalGradingOptions = {\n   278→        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n   279→        enabled: propertyValueWithDefault(\n   280→          questionInfo.externalGradingOptions?.enabled,\n   281→          body.external_grading_enabled,\n   282→          false,\n   283→        ),\n   284→        image: propertyValueWithDefault(\n   285→          questionInfo.externalGradingOptions?.image,\n   286→          body.external_grading_image,\n   287→          '',\n   288→        ),\n   289→        entrypoint: propertyValueWithDefault(\n   290→          questionInfo.externalGradingOptions?.entrypoint,\n   291→          body.external_grading_entrypoint,\n   292→          (v: any) => v == null || v.length === 0,\n   293→        ),\n   294→        serverFilesCourse: propertyValueWithDefault(\n   295→          questionInfo.externalGradingOptions?.serverFilesCourse,\n   296→          body.external_grading_files,\n   297→          (v: any) => !v || v.length === 0,\n   298→        ),\n   299→        timeout: propertyValueWithDefault(\n   300→          questionInfo.externalGradingOptions?.timeout,\n   301→          body.external_grading_timeout,\n   302→          null,\n   303→        ),\n   304→        enableNetworking: propertyValueWithDefault(\n   305→          questionInfo.externalGradingOptions?.enableNetworking,\n   306→          body.external_grading_enable_networking,\n   307→          false,\n   308→        ),\n   309→        environment: propertyValueWithDefault(\n   310→          questionInfo.externalGradingOptions?.environment,\n   311→          JSON.parse(body.external_grading_environment || '{}'),\n   312→          (val: any) => !val || Object.keys(val).length === 0,\n   313→        ),\n   314→      };\n   315→      if (externalGradingOptions.image) {\n   316→        const filteredExternalGradingOptions = Object.fromEntries(\n   317→          Object.entries(\n   318→            propertyValueWithDefault(\n   319→              questionInfo.externalGradingOptions,\n   320→              externalGradingOptions,\n   321→              (val: any) => !val || Object.keys(val).length === 0,\n   322→            ),\n   323→          ).filter(([_, value]) => value !== undefined),\n   324→        );\n   325→\n   326→        questionInfo.externalGradingOptions =\n   327→          Object.keys(filteredExternalGradingOptions).length > 0\n   328→            ? applyKeyOrder(questionInfo.externalGradingOptions, filteredExternalGradingOptions)\n   329→            : undefined;\n   330→      } else {\n   331→        questionInfo.externalGradingOptions = undefined;\n   332→      }\n   333→\n   334→      const formattedJson = await formatJsonWithPrettier(JSON.stringify(questionInfo));\n   335→\n   336→      const qid_new = run(() => {\n   337→        try {\n   338→          return path.normalize(req.body.qid);\n   339→        } catch {\n   340→          throw new error.HttpStatusError(\n   341→            400,\n   342→            `Invalid QID (could not be normalized): ${req.body.qid}`,\n   343→          );\n   344→        }\n   345→      });\n   346→\n   347→      const editor = new MultiEditor(\n   348→        {\n   349→          locals: res.locals,\n   350→          // This won't reflect if the operation is an update or a rename; we think that's OK.\n   351→          description: `Update question ${res.locals.question.qid}`,\n   352→        },\n   353→        [\n   354→          // Each of these editors will no-op if there wasn't any change.\n   355→          new FileModifyEditor({\n   356→            locals: res.locals,\n   357→            container: {\n   358→              rootPath: paths.rootPath,\n   359→              invalidRootPaths: paths.invalidRootPaths,\n   360→            },\n   361→            filePath: path.join(paths.rootPath, 'info.json'),\n   362→            editContents: b64EncodeUnicode(formattedJson),\n   363→            origHash,\n   364→          }),\n   365→          new QuestionRenameEditor({\n   366→            locals: res.locals,\n   367→            qid_new,\n   368→          }),\n   369→        ],\n   370→      );\n   371→      const serverJob = await editor.prepareServerJob();\n   372→      try {\n   373→        await editor.executeWithServerJob(serverJob);\n   374→      } catch {\n   375→        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n   376→      }\n   377→\n   378→      flash('success', 'Question settings updated successfully');\n   379→      return res.redirect(req.originalUrl);\n   380→    } else if (req.body.__action === 'copy_question') {\n   381→      if (idsEqual(req.body.to_course_id, res.locals.course.id)) {\n   382→        // In this case, we are making a duplicate of this question in the same course\n   383→        const editor = new QuestionCopyEditor({\n   384→          locals: res.locals,\n   385→          from_qid: res.locals.question.qid!,\n   386→          from_course: res.locals.course,\n   387→          from_path: path.join(res.locals.course.path, 'questions', res.locals.question.qid!),\n   388→          is_transfer: false,\n   389→        });\n   390→        const serverJob = await editor.prepareServerJob();\n   391→        try {\n   392→          await editor.executeWithServerJob(serverJob);\n   393→        } catch {\n   394→          return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n   395→        }\n   396→\n   397→        const question = await selectQuestionByUuid({\n   398→          course_id: res.locals.course.id,\n   399→          uuid: editor.uuid,\n   400→        });\n   401→\n   402→        flash(\n   403→          'success',\n   404→          'Question copied successfully. You are now viewing your copy of the question.',\n   405→        );\n   406→        res.redirect(res.locals.urlPrefix + '/question/' + question.id + '/settings');\n   407→      } else {\n   408→        await copyQuestionBetweenCourses(res, {\n   409→          fromCourse: res.locals.course,\n   410→          toCourseId: req.body.to_course_id,\n   411→          question: res.locals.question,\n   412→        });\n   413→      }\n   414→    } else if (req.body.__action === 'delete_question') {\n   415→      const editor = new QuestionDeleteEditor({\n   416→        locals: res.locals,\n   417→        questions: res.locals.question,\n   418→      });\n   419→      const serverJob = await editor.prepareServerJob();\n   420→      try {\n   421→        await editor.executeWithServerJob(serverJob);\n   422→        res.redirect(res.locals.urlPrefix + '/course_admin/questions');\n   423→      } catch {\n   424→        res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n   425→      }\n   426→    } else {\n   427→      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n   428→    }\n   429→  }),\n   430→);\n   431→\n   432→router.get(\n   433→  '/',\n   434→  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n   435→    if (res.locals.question.course_id !== res.locals.course.id) {\n   436→      throw new error.HttpStatusError(403, 'Access denied');\n   437→    }\n   438→    // Construct the path of the question test route. We'll do this based on\n   439→    // `originalUrl` so that this router doesn't have to be aware of where it's\n   440→    // mounted.\n   441→    const host = getCanonicalHost(req);\n   442→    let questionTestPath = new URL(req.originalUrl, host).pathname;\n   443→    if (!questionTestPath.endsWith('/')) {\n   444→      questionTestPath += '/';\n   445→    }\n   446→    questionTestPath += 'test';\n   447→\n   448→    // Generate a CSRF token for the test route. We can't use `res.locals.__csrf_token`\n   449→    // here because this form will actually post to a different route, not `req.originalUrl`.\n   450→    const questionTestCsrfToken = generateCsrfToken({\n   451→      url: questionTestPath,\n   452→      authnUserId: res.locals.authn_user.id,\n   453→    });\n   454→\n   455→    const questionGHLink = courseRepoContentUrl(\n   456→      res.locals.course,\n   457→      `questions/${res.locals.question.qid}`,\n   458→    );\n   459→\n   460→    const qids = await sqldb.queryRows(sql.qids, { course_id: res.locals.course.id }, z.string());\n   461→\n   462→    const assessmentsWithQuestion = await sqldb.queryRows(\n   463→      sql.select_assessments_with_question_for_display,\n   464→      { question_id: res.locals.question.id },\n   465→      SelectedAssessmentsSchema,\n   466→    );\n   467→\n   468→    const courseTopics = await selectTopicsByCourseId(res.locals.course.id);\n   469→    const courseTags = await selectTagsByCourseId(res.locals.course.id);\n   470→    const questionTags = await selectTagsByQuestionId(res.locals.question.id);\n   471→\n   472→    const sharingEnabled = await features.enabledFromLocals('question-sharing', res.locals);\n   473→\n   474→    let sharingSetsIn: SharingSetRow[] | undefined;\n   475→    if (sharingEnabled) {\n   476→      const result = await sqldb.queryRows(\n   477→        sql.select_sharing_sets,\n   478→        {\n   479→          question_id: res.locals.question.id,\n   480→          course_id: res.locals.course.id,\n   481→        },\n   482→        SharingSetRowSchema,\n   483→      );\n   484→      sharingSetsIn = result.filter((row) => row.in_set);\n   485→    }\n   486→    const editableCourses = await selectCoursesWithEditAccess({\n   487→      user_id: res.locals.user.id,\n   488→      is_administrator: res.locals.is_administrator,\n   489→    });\n   490→    const infoPath = path.join('questions', res.locals.question.qid!, 'info.json');\n   491→    const fullInfoPath = path.join(res.locals.course.path, infoPath);\n   492→\n   493→    const origHash = (await getOriginalHash(fullInfoPath)) ?? '';\n   494→\n   495→    const canEdit =\n   496→      res.locals.authz_data.has_course_permission_edit && !res.locals.course.example_course;\n   497→\n   498→    res.send(\n   499→      InstructorQuestionSettings({\n   500→        resLocals: res.locals,\n   501→        questionTestPath,\n   502→        questionTestCsrfToken,\n   503→        questionGHLink,\n   504→        questionTags,\n   505→        qids,\n   506→        assessmentsWithQuestion,\n   507→        sharingEnabled,\n   508→        sharingSetsIn,\n   509→        editableCourses,\n   510→        infoPath,\n   511→        origHash,\n   512→        canEdit,\n   513→        courseTopics,\n   514→        courseTags,\n   515→      }),\n   516→    );\n   517→  }),\n   518→);\n   519→\n   520→export default router;\n   521→"}]},"uuid":"2a0030b4-6dfd-4f83-a480-27581e6ee84c","timestamp":"2026-02-12T17:11:20.815Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","content":"import * as path from 'path';\n\nimport { Router } from 'express';\nimport fs from 'fs-extra';\nimport * as shlex from 'shlex';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\nimport * as sqldb from '@prairielearn/postgres';\nimport { run } from '@prairielearn/run';\nimport {\n  ArrayFromStringOrArraySchema,\n  BooleanFromCheckboxSchema,\n  IntegerFromStringOrEmptySchema,\n} from '@prairielearn/zod';\n\nimport { b64EncodeUnicode } from '../../lib/base64-util.js';\nimport { copyQuestionBetweenCourses } from '../../lib/copy-content.js';\nimport { EnumGradingMethodSchema } from '../../lib/db-types.js';\nimport { propertyValueWithDefault } from '../../lib/editorUtil.shared.js';\nimport {\n  FileModifyEditor,\n  MultiEditor,\n  QuestionCopyEditor,\n  QuestionDeleteEditor,\n  QuestionRenameEditor,\n  getOriginalHash,\n} from '../../lib/editors.js';\nimport { features } from '../../lib/features/index.js';\nimport { courseRepoContentUrl } from '../../lib/github.js';\nimport { idsEqual } from '../../lib/id.js';\nimport { getPaths } from '../../lib/instructorFiles.js';\nimport { applyKeyOrder } from '../../lib/json.js';\nimport { formatJsonWithPrettier } from '../../lib/prettier.js';\nimport { startTestQuestion } from '../../lib/question-testing.js';\nimport { typedAsyncHandler } from '../../lib/res-locals.js';\nimport { validateShortName } from '../../lib/short-name.js';\nimport { getCanonicalHost } from '../../lib/url.js';\nimport { generateCsrfToken } from '../../middlewares/csrfToken.js';\nimport { selectCoursesWithEditAccess } from '../../models/course.js';\nimport { selectQuestionByUuid } from '../../models/question.js';\nimport { selectTagsByCourseId, selectTagsByQuestionId } from '../../models/tags.js';\nimport { selectTopicsByCourseId } from '../../models/topics.js';\n\nimport { InstructorQuestionSettings } from './instructorQuestionSettings.html.js';\nimport {\n  SelectedAssessmentsSchema,\n  type SharingSetRow,\n  SharingSetRowSchema,\n} from './instructorQuestionSettings.types.js';\n\nconst router = Router();\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\n// This will not correctly handle any filenames that have a comma in them.\n// Currently, we do not have any such filenames in prod so we don't think that\n// escaping commas in individual filenames is necessary.\nconst GradedFilesSchema = z\n  .string()\n  .transform((s) =>\n    s\n      .split(',')\n      .map((s) => s.trim())\n      .filter((s) => s !== ''),\n  )\n  .optional();\n\nconst ArgumentsSchema = z\n  .string()\n  .transform((s) => shlex.split(s || ''))\n  .optional();\n\nrouter.post(\n  '/test',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // We use a separate `test/` POST route so that we can always use the\n    // route to distinguish between pages that need to execute course code\n    // (this `test/` handler) and pages that need access to course content\n    // editing (here the plain '/' POST handler).\n    if (req.body.__action === 'test_once') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      const jobSequenceId = await startTestQuestion({\n        count: 1,\n        showDetails: true,\n        question: res.locals.question,\n        course_instance: res.locals.course_instance ?? null,\n        course: res.locals.course,\n        user_id: res.locals.user.id,\n        authn_user_id: res.locals.authn_user.id,\n        // Optional variant seed prefix for deterministic testing.\n        // Not exposed in UI - for internal use with automated testing scripts.\n        variantSeedPrefix: req.body.variant_seed_prefix,\n      });\n      res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n    } else if (req.body.__action === 'test_100') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      if (res.locals.question.grading_method !== 'External') {\n        const jobSequenceId = await startTestQuestion({\n          count: 100,\n          showDetails: false,\n          question: res.locals.question,\n          course_instance: res.locals.course_instance ?? null,\n          course: res.locals.course,\n          user_id: res.locals.user.id,\n          authn_user_id: res.locals.authn_user.id,\n          // Optional variant seed prefix for deterministic testing.\n          // Not exposed in UI - for internal use with automated testing scripts.\n          variantSeedPrefix: req.body.variant_seed_prefix,\n        });\n        res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n      } else {\n        throw new Error('Not supported for externally-graded questions');\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.post(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    if (req.body.__action === 'update_question') {\n      const infoPath = path.join(\n        res.locals.course.path,\n        'questions',\n        res.locals.question.qid!,\n        'info.json',\n      );\n      if (!(await fs.pathExists(infoPath))) {\n        throw new error.HttpStatusError(400, 'Question info file does not exist');\n      }\n\n      const body = z\n        .object({\n          orig_hash: z.string(),\n          qid: z.string(),\n          title: z.string(),\n          topic: z.string().optional(),\n          tags: ArrayFromStringOrArraySchema.optional(),\n          grading_method: EnumGradingMethodSchema.optional(),\n          single_variant: BooleanFromCheckboxSchema,\n          show_correct_answer: BooleanFromCheckboxSchema,\n          workspace_image: z.string().optional(),\n          workspace_port: IntegerFromStringOrEmptySchema.nullable().optional(),\n          workspace_home: z.string().optional(),\n          workspace_args: ArgumentsSchema,\n          workspace_rewrite_url: BooleanFromCheckboxSchema,\n          workspace_graded_files: GradedFilesSchema,\n          workspace_enable_networking: BooleanFromCheckboxSchema,\n          workspace_environment: z.string().optional(),\n          external_grading_enabled: BooleanFromCheckboxSchema,\n          external_grading_image: z.string().optional(),\n          external_grading_files: GradedFilesSchema,\n          external_grading_entrypoint: ArgumentsSchema,\n          external_grading_timeout: IntegerFromStringOrEmptySchema.optional(),\n          external_grading_enable_networking: BooleanFromCheckboxSchema,\n          external_grading_environment: z.string().optional(),\n        })\n        .parse(req.body);\n\n      const shortNameValidation = validateShortName(body.qid, res.locals.question.qid ?? undefined);\n      if (!shortNameValidation.valid) {\n        throw new error.HttpStatusError(\n          400,\n          `Invalid QID: ${shortNameValidation.lowercaseMessage}`,\n        );\n      }\n\n      const paths = getPaths(undefined, res.locals);\n\n      const questionInfo = JSON.parse(await fs.readFile(infoPath, 'utf8'));\n\n      const origHash = body.orig_hash;\n      questionInfo.title = body.title;\n      questionInfo.topic = body.topic;\n      questionInfo.tags = propertyValueWithDefault(\n        questionInfo.tags,\n        body.tags,\n        (val: any) => !val || val.length === 0,\n      );\n\n      questionInfo.gradingMethod = propertyValueWithDefault(\n        questionInfo.gradingMethod,\n        body.grading_method,\n        'Internal',\n      );\n\n      questionInfo.singleVariant = propertyValueWithDefault(\n        questionInfo.singleVariant,\n        body.single_variant,\n        false,\n      );\n\n      questionInfo.showCorrectAnswer = propertyValueWithDefault(\n        questionInfo.showCorrectAnswer,\n        body.show_correct_answer,\n        true,\n      );\n\n      const workspaceOptions = {\n        comment: questionInfo.workspaceOptions?.comment ?? undefined,\n        image: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.image,\n          body.workspace_image?.trim(),\n          '',\n        ),\n        port: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.port,\n          body.workspace_port,\n          null,\n        ),\n        home: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.home,\n          body.workspace_home?.trim(),\n          '',\n        ),\n        args: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.args,\n          body.workspace_args,\n          (v: any) => !v || v.length === 0,\n        ),\n        rewriteUrl: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.rewriteUrl,\n          body.workspace_rewrite_url,\n          true,\n        ),\n        gradedFiles: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.gradedFiles,\n          body.workspace_graded_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.enableNetworking,\n          body.workspace_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.environment,\n          JSON.parse(body.workspace_environment?.replaceAll('\\r\\n', '\\n') || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n\n      // We'll only write the workspace options if the request contains the\n      // required fields. Client-side validation will ensure that these are\n      // present if a workspace is configured.\n      if (workspaceOptions.image && workspaceOptions.port && workspaceOptions.home) {\n        const filteredOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.workspaceOptions,\n              workspaceOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n        questionInfo.workspaceOptions =\n          Object.keys(filteredOptions).length > 0\n            ? applyKeyOrder(questionInfo.workspaceOptions, filteredOptions)\n            : undefined;\n      } else {\n        questionInfo.workspaceOptions = undefined;\n      }\n\n      const externalGradingOptions = {\n        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n        enabled: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enabled,\n          body.external_grading_enabled,\n          false,\n        ),\n        image: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.image,\n          body.external_grading_image,\n          '',\n        ),\n        entrypoint: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.entrypoint,\n          body.external_grading_entrypoint,\n          (v: any) => v == null || v.length === 0,\n        ),\n        serverFilesCourse: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.serverFilesCourse,\n          body.external_grading_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        timeout: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.timeout,\n          body.external_grading_timeout,\n          null,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enableNetworking,\n          body.external_grading_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.environment,\n          JSON.parse(body.external_grading_environment || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n      if (externalGradingOptions.image) {\n        const filteredExternalGradingOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.externalGradingOptions,\n              externalGradingOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n\n        questionInfo.externalGradingOptions =\n          Object.keys(filteredExternalGradingOptions).length > 0\n            ? applyKeyOrder(questionInfo.externalGradingOptions, filteredExternalGradingOptions)\n            : undefined;\n      } else {\n        questionInfo.externalGradingOptions = undefined;\n      }\n\n      const formattedJson = await formatJsonWithPrettier(JSON.stringify(questionInfo));\n\n      const qid_new = run(() => {\n        try {\n          return path.normalize(req.body.qid);\n        } catch {\n          throw new error.HttpStatusError(\n            400,\n            `Invalid QID (could not be normalized): ${req.body.qid}`,\n          );\n        }\n      });\n\n      const editor = new MultiEditor(\n        {\n          locals: res.locals,\n          // This won't reflect if the operation is an update or a rename; we think that's OK.\n          description: `Update question ${res.locals.question.qid}`,\n        },\n        [\n          // Each of these editors will no-op if there wasn't any change.\n          new FileModifyEditor({\n            locals: res.locals,\n            container: {\n              rootPath: paths.rootPath,\n              invalidRootPaths: paths.invalidRootPaths,\n            },\n            filePath: path.join(paths.rootPath, 'info.json'),\n            editContents: b64EncodeUnicode(formattedJson),\n            origHash,\n          }),\n          new QuestionRenameEditor({\n            locals: res.locals,\n            qid_new,\n          }),\n        ],\n      );\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n\n      flash('success', 'Question settings updated successfully');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'copy_question') {\n      if (idsEqual(req.body.to_course_id, res.locals.course.id)) {\n        // In this case, we are making a duplicate of this question in the same course\n        const editor = new QuestionCopyEditor({\n          locals: res.locals,\n          from_qid: res.locals.question.qid!,\n          from_course: res.locals.course,\n          from_path: path.join(res.locals.course.path, 'questions', res.locals.question.qid!),\n          is_transfer: false,\n        });\n        const serverJob = await editor.prepareServerJob();\n        try {\n          await editor.executeWithServerJob(serverJob);\n        } catch {\n          return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n        }\n\n        const question = await selectQuestionByUuid({\n          course_id: res.locals.course.id,\n          uuid: editor.uuid,\n        });\n\n        flash(\n          'success',\n          'Question copied successfully. You are now viewing your copy of the question.',\n        );\n        res.redirect(res.locals.urlPrefix + '/question/' + question.id + '/settings');\n      } else {\n        await copyQuestionBetweenCourses(res, {\n          fromCourse: res.locals.course,\n          toCourseId: req.body.to_course_id,\n          question: res.locals.question,\n        });\n      }\n    } else if (req.body.__action === 'delete_question') {\n      const editor = new QuestionDeleteEditor({\n        locals: res.locals,\n        questions: res.locals.question,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n        res.redirect(res.locals.urlPrefix + '/course_admin/questions');\n      } catch {\n        res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.get(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // Construct the path of the question test route. We'll do this based on\n    // `originalUrl` so that this router doesn't have to be aware of where it's\n    // mounted.\n    const host = getCanonicalHost(req);\n    let questionTestPath = new URL(req.originalUrl, host).pathname;\n    if (!questionTestPath.endsWith('/')) {\n      questionTestPath += '/';\n    }\n    questionTestPath += 'test';\n\n    // Generate a CSRF token for the test route. We can't use `res.locals.__csrf_token`\n    // here because this form will actually post to a different route, not `req.originalUrl`.\n    const questionTestCsrfToken = generateCsrfToken({\n      url: questionTestPath,\n      authnUserId: res.locals.authn_user.id,\n    });\n\n    const questionGHLink = courseRepoContentUrl(\n      res.locals.course,\n      `questions/${res.locals.question.qid}`,\n    );\n\n    const qids = await sqldb.queryRows(sql.qids, { course_id: res.locals.course.id }, z.string());\n\n    const assessmentsWithQuestion = await sqldb.queryRows(\n      sql.select_assessments_with_question_for_display,\n      { question_id: res.locals.question.id },\n      SelectedAssessmentsSchema,\n    );\n\n    const courseTopics = await selectTopicsByCourseId(res.locals.course.id);\n    const courseTags = await selectTagsByCourseId(res.locals.course.id);\n    const questionTags = await selectTagsByQuestionId(res.locals.question.id);\n\n    const sharingEnabled = await features.enabledFromLocals('question-sharing', res.locals);\n\n    let sharingSetsIn: SharingSetRow[] | undefined;\n    if (sharingEnabled) {\n      const result = await sqldb.queryRows(\n        sql.select_sharing_sets,\n        {\n          question_id: res.locals.question.id,\n          course_id: res.locals.course.id,\n        },\n        SharingSetRowSchema,\n      );\n      sharingSetsIn = result.filter((row) => row.in_set);\n    }\n    const editableCourses = await selectCoursesWithEditAccess({\n      user_id: res.locals.user.id,\n      is_administrator: res.locals.is_administrator,\n    });\n    const infoPath = path.join('questions', res.locals.question.qid!, 'info.json');\n    const fullInfoPath = path.join(res.locals.course.path, infoPath);\n\n    const origHash = (await getOriginalHash(fullInfoPath)) ?? '';\n\n    const canEdit =\n      res.locals.authz_data.has_course_permission_edit && !res.locals.course.example_course;\n\n    res.send(\n      InstructorQuestionSettings({\n        resLocals: res.locals,\n        questionTestPath,\n        questionTestCsrfToken,\n        questionGHLink,\n        questionTags,\n        qids,\n        assessmentsWithQuestion,\n        sharingEnabled,\n        sharingSetsIn,\n        editableCourses,\n        infoPath,\n        origHash,\n        canEdit,\n        courseTopics,\n        courseTags,\n      }),\n    );\n  }),\n);\n\nexport default router;\n","numLines":521,"startLine":1,"totalLines":521}},"sourceToolAssistantUUID":"42da4a2e-704b-4e94-bac2-b464b7f9f204"}
{"parentUuid":"2a0030b4-6dfd-4f83-a480-27581e6ee84c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01AjzFgQ2WnxuwdcN7tJJA3r","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HGpRa2Fu1wbeMGX3zxD2Dz","name":"Read","input":{"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":761,"cache_read_input_tokens":44342,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":761},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4Yfsutr2tTtbq6a5e5B","type":"assistant","uuid":"f49179e3-67b7-402a-b219-c3ddca39bbf9","timestamp":"2026-02-12T17:11:21.583Z"}
{"parentUuid":"f49179e3-67b7-402a-b219-c3ddca39bbf9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01HGpRa2Fu1wbeMGX3zxD2Dz","toolUseID":"toolu_01HGpRa2Fu1wbeMGX3zxD2Dz","timestamp":"2026-02-12T17:11:21.807Z","uuid":"da93075f-ea82-4770-82ae-86e586765bf6"}
{"parentUuid":"f49179e3-67b7-402a-b219-c3ddca39bbf9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HGpRa2Fu1wbeMGX3zxD2Dz","type":"tool_result","content":"     1→import clsx from 'clsx';\n     2→import { useMemo } from 'react';\n     3→import { useForm } from 'react-hook-form';\n     4→\n     5→import { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n     6→\n     7→import { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\n     8→import { TagBadge } from '../../../components/TagBadge.js';\n     9→import { TagDescription } from '../../../components/TagDescription.js';\n    10→import { TopicBadge } from '../../../components/TopicBadge.js';\n    11→import { TopicDescription } from '../../../components/TopicDescription.js';\n    12→import type {\n    13→  StaffCourseInstance,\n    14→  StaffQuestion,\n    15→  StaffTag,\n    16→  StaffTopic,\n    17→} from '../../../lib/client/safe-db-types.js';\n    18→import { idsEqual } from '../../../lib/id.js';\n    19→import { validateShortName } from '../../../lib/short-name.js';\n    20→import type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n    21→\n    22→function AssessmentBadges({\n    23→  assessmentsWithQuestion,\n    24→  courseInstanceId,\n    25→}: {\n    26→  assessmentsWithQuestion: SelectedAssessments[];\n    27→  courseInstanceId: string;\n    28→}) {\n    29→  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    30→    idsEqual(a.course_instance_id, courseInstanceId),\n    31→  );\n    32→\n    33→  if (\n    34→    !assessmentsInCourseInstance?.assessments ||\n    35→    assessmentsInCourseInstance.assessments.length === 0\n    36→  ) {\n    37→    return (\n    38→      <small className=\"text-muted text-center\">\n    39→        This question is not included in any assessments in this course instance.\n    40→      </small>\n    41→    );\n    42→  }\n    43→\n    44→  return (\n    45→    <div className=\"d-flex flex-wrap gap-1\">\n    46→      {assessmentsInCourseInstance.assessments.map((assessment) => (\n    47→        <a\n    48→          key={assessment.assessment_id}\n    49→          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n    50→          className={`btn btn-badge color-${assessment.color}`}\n    51→        >\n    52→          {assessment.label}\n    53→        </a>\n    54→      ))}\n    55→    </div>\n    56→  );\n    57→}\n    58→\n    59→interface QuestionSettingsFormValues {\n    60→  qid: string;\n    61→  title: string;\n    62→  topic: string;\n    63→  tags: string[];\n    64→  grading_method: 'Internal' | 'External' | 'Manual';\n    65→  single_variant: boolean;\n    66→  show_correct_answer: boolean;\n    67→  workspace_enabled: boolean;\n    68→  workspace_image: string;\n    69→  workspace_port: string;\n    70→  workspace_home: string;\n    71→  workspace_graded_files: string;\n    72→  workspace_args: string;\n    73→  workspace_environment: string;\n    74→  workspace_enable_networking: boolean;\n    75→  workspace_rewrite_url: boolean;\n    76→  external_grading_enabled: boolean;\n    77→  external_grading_image: string;\n    78→  external_grading_entrypoint: string;\n    79→  external_grading_files: string;\n    80→  external_grading_timeout: string;\n    81→  external_grading_enable_networking: boolean;\n    82→  external_grading_environment: string;\n    83→}\n    84→\n    85→export function validateJson(value: string): string | true {\n    86→  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n    87→  try {\n    88→    const parsed = JSON.parse(value);\n    89→    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n    90→      return 'Must be a valid JSON object';\n    91→    }\n    92→    return true;\n    93→  } catch {\n    94→    return 'Invalid JSON format';\n    95→  }\n    96→}\n    97→\n    98→export const QuestionSettingsForm = ({\n    99→  question,\n   100→  topic,\n   101→  courseInstance,\n   102→  assessmentsWithQuestion,\n   103→  courseTopics,\n   104→  courseTags,\n   105→  questionTags,\n   106→  qids,\n   107→  origHash,\n   108→  csrfToken,\n   109→  canEdit,\n   110→}: {\n   111→  question: StaffQuestion;\n   112→  courseInstance?: StaffCourseInstance | null;\n   113→  assessmentsWithQuestion: SelectedAssessments[];\n   114→  topic: StaffTopic;\n   115→  courseTopics: StaffTopic[];\n   116→  courseTags: StaffTag[];\n   117→  questionTags: StaffTag[];\n   118→  qids: string[];\n   119→  origHash: string;\n   120→  csrfToken: string;\n   121→  canEdit: boolean;\n   122→}) => {\n   123→  const defaultValues: QuestionSettingsFormValues = {\n   124→    qid: question.qid ?? '',\n   125→    title: question.title ?? '',\n   126→    topic: topic.name,\n   127→    tags: questionTags.map((t) => t.name),\n   128→    grading_method: question.grading_method,\n   129→    single_variant: question.single_variant ?? false,\n   130→    show_correct_answer: question.show_correct_answer ?? true,\n   131→    workspace_enabled: !!question.workspace_image,\n   132→    workspace_image: question.workspace_image ?? '',\n   133→    workspace_port: question.workspace_port?.toString() ?? '',\n   134→    workspace_home: question.workspace_home ?? '',\n   135→    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n   136→    workspace_args: question.workspace_args ?? '',\n   137→    workspace_environment:\n   138→      Object.keys(question.workspace_environment ?? {}).length > 0\n   139→        ? JSON.stringify(question.workspace_environment, null, 2)\n   140→        : '{}',\n   141→    workspace_enable_networking: question.workspace_enable_networking ?? false,\n   142→    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n   143→    external_grading_enabled: !!question.external_grading_image,\n   144→    external_grading_image: question.external_grading_image ?? '',\n   145→    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n   146→    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n   147→    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n   148→    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n   149→    external_grading_environment:\n   150→      Object.keys(question.external_grading_environment).length > 0\n   151→        ? JSON.stringify(question.external_grading_environment, null, 2)\n   152→        : '{}',\n   153→  };\n   154→\n   155→  const {\n   156→    register,\n   157→    watch,\n   158→    setValue,\n   159→    trigger,\n   160→    clearErrors,\n   161→    formState: { errors, isDirty },\n   162→  } = useForm<QuestionSettingsFormValues>({\n   163→    mode: 'onChange',\n   164→    defaultValues,\n   165→  });\n   166→\n   167→  const selectedTopic = watch('topic');\n   168→  const selectedTags = watch('tags');\n   169→  const selectedGradingMethod = watch('grading_method');\n   170→  const workspaceEnabled = watch('workspace_enabled');\n   171→  const externalGradingEnabled = watch('external_grading_enabled');\n   172→\n   173→  const isExternalGrading = selectedGradingMethod === 'External';\n   174→\n   175→  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n   176→    () =>\n   177→      courseTopics.map((t) => ({\n   178→        id: t.name,\n   179→        data: t,\n   180→        label: t.name,\n   181→        searchableText: `${t.name} ${t.description}`,\n   182→      })),\n   183→    [courseTopics],\n   184→  );\n   185→\n   186→  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n   187→    () =>\n   188→      [...courseTags]\n   189→        .sort((a, b) => {\n   190→          // Sort explicit tags above implicit tags, then by name\n   191→          if (a.implicit !== b.implicit) {\n   192→            return a.implicit ? 1 : -1;\n   193→          }\n   194→          return a.name.localeCompare(b.name);\n   195→        })\n   196→        .map((t) => ({\n   197→          id: t.name,\n   198→          data: t,\n   199→          label: t.name,\n   200→          searchableText: `${t.name} ${t.description}`,\n   201→        })),\n   202→    [courseTags],\n   203→  );\n   204→\n   205→  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n   206→  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n   207→\n   208→  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n   209→\n   210→  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n   211→    const isValid = await trigger();\n   212→    if (!isValid) {\n   213→      e.preventDefault();\n   214→    }\n   215→  };\n   216→\n   217→  return (\n   218→    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n   219→      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n   220→      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n   221→\n   222→      <div className=\"mb-3\">\n   223→        <label className=\"form-label\" htmlFor=\"qid\">\n   224→          QID\n   225→        </label>\n   226→        <input\n   227→          type=\"text\"\n   228→          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n   229→          id=\"qid\"\n   230→          disabled={!canEdit}\n   231→          aria-invalid={!!errors.qid || undefined}\n   232→          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n   233→          {...register('qid', {\n   234→            required: 'QID is required',\n   235→            validate: {\n   236→              shortName: (value) => {\n   237→                const result = validateShortName(value, defaultValues.qid);\n   238→                return result.valid || result.message;\n   239→              },\n   240→              duplicate: (value) => {\n   241→                if (otherQids.has(value)) {\n   242→                  return 'This QID is already in use';\n   243→                }\n   244→                return true;\n   245→              },\n   246→            },\n   247→          })}\n   248→        />\n   249→        {errors.qid && (\n   250→          <div id=\"qid-error\" className=\"invalid-feedback\">\n   251→            {errors.qid.message}\n   252→          </div>\n   253→        )}\n   254→        <small className=\"form-text text-muted\">\n   255→          <QuestionShortNameDescription />\n   256→        </small>\n   257→      </div>\n   258→\n   259→      <div className=\"mb-3\">\n   260→        <h2 className=\"h4\">General</h2>\n   261→        <label className=\"form-label\" htmlFor=\"title\">\n   262→          Title\n   263→        </label>\n   264→        <input\n   265→          type=\"text\"\n   266→          className=\"form-control\"\n   267→          id=\"title\"\n   268→          disabled={!canEdit}\n   269→          {...register('title')}\n   270→        />\n   271→        <small className=\"form-text text-muted\">\n   272→          The title of the question (e.g., \"Add two numbers\").\n   273→        </small>\n   274→      </div>\n   275→\n   276→      <div className=\"table-responsive card mb-3 overflow-visible\">\n   277→        <table\n   278→          className=\"table two-column-description\"\n   279→          aria-label=\"Question topic, tags, and assessments\"\n   280→        >\n   281→          <tbody>\n   282→            <tr>\n   283→              <th className=\"align-middle\">\n   284→                <label id=\"topic-label\" htmlFor=\"topic\">\n   285→                  Topic\n   286→                </label>\n   287→              </th>\n   288→              <td>\n   289→                {canEdit ? (\n   290→                  <ComboBox\n   291→                    id=\"topic\"\n   292→                    name=\"topic\"\n   293→                    items={topicItems}\n   294→                    value={selectedTopic}\n   295→                    placeholder=\"Select a topic\"\n   296→                    aria-labelledby=\"topic-label\"\n   297→                    renderItem={(item) => (\n   298→                      <div style={{ whiteSpace: 'normal' }}>\n   299→                        <TopicBadge topic={item.data!} />\n   300→                        {item.data!.description && (\n   301→                          <div>\n   302→                            <small className=\"text-muted\">\n   303→                              <TopicDescription topic={item.data!} />\n   304→                            </small>\n   305→                          </div>\n   306→                        )}\n   307→                      </div>\n   308→                    )}\n   309→                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n   310→                  />\n   311→                ) : currentTopicData ? (\n   312→                  <TopicBadge topic={currentTopicData} />\n   313→                ) : null}\n   314→              </td>\n   315→            </tr>\n   316→            <tr>\n   317→              <th className=\"align-middle\">\n   318→                <label id=\"tags-label\" htmlFor=\"tags\">\n   319→                  Tags\n   320→                </label>\n   321→              </th>\n   322→              <td>\n   323→                {canEdit ? (\n   324→                  <TagPicker\n   325→                    id=\"tags\"\n   326→                    name=\"tags\"\n   327→                    items={tagItems}\n   328→                    value={selectedTags}\n   329→                    placeholder=\"Select tags\"\n   330→                    aria-labelledby=\"tags-label\"\n   331→                    renderItem={(item) => (\n   332→                      <div style={{ whiteSpace: 'normal' }}>\n   333→                        <TagBadge tag={item.data!} />\n   334→                        {!item.data!.implicit && item.data!.description && (\n   335→                          <div>\n   336→                            <small className=\"text-muted\">\n   337→                              <TagDescription tag={item.data!} />\n   338→                            </small>\n   339→                          </div>\n   340→                        )}\n   341→                      </div>\n   342→                    )}\n   343→                    renderTagContent={(data) => data.name}\n   344→                    tagClassName={(data) => `badge color-${data.color}`}\n   345→                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n   346→                  />\n   347→                ) : (\n   348→                  currentTagsData.map((tag) => (\n   349→                    <span key={tag.name} className=\"me-1\">\n   350→                      <TagBadge tag={tag} />\n   351→                    </span>\n   352→                  ))\n   353→                )}\n   354→              </td>\n   355→            </tr>\n   356→            {courseInstance && (\n   357→              <tr>\n   358→                <th className=\"align-middle\">Assessments</th>\n   359→                <td>\n   360→                  <AssessmentBadges\n   361→                    assessmentsWithQuestion={assessmentsWithQuestion}\n   362→                    courseInstanceId={courseInstance.id}\n   363→                  />\n   364→                </td>\n   365→              </tr>\n   366→            )}\n   367→          </tbody>\n   368→        </table>\n   369→      </div>\n   370→\n   371→      <div className=\"mb-3\">\n   372→        <label className=\"form-label\" htmlFor=\"grading_method\">\n   373→          Grading method\n   374→        </label>\n   375→        <select\n   376→          className=\"form-select\"\n   377→          id=\"grading_method\"\n   378→          disabled={!canEdit}\n   379→          {...register('grading_method', {\n   380→            onChange: (e) => {\n   381→              if (e.target.value === 'External') {\n   382→                setValue('external_grading_enabled', true, { shouldDirty: true });\n   383→              }\n   384→            },\n   385→          })}\n   386→        >\n   387→          <option value=\"Internal\">Internal</option>\n   388→          <option value=\"External\">External</option>\n   389→          <option value=\"Manual\">Manual</option>\n   390→        </select>\n   391→        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n   392→      </div>\n   393→\n   394→      <div className=\"mb-3 form-check\">\n   395→        <input\n   396→          className=\"form-check-input\"\n   397→          type=\"checkbox\"\n   398→          id=\"single_variant\"\n   399→          disabled={!canEdit}\n   400→          {...register('single_variant')}\n   401→        />\n   402→        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n   403→          Single variant\n   404→        </label>\n   405→        <div className=\"small text-muted\">\n   406→          If enabled, students will only be able to try a single variant of this question on any\n   407→          given assessment.\n   408→        </div>\n   409→      </div>\n   410→\n   411→      <div className=\"mb-3 form-check\">\n   412→        <input\n   413→          className=\"form-check-input\"\n   414→          type=\"checkbox\"\n   415→          id=\"show_correct_answer\"\n   416→          disabled={!canEdit}\n   417→          {...register('show_correct_answer')}\n   418→        />\n   419→        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n   420→          Show correct answer\n   421→        </label>\n   422→        <div className=\"small text-muted\">\n   423→          If enabled, the correct answer panel will be shown after all submission attempts have been\n   424→          exhausted.\n   425→        </div>\n   426→      </div>\n   427→\n   428→      <div className=\"mb-3\">\n   429→        <div className=\"form-check\">\n   430→          <input\n   431→            className=\"form-check-input\"\n   432→            type=\"checkbox\"\n   433→            id=\"workspaceEnabled\"\n   434→            checked={workspaceEnabled}\n   435→            disabled={!canEdit}\n   436→            onChange={() => {\n   437→              if (workspaceEnabled) {\n   438→                clearErrors([\n   439→                  'workspace_image',\n   440→                  'workspace_port',\n   441→                  'workspace_home',\n   442→                  'workspace_environment',\n   443→                ]);\n   444→              }\n   445→              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n   446→            }}\n   447→          />\n   448→          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n   449→            Workspace\n   450→          </label>\n   451→        </div>\n   452→        <small className=\"text-muted ps-4\">\n   453→          Configure a{' '}\n   454→          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n   455→            remote development environment\n   456→          </a>{' '}\n   457→          for students.\n   458→        </small>\n   459→        {workspaceEnabled && (\n   460→          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n   461→            <div className=\"mb-3\">\n   462→              <label className=\"form-label\" htmlFor=\"workspace_image\">\n   463→                Image\n   464→              </label>\n   465→              <input\n   466→                type=\"text\"\n   467→                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n   468→                id=\"workspace_image\"\n   469→                disabled={!canEdit}\n   470→                aria-invalid={!!errors.workspace_image || undefined}\n   471→                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n   472→                {...register('workspace_image', {\n   473→                  required: 'Image is required for workspace',\n   474→                })}\n   475→              />\n   476→              {errors.workspace_image && (\n   477→                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n   478→                  {errors.workspace_image.message}\n   479→                </div>\n   480→              )}\n   481→              <small className=\"form-text text-muted\">\n   482→                The Docker image that will be used to serve this workspace. Only images from the\n   483→                Dockerhub registry are supported.\n   484→              </small>\n   485→            </div>\n   486→\n   487→            <div className=\"mb-3\">\n   488→              <label className=\"form-label\" htmlFor=\"workspace_port\">\n   489→                Port\n   490→              </label>\n   491→              <input\n   492→                type=\"number\"\n   493→                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n   494→                id=\"workspace_port\"\n   495→                disabled={!canEdit}\n   496→                aria-invalid={!!errors.workspace_port || undefined}\n   497→                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n   498→                // Disable default behavior of incrementing/decrementing the value when scrolling\n   499→                onWheel={(e) => e.currentTarget.blur()}\n   500→                {...register('workspace_port', {\n   501→                  required: 'Port is required for workspace',\n   502→                })}\n   503→              />\n   504→              {errors.workspace_port && (\n   505→                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n   506→                  {errors.workspace_port.message}\n   507→                </div>\n   508→              )}\n   509→              <small className=\"form-text text-muted\">\n   510→                The port number used in the Docker image.\n   511→              </small>\n   512→            </div>\n   513→\n   514→            <div className=\"mb-3\">\n   515→              <label className=\"form-label\" htmlFor=\"workspace_home\">\n   516→                Home\n   517→              </label>\n   518→              <input\n   519→                type=\"text\"\n   520→                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n   521→                id=\"workspace_home\"\n   522→                disabled={!canEdit}\n   523→                aria-invalid={!!errors.workspace_home || undefined}\n   524→                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n   525→                {...register('workspace_home', {\n   526→                  required: 'Home is required for workspace',\n   527→                })}\n   528→              />\n   529→              {errors.workspace_home && (\n   530→                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n   531→                  {errors.workspace_home.message}\n   532→                </div>\n   533→              )}\n   534→              <small className=\"form-text text-muted\">\n   535→                The home directory of the workspace container.\n   536→              </small>\n   537→            </div>\n   538→\n   539→            <div className=\"mb-3\">\n   540→              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n   541→                Graded files\n   542→              </label>\n   543→              <input\n   544→                type=\"text\"\n   545→                className=\"form-control\"\n   546→                id=\"workspace_graded_files\"\n   547→                disabled={!canEdit}\n   548→                {...register('workspace_graded_files')}\n   549→              />\n   550→              <small className=\"form-text text-muted\">\n   551→                The list of files or directories that will be copied out of the workspace container\n   552→                when saving a submission. You may enter multiple files or directories, separated by\n   553→                commas.\n   554→              </small>\n   555→            </div>\n   556→\n   557→            <div className=\"mb-3\">\n   558→              <label className=\"form-label\" htmlFor=\"workspace_args\">\n   559→                Arguments\n   560→              </label>\n   561→              <input\n   562→                type=\"text\"\n   563→                className=\"form-control\"\n   564→                id=\"workspace_args\"\n   565→                disabled={!canEdit}\n   566→                {...register('workspace_args')}\n   567→              />\n   568→              <small className=\"form-text text-muted\">\n   569→                Command line arguments to pass to the Docker container. Multiple arguments should be\n   570→                separated by spaces and escaped as necessary using the same format as a typical\n   571→                shell.\n   572→              </small>\n   573→            </div>\n   574→\n   575→            <div className=\"mb-3\">\n   576→              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n   577→                Environment\n   578→              </label>\n   579→              <textarea\n   580→                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n   581→                id=\"workspace_environment\"\n   582→                disabled={!canEdit}\n   583→                aria-invalid={!!errors.workspace_environment || undefined}\n   584→                aria-errormessage={\n   585→                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n   586→                }\n   587→                {...register('workspace_environment', {\n   588→                  validate: validateJson,\n   589→                })}\n   590→              />\n   591→              {errors.workspace_environment && (\n   592→                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n   593→                  {errors.workspace_environment.message}\n   594→                </div>\n   595→              )}\n   596→              <small className=\"form-text text-muted\">\n   597→                Environment variables to set inside the workspace container. Variables must be\n   598→                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n   599→              </small>\n   600→            </div>\n   601→\n   602→            <div className=\"mb-3 form-check\">\n   603→              <input\n   604→                className=\"form-check-input\"\n   605→                type=\"checkbox\"\n   606→                id=\"workspace_enable_networking\"\n   607→                disabled={!canEdit}\n   608→                {...register('workspace_enable_networking')}\n   609→              />\n   610→              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n   611→                Enable networking\n   612→              </label>\n   613→              <div className=\"small text-muted\">\n   614→                Whether the workspace should have network access. Access is disabled by default.\n   615→              </div>\n   616→            </div>\n   617→\n   618→            <div className=\"mb-3 form-check\">\n   619→              <input\n   620→                className=\"form-check-input\"\n   621→                type=\"checkbox\"\n   622→                id=\"workspace_rewrite_url\"\n   623→                disabled={!canEdit}\n   624→                {...register('workspace_rewrite_url')}\n   625→              />\n   626→              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n   627→                Rewrite URL\n   628→              </label>\n   629→              <div className=\"small text-muted\">\n   630→                If enabled, the URL will be rewritten such that the workspace container will see all\n   631→                requests as originating from \"/\".\n   632→              </div>\n   633→            </div>\n   634→          </div>\n   635→        )}\n   636→      </div>\n   637→\n   638→      <div className=\"mb-3\">\n   639→        {isExternalGrading ? (\n   640→          <h4 className=\"mb-0\">External grading</h4>\n   641→        ) : (\n   642→          <div className=\"form-check\">\n   643→            <input\n   644→              className=\"form-check-input\"\n   645→              type=\"checkbox\"\n   646→              id=\"externalGradingEnabled\"\n   647→              checked={externalGradingEnabled}\n   648→              disabled={!canEdit}\n   649→              onChange={() => {\n   650→                if (externalGradingEnabled) {\n   651→                  clearErrors(['external_grading_image', 'external_grading_environment']);\n   652→                }\n   653→                setValue('external_grading_enabled', !externalGradingEnabled, {\n   654→                  shouldDirty: true,\n   655→                });\n   656→              }}\n   657→            />\n   658→            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n   659→              External grading\n   660→            </label>\n   661→          </div>\n   662→        )}\n   663→        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n   664→          Configure{' '}\n   665→          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n   666→            grading using a Docker container\n   667→          </a>\n   668→          .\n   669→        </small>\n   670→        {(isExternalGrading || externalGradingEnabled) && (\n   671→          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n   672→            <div className=\"mb-3\">\n   673→              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n   674→                Image\n   675→              </label>\n   676→              <input\n   677→                type=\"text\"\n   678→                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n   679→                id=\"external_grading_image\"\n   680→                disabled={!canEdit}\n   681→                aria-invalid={!!errors.external_grading_image || undefined}\n   682→                aria-errormessage={\n   683→                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n   684→                }\n   685→                {...register('external_grading_image', {\n   686→                  required: externalGradingEnabled && 'Image is required for external grading',\n   687→                })}\n   688→              />\n   689→              {errors.external_grading_image && (\n   690→                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n   691→                  {errors.external_grading_image.message}\n   692→                </div>\n   693→              )}\n   694→              <small className=\"form-text text-muted\">\n   695→                The Docker image that will be used to grade this question. Only images from the\n   696→                Dockerhub registry are supported.\n   697→              </small>\n   698→            </div>\n   699→\n   700→            <div className=\"mb-3\">\n   701→              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n   702→                Entrypoint\n   703→              </label>\n   704→              <input\n   705→                type=\"text\"\n   706→                className=\"form-control\"\n   707→                id=\"external_grading_entrypoint\"\n   708→                disabled={!canEdit}\n   709→                {...register('external_grading_entrypoint')}\n   710→              />\n   711→              <small className=\"form-text text-muted\">\n   712→                Program or command to run as the entrypoint to your grader. If not provided, the\n   713→                default entrypoint for the image will be used.\n   714→              </small>\n   715→            </div>\n   716→\n   717→            <div className=\"mb-3\">\n   718→              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n   719→                Server files\n   720→              </label>\n   721→              <input\n   722→                type=\"text\"\n   723→                className=\"form-control\"\n   724→                id=\"external_grading_files\"\n   725→                disabled={!canEdit}\n   726→                {...register('external_grading_files')}\n   727→              />\n   728→              <small className=\"form-text text-muted\">\n   729→                The list of files or directories that will be copied from{' '}\n   730→                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n   731→                files or directories, separated by commas.\n   732→              </small>\n   733→            </div>\n   734→\n   735→            <div className=\"mb-3\">\n   736→              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n   737→                Timeout\n   738→              </label>\n   739→              <input\n   740→                type=\"number\"\n   741→                className=\"form-control\"\n   742→                id=\"external_grading_timeout\"\n   743→                min=\"0\"\n   744→                disabled={!canEdit}\n   745→                // Disable default behavior of incrementing/decrementing the value when scrolling\n   746→                onWheel={(e) => e.currentTarget.blur()}\n   747→                {...register('external_grading_timeout')}\n   748→              />\n   749→              <small className=\"form-text text-muted\">\n   750→                The number of seconds after which the grading job will timeout.\n   751→              </small>\n   752→            </div>\n   753→\n   754→            <div className=\"mb-3\">\n   755→              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n   756→                Environment\n   757→              </label>\n   758→              <textarea\n   759→                className={clsx(\n   760→                  'form-control',\n   761→                  errors.external_grading_environment && 'is-invalid',\n   762→                )}\n   763→                id=\"external_grading_environment\"\n   764→                disabled={!canEdit}\n   765→                aria-invalid={!!errors.external_grading_environment || undefined}\n   766→                aria-errormessage={\n   767→                  errors.external_grading_environment\n   768→                    ? 'external_grading_environment-error'\n   769→                    : undefined\n   770→                }\n   771→                {...register('external_grading_environment', {\n   772→                  validate: validateJson,\n   773→                })}\n   774→              />\n   775→              {errors.external_grading_environment && (\n   776→                <div id=\"external_grading_environment-error\" className=\"invalid-feedback\">\n   777→                  {errors.external_grading_environment.message}\n   778→                </div>\n   779→              )}\n   780→              <small className=\"form-text text-muted\">\n   781→                Environment variables to set inside the grading container. Variables must be\n   782→                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n   783→              </small>\n   784→            </div>\n   785→\n   786→            <div className=\"mb-3 form-check\">\n   787→              <input\n   788→                className=\"form-check-input\"\n   789→                type=\"checkbox\"\n   790→                id=\"external_grading_enable_networking\"\n   791→                disabled={!canEdit}\n   792→                {...register('external_grading_enable_networking')}\n   793→              />\n   794→              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n   795→                Enable networking\n   796→              </label>\n   797→              <div className=\"small text-muted\">\n   798→                Whether the grading containers should have network access. Access is disabled by\n   799→                default.\n   800→              </div>\n   801→            </div>\n   802→          </div>\n   803→        )}\n   804→      </div>\n   805→\n   806→      {canEdit && (\n   807→        <>\n   808→          <button\n   809→            id=\"save-button\"\n   810→            type=\"submit\"\n   811→            className=\"btn btn-primary mb-2\"\n   812→            name=\"__action\"\n   813→            value=\"update_question\"\n   814→            disabled={!isDirty}\n   815→          >\n   816→            Save\n   817→          </button>\n   818→          <button\n   819→            type=\"button\"\n   820→            className=\"btn btn-secondary mb-2 ms-2\"\n   821→            onClick={() => window.location.reload()}\n   822→          >\n   823→            Cancel\n   824→          </button>\n   825→        </>\n   826→      )}\n   827→    </form>\n   828→  );\n   829→};\n   830→\n   831→QuestionSettingsForm.displayName = 'QuestionSettingsForm';\n   832→"}]},"uuid":"0b62b179-9bb7-4039-96df-a5c946543d73","timestamp":"2026-02-12T17:11:21.807Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","content":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_environment || undefined}\n                aria-errormessage={\n                  errors.external_grading_environment\n                    ? 'external_grading_environment-error'\n                    : undefined\n                }\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div id=\"external_grading_environment-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","numLines":832,"startLine":1,"totalLines":832}},"sourceToolAssistantUUID":"f49179e3-67b7-402a-b219-c3ddca39bbf9"}
{"parentUuid":"0b62b179-9bb7-4039-96df-a5c946543d73","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01MgtNwk78n8mibCu8WDUQst","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me understand the issue. The `external_grading_enabled` field is a boolean that can be set in the `info.json` file as `externalGradingOptions.enabled`. \n\nLooking at the backend handler (line 279-283):\n```typescript\nenabled: propertyValueWithDefault(\n  questionInfo.externalGradingOptions?.enabled,\n  body.external_grading_enabled,\n  false,\n),\n```\n\nThe `BooleanFromCheckboxSchema` converts checkbox values: if the checkbox is checked, it returns `true`; if unchecked (not submitted in the form), it returns `false`.\n\n\nThe real issue is that `propertyValueWithDefault` prioritizes the form submission over the JSON configuration, so even if the JSON explicitly sets `enabled: true` or `false`, the checkbox value will override it. This means there's no way to preserve the original JSON setting when the form is submitted with a different checkbox state.","signature":"Eu4KCkYICxgCKkA1MeQ9ks9jdhxp0+/jIDqrSQPkrERwjMmk33llxdTIzdq+SfzUoRHw/+R+PRvDMTuhs87wxlttM1C9LiN5yN7xEgxtYTAsx0dGeGxJMWYaDH5zXOYhe/WlJBCN3CIw0C20grafSGoxac2BJC1+627dy6FZBhVykJrlXtSMInkIug0pW65KjM1D1UCewvjNKtUJS5/hUeV02v1GsUm++Rek/90uCJWmLk18js6FrOGMm8QKjUYOZaA1q6CCaBvcDihniaVx0tLSjfeNfwicmITRGRRoY2JFKO6LbbP+piv9SZv1Ee+qh47Ec9afolMdNlYspGDB9gmRtswpPkG9jMSDIerb4CNgkuhKBympDcVG0ZxnGA5dxipZhbHjAJIWbK3h68qnu3dgrvBt4WuaZtfZlbA2pGnJLm9y8dLFcNc/JBQnXQ+hfYWf69zIHN4iKNEm92EiUNUAhXReF8Yno1R60xaCaXCYCrs393IHXD6fZyyHJ+aSHtgI8v2A40S0d1V+MfGPtYMulYyLu1hLgGU4ro46Ifnxp0fufIU08NpN9qqlX/YJ+PyLGrE5pF4TYE7ACI8Nok3fNNksRnV3G4KiBI98ki1VsF9vMhJkS8fnv/KCnJ7HwB1Ml1CsheCGslna9482XjQ3Rwf1BFVsowkD5vubUEq/utuuZUTQKfEzcZ0Pt3JyHgraBzWTXZw3JY30xxR4S1gvf9/p+LPJbIrVBtofoOFAkybnt2ytBhf1+CQxkXAY4UeFYi8ly0PeX9a80Nm5ql6DFbgBBY3XxQKuHfICtf4e5XaKYmRpvBgLOzYUkDNDZrIcyVxomK8D8I+OG9km+y9DasuJRCCgwvwCCqP8pmovTrwM03MnL0vphvCeP9jgz7z4Vwy8hICY/4c2RpZoV5s5dv3RCy2q8xyN1S5ZgT1dOH8Ahz2+TYoR2qdnc8L0LOTYyYIWbxL3n6HSxMBZzioqR02lXRQLtb7mumVZbTMb92gtZLCJHmHNcmokYrzH0Lvk7b1bm1Mc9CM1jOgELfCBKc6LILcpoZ1xiueyuBYus917r0yRikYv2GJ0Z2qATNUda4+mizSR2IPXSnszza9LNhaZCCOxzloJJUr+K4Pt//NbSfh5zcdwDOZJiTsfkYc0l9WAjieI0gZZX6BjR5Ocoad0eL4KUpesJA+722V61CT5xxtzxj0NC9QJAGhvb88wE2bxhaqz+CYfAoVYEG++YxHcsbngjeWq9KG5JHOXjEWKd/a2dCy1DPdMg+bLXoO7qqTJhzZ4IQT9g5Rbt70aGBlRjFP4AvRWDe5IpmasXHa+ckuDUJIJYFpT+5rFosK7nD+x/jhBJaMhbJPiufRgAegDlKivvaZ2/j2A9sqQFKtKvUTdkw29GXPTaX5vQFlJdMBtObQJpwvp2ZrQDmqlEOwu6J/CwA/8/ickMZrb0aE6rxeY4kEugRkPdv/VL3fkNO+VFHrm16X4VED0lcubE6rBIxNXpaY+9/DdZudFj44Lh9jrGHfXJRefXDRa1cJKRyJr+ty0RRngEqN4wgC/PAh2Gixi5C0t/KzLpiKBYWUuNEJMfQK2ZKsK1YsARd4hIlTGgZ+ATckl9uKxoJM12vbDpfArdg+ioi84o7V/jtudOiDzT+/wR/VCMkE8kQ2pV6bD+yK7viwG2xZLlBlejXvioQldJJNWh72vFYQ5uOGVQCXu7UezelDt1U/1xoMJ7fA6umXdaAyTP/LlFtmZAOS1NqGhSJuamcGbSlltQsh5cAkUS/i1LiUbGGpKjU4Sqzc5Pe9xt0xsJKMyMqs919pBzeIdvDH2Uuaxp21iRl8QGJaVfifcd2M+6pMAkBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":17594,"cache_read_input_tokens":45103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":17594},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YgCU78AkSBEqwq1NRr","type":"assistant","uuid":"c35ae2af-780c-4e2c-8cc4-2b233643e3e8","timestamp":"2026-02-12T17:11:31.921Z"}
{"parentUuid":"c35ae2af-780c-4e2c-8cc4-2b233643e3e8","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01MgtNwk78n8mibCu8WDUQst","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at `propertyValueWithDefault` and the schema for `enabled` to understand the full picture."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":17594,"cache_read_input_tokens":45103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":17594},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YgCU78AkSBEqwq1NRr","type":"assistant","uuid":"f924c469-d156-4e8e-9eeb-615d2032bd9c","timestamp":"2026-02-12T17:11:31.921Z"}
{"parentUuid":"f924c469-d156-4e8e-9eeb-615d2032bd9c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01MgtNwk78n8mibCu8WDUQst","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AocvZ3B6BVSZHNv2Qyp39m","name":"Grep","input":{"pattern":"propertyValueWithDefault","path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/lib/editorUtil.shared.ts","output_mode":"content","-A":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":17594,"cache_read_input_tokens":45103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":17594},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YgCU78AkSBEqwq1NRr","type":"assistant","uuid":"1924877e-9c61-4160-90e0-c26cc0605c23","timestamp":"2026-02-12T17:11:33.302Z"}
{"parentUuid":"1924877e-9c61-4160-90e0-c26cc0605c23","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01AocvZ3B6BVSZHNv2Qyp39m","toolUseID":"toolu_01AocvZ3B6BVSZHNv2Qyp39m","timestamp":"2026-02-12T17:11:33.566Z","uuid":"2128df05-e2e3-4342-892c-462baf87162e"}
{"parentUuid":"1924877e-9c61-4160-90e0-c26cc0605c23","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AocvZ3B6BVSZHNv2Qyp39m","type":"tool_result","content":"141:export function propertyValueWithDefault(existingValue: any, newValue: any, defaultValue: any) {\n142-  const isExistingDefault =\n143-    typeof defaultValue === 'function'\n144-      ? defaultValue(existingValue)\n145-      : existingValue === defaultValue;\n146-  const isNewDefault =\n147-    typeof defaultValue === 'function' ? defaultValue(newValue) : newValue === defaultValue;\n148-\n149-  if (existingValue === undefined) {\n150-    if (!isNewDefault) {\n151-      return newValue;\n152-    }\n153-    return undefined;\n154-  } else {\n155-    if (!isExistingDefault && isNewDefault) {\n156-      return undefined;\n157-    } else {\n158-      return newValue;\n159-    }\n160-  }\n161-}"}]},"uuid":"fe9c9973-74a6-42b2-ab5d-f741f9f3f8c8","timestamp":"2026-02-12T17:11:33.566Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"141:export function propertyValueWithDefault(existingValue: any, newValue: any, defaultValue: any) {\n142-  const isExistingDefault =\n143-    typeof defaultValue === 'function'\n144-      ? defaultValue(existingValue)\n145-      : existingValue === defaultValue;\n146-  const isNewDefault =\n147-    typeof defaultValue === 'function' ? defaultValue(newValue) : newValue === defaultValue;\n148-\n149-  if (existingValue === undefined) {\n150-    if (!isNewDefault) {\n151-      return newValue;\n152-    }\n153-    return undefined;\n154-  } else {\n155-    if (!isExistingDefault && isNewDefault) {\n156-      return undefined;\n157-    } else {\n158-      return newValue;\n159-    }\n160-  }\n161-}","numLines":21},"sourceToolAssistantUUID":"1924877e-9c61-4160-90e0-c26cc0605c23"}
{"parentUuid":"fe9c9973-74a6-42b2-ab5d-f741f9f3f8c8","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01MgtNwk78n8mibCu8WDUQst","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BAznxwy5vhf4tMx287xw3C","name":"Grep","input":{"pattern":"enabled","path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/schemas/infoQuestion.ts","output_mode":"content","-C":3}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":17594,"cache_read_input_tokens":45103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":17594},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YgCU78AkSBEqwq1NRr","type":"assistant","uuid":"0d5cfe7d-930a-4c3d-809b-ec3ce6cf270b","timestamp":"2026-02-12T17:11:34.426Z"}
{"parentUuid":"0d5cfe7d-930a-4c3d-809b-ec3ce6cf270b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01BAznxwy5vhf4tMx287xw3C","toolUseID":"toolu_01BAznxwy5vhf4tMx287xw3C","timestamp":"2026-02-12T17:11:34.667Z","uuid":"69a89a5b-55fd-4437-8955-1ef36d8ae468"}
{"parentUuid":"0d5cfe7d-930a-4c3d-809b-ec3ce6cf270b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BAznxwy5vhf4tMx287xw3C","type":"tool_result","content":"137-export const ExternalGradingOptionsJsonSchema = z\n138-  .object({\n139-    comment: CommentJsonSchema.optional(),\n140:    enabled: z\n141-      .boolean()\n142-      .describe(\n143:        '[DEPRECATED, DO NOT USE] Whether the external grader is currently enabled. Useful if it is breaking, for example.',\n144-      )\n145-      .optional(),\n146-    image: z"}]},"uuid":"fa2af40e-587e-4a64-94f5-2864adf4e3f6","timestamp":"2026-02-12T17:11:34.666Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"137-export const ExternalGradingOptionsJsonSchema = z\n138-  .object({\n139-    comment: CommentJsonSchema.optional(),\n140:    enabled: z\n141-      .boolean()\n142-      .describe(\n143:        '[DEPRECATED, DO NOT USE] Whether the external grader is currently enabled. Useful if it is breaking, for example.',\n144-      )\n145-      .optional(),\n146-    image: z","numLines":10},"sourceToolAssistantUUID":"0d5cfe7d-930a-4c3d-809b-ec3ce6cf270b"}
{"parentUuid":"fa2af40e-587e-4a64-94f5-2864adf4e3f6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01MgtNwk78n8mibCu8WDUQst","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01L58a1eWbY6KPvJ3s3qyMvd","name":"Grep","input":{"pattern":"external_grading_enabled","path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/sync/fromDisk/questions.ts","output_mode":"content","-C":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":17594,"cache_read_input_tokens":45103,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":17594},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YgCU78AkSBEqwq1NRr","type":"assistant","uuid":"02a9f79f-892a-4113-b34f-fc42e19374dc","timestamp":"2026-02-12T17:11:35.538Z"}
{"parentUuid":"02a9f79f-892a-4113-b34f-fc42e19374dc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01L58a1eWbY6KPvJ3s3qyMvd","toolUseID":"toolu_01L58a1eWbY6KPvJ3s3qyMvd","timestamp":"2026-02-12T17:11:35.778Z","uuid":"e5c72dde-ef6c-4b30-9c22-95d259044289"}
{"parentUuid":"02a9f79f-892a-4113-b34f-fc42e19374dc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L58a1eWbY6KPvJ3s3qyMvd","type":"tool_result","content":"48-    topic: q.topic,\n49-    grading_method: q.gradingMethod,\n50-    single_variant: q.singleVariant,\n51-    show_correct_answer: q.showCorrectAnswer,\n52-    comment: q.comment,\n53:    external_grading_enabled: externalGradingOptions.enabled,\n54-    external_grading_image: externalGradingOptions.image,\n55-    external_grading_files: externalGradingOptions.serverFilesCourse,\n56-    external_grading_entrypoint,\n57-    external_grading_timeout: externalGradingOptions.timeout,\n58-    external_grading_enable_networking: externalGradingOptions.enableNetworking,"}]},"uuid":"d1cfd457-f666-4ac1-ab61-8410cc032d92","timestamp":"2026-02-12T17:11:35.777Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"48-    topic: q.topic,\n49-    grading_method: q.gradingMethod,\n50-    single_variant: q.singleVariant,\n51-    show_correct_answer: q.showCorrectAnswer,\n52-    comment: q.comment,\n53:    external_grading_enabled: externalGradingOptions.enabled,\n54-    external_grading_image: externalGradingOptions.image,\n55-    external_grading_files: externalGradingOptions.serverFilesCourse,\n56-    external_grading_entrypoint,\n57-    external_grading_timeout: externalGradingOptions.timeout,\n58-    external_grading_enable_networking: externalGradingOptions.enableNetworking,","numLines":11},"sourceToolAssistantUUID":"02a9f79f-892a-4113-b34f-fc42e19374dc"}
{"parentUuid":"d1cfd457-f666-4ac1-ab61-8410cc032d92","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_012HdSiKg8JZnZTf5FcaA2Jk","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I understand the full picture. The `enabled` field in `externalGradingOptions` is deprecated - it's a legacy field that acts as a kill switch for external grading. The schema says `[DEPRECATED, DO NOT USE]`.\n\nThe current behavior:\n1. In the frontend form, `external_grading_enabled` is a checkbox that controls whether the external grading section is shown/hidden (and whether external grading image is required).\n2. The form default is `external_grading_enabled: !!question.external_grading_image` - it derives from whether there's an image set, not from the actual `enabled` field in JSON.\n\n\n3. On the backend, the posted `external_grading_enabled` value gets written to `externalGradingOptions.enabled` via `propertyValueWithDefault`.\n\nThe real issue is that the form doesn't account for the deprecated `enabled` field at all - if someone explicitly set `\"enabled\": false` as a kill switch, the form would ignore that and potentially override it based on the checkbox state.\n\nLooking at how `propertyValueWithDefault` actually works with a default of `false`: when the JSON has `enabled: true` and the form posts `false`, it returns `undefined` (removing the field), but when the JSON is undefined and the form posts `true`, it adds the field back. This creates an asymmetry where the form can't properly preserve the original state of a deprecated field that defaults to `true` in the sync logic.\n\nThe core question is whether the frontend should even be posting this value at all, or if it should conditionally handle it based on whether it was originally present in the configuration.\n\nI think the backend should just preserve whatever `enabled` value exists in the JSON and ignore the form's `external_grading_enabled` checkbox for this field entirely. The checkbox is really about controlling visibility and configuration of the external grading section, not about toggling a deprecated kill switch. So the backend logic should check if `enabled` already exists in the JSON and keep it as-is, rather than letting the form overwrite it.","signature":"EscbCkYICxgCKkDMIMA/MI/hUr9Rb7G8JZpmJIL63ptn5udB1VvdMk+oPkJ4cDRaJjaWmVWFVa52pVpnXmFH+cw4ktCf82PCELRLEgxaNOQn5xLkIwfLVZMaDKoSkKwLniImisAmYiIwHc1ECS+yR+GUVGYcA+/+fMO7m7zRYzRudAM2dNQvqmwdI5rZZWom+s1wjXWUnxP6Kq4aKkPsW0u+bE69evzbgomBUiskgo7Mq3FumIqbTNrYwR070FVzGwaGaLPDs3Fteye63AJaaKNeOkTyf3BnFWm9OuhwJ4P2XEA1wiVu9ia6ZcPwucJORRg6xE1vPvn6i2JiiJ0PTsGNBxrCF1/MtVxQ+tr+Q+T8RNGA3oBnS4AzrFV7e7njPgsjsPYBiWBnGFtMHvUrdR3EW+eNmfi5lvcMOvLDbLzFzRsi8+K7xEZNHN8Pe/hYeKhabjKZGIGlE7QAsiQTNSZggA7dnlvl7rusNm0Dciny8mX7T1PE5Dj6vqEfUP64lfWT77+9KYqPlQe95QTPaQLMh2kDUqPSkOWPE1Y3tk6xeeCiPFdQ2b+83e4x1aVYPDGEldKhgaT/HSuJV8ytFEd9Aj743FRvADleEQGOaLDcu5rxchbLDBv2YEe3kqpeItvlda9YU86upImaYENfQIcNeR5SuLlLzUiQaUFw1PVjDNSaVb0JzctGuSnXNMY8tTTqZ1LYCtWtBjwBAEtMm3ZXw5fdQmIFyEv8GSuuHB2AVfMe3+B0ehMwkIBlJdYh3tlZk0mCdiW4n/Tdetopke/kWZT3fF3fwbYxfPvUoIHOQ22r0gWSspIpjlK0jX81wC06i35qRVMiiaNGk81+luy15uB4JKksqmngKZa6in3YdInBPj2uARCyoaPO/iRKUw+6B9BcoBeEO7ZQuQuOmg258MWfwW177xVL5fg4ittFBSE/TPboKQTYmkZhtOe1ORdUSCdrQiM8uqPEjuVjYvx52IOPjB2W9kmgVrMWc7pWbuTr4CTt6enMSCuWqtuStPqzJrU8uMAx9DpsS7U8xGYhAw8RdqLJNMkq6A5qNX63OrVAfweMpAQm1lZrxvP8JUAg2SLkddyXYwTmQIvqZyZ5Kh+ezLj1ptzSa0Ezf/gyHpmb2HYFhHf2IgCbP/z5nYxkV1fyx4AiTYrrjDCQLMHh59LhVwW6XRRGhbpE3/+VR0rprJ8i80lFWFvg6arwcFPpIiQd7pYH8dfkLZGHKPW1yAAEYr+890NPV6E+ybeSGMiflM9jO8lfB9yIWCIPusfUbsHksWy1mJ6Az53Al7tzM46CelDu0X2eDDU7kWUvPWQyd5HQKWdlvQWqJl65+Rd5zJ1LRB3u9cixlpyeBsAu8fb8qTpEq7Q+MM1cEea2UIAhpDmzdoaqZU4huolxmjRwZRclhjmgqc7uxiChHfy5n3JdZ/W/VbH1QGUYmQ6hAnNSGJ4eQG+octmArN3iZkOdWhBZBIqsMf21/yqebb+aO9l5w1o1JGLHKjQEYBtjN9Z3aEMFAkmk99G2T9rDA6bKO3Sey/Gu3oWhFbuyIQUnv7dibOuCBoEsqr5iQWIArXX8zsLiG2fyQN/TB6zdyFcRGxVQVE1cU2icB6+oh4IGrpQtIqrLUAgqrXvA6xOKhKwI00pkK3HteuMEoBsM747TX5/13WK19p5g/dixboD5FVyzyH4z5j9/h4e57+mn3QwMVL0O+kcCREqnoHPK0/NzIwWiBt0uV3e4ldwTQEEj1PkcreRjntOKr9UoI1iivk1Uissl0m45yI7MGx0u299jSYJXg6oc9VL2XpSPwgltlLm2lUACR10Z/sB+9Dcb154IL+OyvgOb/ZWeCqXbgXcwRYb8tMPenVqeCZ14jRvvMKhNQ34X6OVu+XYcgJH3cdgUmMi5rgJT3ivrV9uPlpMmkrsqKcQDAQXQEySYh4lEsQY1+Lc9oHUBH134aelSM8Y3zAeUu6rl6jgAhVjMFToq45ZY/vO/46ksaw3G8WYLCWwZlDDPSrdiy1sGeBI9hEW0feC27gOWidhyF7GE4DymJlulQGA5M4XzaAjHBeAPOweQ+nGmehDam0lcYnixa2YLL2MyMhejUNVwyeO2TnwpM1nBdiS3Mw4dT27TceJta1Xci0Vi0EaLzsZf7v0WF7SDCpvFebfx26MipPwT9d8fnQFLwUQEptXSaJfjgMoFL6sDa6AbDfN4C9lET4r/m6fidlfybq+Qs7dv9GHdkv4rrcIAtit5NR/Mp3/0nLyIcULmM/XPJb/cBhtddASIP6Uaw6Na/8zg7aH20JH/rxK+0giDGFP7WQMEHIGolGtaPBTlN4c8qD4P33Jzh2ys5VXvHE5XI5qPH+oLS+swAfVL8uFG0hlvYuqzPnLdfQRoT6burRqbtNkHeduAwbf36GowTN4M71uEFo+OU6ZlZcd4Eeoe1R3JYFyjtciPv57ZdBTSj2vS0k3qFjnOrPVPNFbJ4G0TDdl4zeTXAFpsnpcAmi09SR5K8ZS/OIuo2WcC6dWr5WL1ta8VWy6Koy+McpUPe/sJCvwfsyNSPCaOQsKXh+7KtUnHr5JxSepuoGjoSDGWmNl8ZOg4bRJNO/+ggtsLOqCFXBzp4LQs1zwwV1JUmaJKOVVr8ZO4SVYJTrsdFarKJr/X3JBsQVqc1j4GAvcNag6P9Pljh8+WCPFZHGlWPg2/7J61gfVqRyfiPaWBBrtGWbqTCBSED+3UiC2Md7QWV3fWrbm5qgSBsObPByXeMTj5BvGUuCGhhZrFt5TTeKeXg3tSX/JGPjVNlIn5ziESFqM+5Wmfhw7hK5fElyjm41aLKH0S0b6QW/4Nv3rP/Nl11Twwx4bpH7apFPhaUHoOU3dd5dq0HtF0slFDrHnJVO/j3MMJq8WjVR5i27bPy99nDa1CVkbcC1a5cSQuk44OR0NZptmGSUMUry8Mquw4rvL9xAAbPpzOcE36VtOl+RMM+nFqKiJCzLdqwRPiY157XYlnEYCyQFgvy4+qRwjsHhs01gSCJiPeciLHmY4b7U4DsytThXmhx41kWAl38W1wVLxCGAZkYK1bwYdDRZPsbU7dGmboLsPteNwUBk3f8qj4KCp2fMGvLhlbvUSb/MRZd92uNRZfASUsFlyXA8P7jDyPZ+gfvj3ZIaiXmgYfO46OcMdlISlzSdiLks+dbPKOzEFwwWWibSGuuNyXg0Z266acDI3creclfOaCycVOPo4C2jvo51J8T+bjzhX8T7+s4VwoA8QByxev0VoBl2I6oBlreLL0TyghYtrWCNZ3GwZThRANFPK/RoDd9zgJgChfhMjfQdZ1sZomO6dlamado80hsgK+P53LwKuaZC/AXOD8wlyS8q8GXkL+6arGBsHkCunb1nzvKEd+uwOi2jd9lEUH/FlVfVPRZPBiynHWYudwPb98T/LqjQ4WX1W0KcIMP3lOFAk09NqiUmpHHCxpyi9j9x7u//tWOWE5h8Q37GtlyBFu4f21YuhpkBL7QLjHJARk9QVCVdgE2aTP0Kh4//RKGHU+3u+ksCQtM/qxaua0aOaM+NJe7zV9Lhq6+fanOcIANTmxvuzddNSY6tEIrl/IK1F7ZS+QVWg1yvgDeg++4uSALaJZR9hA4hFPwD9U9z+QiIh7o7QQL1N4Uz7QBosq7jgPap8CAUKG4dVigkxWnDlheHZ/R9nsIyTET1gWfEX3w1c3qPFiDRaVog7TIJwLc0SK50XXngXaTQger3TbXofwuIVPSUxt6ihonugkon8z+Hc8JKBq9dPqyHL58X6LewqMurOttTkkj+NDi/AdaZEhdgIUPt706wVbwJjWpKfH3WNCIVM0Dn6+UgFDwLZGijjs0UNxyeU41nORfaAlClWvLnpCl6sjRq0EjbsCl95oDciAwfU0ADTE1NZAzd3JH4wygCOwsAZlIo+o4ZHsCt9O75DYTMYJQbXnOPczlvImGyrg3piJhkuTZjFfUjdKvBUg3p/B5AkXStjOGte4hvcHaeGMwYlPJBlaQyiO7bJOEg+fZQv8qjHe7QcS0hEjiwsVdDJ+6V285D8Q2ElYC2qfRaj35YiiM6P3nzVpyGEaxuesftl/B39HJh66gWKoA1duiY8aYZLwo815fBt9xmOD17LJk8KPHt0R05AO+Zm6RSRNRCfVYHBXzGegSKD2ENWLXqEgzzbW9gxtLDtSNamb/U+SpQbqD4L3lQbBPmS+g9gyEX5zcG++0mu1q/p/kCli4wiK9WX2ORc8xEkhEQ0hCOhCWr8oHLZdELHoQ48sFHpgH3Kji9h3JcvqOS1MKEm/oacRUf/4QTjwsTLgRmC3eSbamSrLnsoDkNVhEqJUkv/R8PDjckNpvF9Qx1SDz22aboFUSCDoL+R0ESLiILtBCUtlqU+24ngdmlP8Zgo6E37yg549ksSw4sd428CZ9anHHNzj8LKEJaByaHLklpsraBnftt4hQi7n/XBazyrYWJ4voVx6T+rEqcc6Das8G5QKcU9bMwmAiz/JExoQ0htdxbJ++jbpigUNmm+zJ+/ZA/PQBIIoBnJHvjGUPHEHYczN6BP7012h5+nRxaUExzTl7fKymxK8GrJenWMoKtEoey9GRI/tSIRaGH6QrDUK0PbSb6nBuw9IX72COX+OcixrDXmSiOTYzUHOcsKLucWPsXxg/T3RSXOaK8y/byiX/2yFG7NHSople99G7OxCHdQSFcMYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1448,"cache_read_input_tokens":62697,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1448},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YhEsVxWQNYzjN9AUaB","type":"assistant","uuid":"a744e90e-f9d5-4de8-89c2-4fd18a63e836","timestamp":"2026-02-12T17:11:55.375Z"}
{"parentUuid":"a744e90e-f9d5-4de8-89c2-4fd18a63e836","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_012HdSiKg8JZnZTf5FcaA2Jk","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have the full picture. The key insight is that `externalGradingOptions.enabled` is a **deprecated** field (per the schema: `[DEPRECATED, DO NOT USE]`). The form's `external_grading_enabled` checkbox is really a UI toggle for \"show/hide external grading options\", not the deprecated kill switch.\n\nThe easiest fix is on the **backend** — just preserve whatever value was already in the JSON for `enabled`, and don't let the form checkbox overwrite it:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1448,"cache_read_input_tokens":62697,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1448},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YhEsVxWQNYzjN9AUaB","type":"assistant","uuid":"efb2dcc2-18b9-4938-a5e7-35e8f84d7c1b","timestamp":"2026-02-12T17:11:57.112Z"}
{"parentUuid":"efb2dcc2-18b9-4938-a5e7-35e8f84d7c1b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_012HdSiKg8JZnZTf5FcaA2Jk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0139t5kR1ssz3S9TS3dSVJYC","name":"Read","input":{"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","offset":277,"limit":8}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1448,"cache_read_input_tokens":62697,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1448},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YhEsVxWQNYzjN9AUaB","type":"assistant","uuid":"d6842ec2-9e7d-4255-899e-fb415c46b957","timestamp":"2026-02-12T17:11:58.295Z"}
{"parentUuid":"d6842ec2-9e7d-4255-899e-fb415c46b957","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_0139t5kR1ssz3S9TS3dSVJYC","toolUseID":"toolu_0139t5kR1ssz3S9TS3dSVJYC","timestamp":"2026-02-12T17:11:58.298Z","uuid":"a754e996-361b-4f1a-b7f6-3a7517a33db4"}
{"parentUuid":"d6842ec2-9e7d-4255-899e-fb415c46b957","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0139t5kR1ssz3S9TS3dSVJYC","type":"tool_result","content":"   277→      const externalGradingOptions = {\n   278→        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n   279→        enabled: propertyValueWithDefault(\n   280→          questionInfo.externalGradingOptions?.enabled,\n   281→          body.external_grading_enabled,\n   282→          false,\n   283→        ),\n   284→        image: propertyValueWithDefault("}]},"uuid":"07909944-f6a6-4637-90d9-31ddcfa0b096","timestamp":"2026-02-12T17:11:58.298Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","content":"      const externalGradingOptions = {\n        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n        enabled: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enabled,\n          body.external_grading_enabled,\n          false,\n        ),\n        image: propertyValueWithDefault(","numLines":8,"startLine":277,"totalLines":521}},"sourceToolAssistantUUID":"d6842ec2-9e7d-4255-899e-fb415c46b957"}
{"type":"file-history-snapshot","messageId":"6fe04e96-0fb4-46bc-b177-ab82e1b93dc3","snapshot":{"messageId":"15159e1f-6572-4492-b840-1ee473433deb","trackedFileBackups":{"apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts":{"backupFileName":"0f385395cad5cbb7@v1","version":1,"backupTime":"2026-02-12T17:12:02.111Z"}},"timestamp":"2026-02-12T17:11:10.859Z"},"isSnapshotUpdate":true}
{"parentUuid":"07909944-f6a6-4637-90d9-31ddcfa0b096","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_017RcQeRwPojJqaERTCZm9HB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01X6WaseKR4rZShwUNYgF682","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","old_string":"        enabled: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enabled,\n          body.external_grading_enabled,\n          false,\n        ),","new_string":"        enabled: questionInfo.externalGradingOptions?.enabled,"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1184,"cache_read_input_tokens":64145,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1184},"output_tokens":25,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YitBr33J8eKUZz9MPF","type":"assistant","uuid":"6fe04e96-0fb4-46bc-b177-ab82e1b93dc3","timestamp":"2026-02-12T17:12:02.107Z"}
{"parentUuid":"6fe04e96-0fb4-46bc-b177-ab82e1b93dc3","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01X6WaseKR4rZShwUNYgF682","toolUseID":"toolu_01X6WaseKR4rZShwUNYgF682","timestamp":"2026-02-12T17:12:02.115Z","uuid":"24a80ae1-50ed-48e4-9be1-cf2c04e82116"}
{"parentUuid":"24a80ae1-50ed-48e4-9be1-cf2c04e82116","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01X6WaseKR4rZShwUNYgF682","toolUseID":"toolu_01X6WaseKR4rZShwUNYgF682","timestamp":"2026-02-12T17:12:02.115Z","uuid":"454fcf65-273a-40ae-b9fa-da18cad00d9b"}
{"parentUuid":"6fe04e96-0fb4-46bc-b177-ab82e1b93dc3","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01X6WaseKR4rZShwUNYgF682","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts has been updated successfully."}]},"uuid":"7c877efe-39d1-4d4d-b90c-4e76863d79d9","timestamp":"2026-02-12T17:12:02.114Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","oldString":"        enabled: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enabled,\n          body.external_grading_enabled,\n          false,\n        ),","newString":"        enabled: questionInfo.externalGradingOptions?.enabled,","originalFile":"import * as path from 'path';\n\nimport { Router } from 'express';\nimport fs from 'fs-extra';\nimport * as shlex from 'shlex';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\nimport * as sqldb from '@prairielearn/postgres';\nimport { run } from '@prairielearn/run';\nimport {\n  ArrayFromStringOrArraySchema,\n  BooleanFromCheckboxSchema,\n  IntegerFromStringOrEmptySchema,\n} from '@prairielearn/zod';\n\nimport { b64EncodeUnicode } from '../../lib/base64-util.js';\nimport { copyQuestionBetweenCourses } from '../../lib/copy-content.js';\nimport { EnumGradingMethodSchema } from '../../lib/db-types.js';\nimport { propertyValueWithDefault } from '../../lib/editorUtil.shared.js';\nimport {\n  FileModifyEditor,\n  MultiEditor,\n  QuestionCopyEditor,\n  QuestionDeleteEditor,\n  QuestionRenameEditor,\n  getOriginalHash,\n} from '../../lib/editors.js';\nimport { features } from '../../lib/features/index.js';\nimport { courseRepoContentUrl } from '../../lib/github.js';\nimport { idsEqual } from '../../lib/id.js';\nimport { getPaths } from '../../lib/instructorFiles.js';\nimport { applyKeyOrder } from '../../lib/json.js';\nimport { formatJsonWithPrettier } from '../../lib/prettier.js';\nimport { startTestQuestion } from '../../lib/question-testing.js';\nimport { typedAsyncHandler } from '../../lib/res-locals.js';\nimport { validateShortName } from '../../lib/short-name.js';\nimport { getCanonicalHost } from '../../lib/url.js';\nimport { generateCsrfToken } from '../../middlewares/csrfToken.js';\nimport { selectCoursesWithEditAccess } from '../../models/course.js';\nimport { selectQuestionByUuid } from '../../models/question.js';\nimport { selectTagsByCourseId, selectTagsByQuestionId } from '../../models/tags.js';\nimport { selectTopicsByCourseId } from '../../models/topics.js';\n\nimport { InstructorQuestionSettings } from './instructorQuestionSettings.html.js';\nimport {\n  SelectedAssessmentsSchema,\n  type SharingSetRow,\n  SharingSetRowSchema,\n} from './instructorQuestionSettings.types.js';\n\nconst router = Router();\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\n// This will not correctly handle any filenames that have a comma in them.\n// Currently, we do not have any such filenames in prod so we don't think that\n// escaping commas in individual filenames is necessary.\nconst GradedFilesSchema = z\n  .string()\n  .transform((s) =>\n    s\n      .split(',')\n      .map((s) => s.trim())\n      .filter((s) => s !== ''),\n  )\n  .optional();\n\nconst ArgumentsSchema = z\n  .string()\n  .transform((s) => shlex.split(s || ''))\n  .optional();\n\nrouter.post(\n  '/test',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // We use a separate `test/` POST route so that we can always use the\n    // route to distinguish between pages that need to execute course code\n    // (this `test/` handler) and pages that need access to course content\n    // editing (here the plain '/' POST handler).\n    if (req.body.__action === 'test_once') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      const jobSequenceId = await startTestQuestion({\n        count: 1,\n        showDetails: true,\n        question: res.locals.question,\n        course_instance: res.locals.course_instance ?? null,\n        course: res.locals.course,\n        user_id: res.locals.user.id,\n        authn_user_id: res.locals.authn_user.id,\n        // Optional variant seed prefix for deterministic testing.\n        // Not exposed in UI - for internal use with automated testing scripts.\n        variantSeedPrefix: req.body.variant_seed_prefix,\n      });\n      res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n    } else if (req.body.__action === 'test_100') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      if (res.locals.question.grading_method !== 'External') {\n        const jobSequenceId = await startTestQuestion({\n          count: 100,\n          showDetails: false,\n          question: res.locals.question,\n          course_instance: res.locals.course_instance ?? null,\n          course: res.locals.course,\n          user_id: res.locals.user.id,\n          authn_user_id: res.locals.authn_user.id,\n          // Optional variant seed prefix for deterministic testing.\n          // Not exposed in UI - for internal use with automated testing scripts.\n          variantSeedPrefix: req.body.variant_seed_prefix,\n        });\n        res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n      } else {\n        throw new Error('Not supported for externally-graded questions');\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.post(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    if (req.body.__action === 'update_question') {\n      const infoPath = path.join(\n        res.locals.course.path,\n        'questions',\n        res.locals.question.qid!,\n        'info.json',\n      );\n      if (!(await fs.pathExists(infoPath))) {\n        throw new error.HttpStatusError(400, 'Question info file does not exist');\n      }\n\n      const body = z\n        .object({\n          orig_hash: z.string(),\n          qid: z.string(),\n          title: z.string(),\n          topic: z.string().optional(),\n          tags: ArrayFromStringOrArraySchema.optional(),\n          grading_method: EnumGradingMethodSchema.optional(),\n          single_variant: BooleanFromCheckboxSchema,\n          show_correct_answer: BooleanFromCheckboxSchema,\n          workspace_image: z.string().optional(),\n          workspace_port: IntegerFromStringOrEmptySchema.nullable().optional(),\n          workspace_home: z.string().optional(),\n          workspace_args: ArgumentsSchema,\n          workspace_rewrite_url: BooleanFromCheckboxSchema,\n          workspace_graded_files: GradedFilesSchema,\n          workspace_enable_networking: BooleanFromCheckboxSchema,\n          workspace_environment: z.string().optional(),\n          external_grading_enabled: BooleanFromCheckboxSchema,\n          external_grading_image: z.string().optional(),\n          external_grading_files: GradedFilesSchema,\n          external_grading_entrypoint: ArgumentsSchema,\n          external_grading_timeout: IntegerFromStringOrEmptySchema.optional(),\n          external_grading_enable_networking: BooleanFromCheckboxSchema,\n          external_grading_environment: z.string().optional(),\n        })\n        .parse(req.body);\n\n      const shortNameValidation = validateShortName(body.qid, res.locals.question.qid ?? undefined);\n      if (!shortNameValidation.valid) {\n        throw new error.HttpStatusError(\n          400,\n          `Invalid QID: ${shortNameValidation.lowercaseMessage}`,\n        );\n      }\n\n      const paths = getPaths(undefined, res.locals);\n\n      const questionInfo = JSON.parse(await fs.readFile(infoPath, 'utf8'));\n\n      const origHash = body.orig_hash;\n      questionInfo.title = body.title;\n      questionInfo.topic = body.topic;\n      questionInfo.tags = propertyValueWithDefault(\n        questionInfo.tags,\n        body.tags,\n        (val: any) => !val || val.length === 0,\n      );\n\n      questionInfo.gradingMethod = propertyValueWithDefault(\n        questionInfo.gradingMethod,\n        body.grading_method,\n        'Internal',\n      );\n\n      questionInfo.singleVariant = propertyValueWithDefault(\n        questionInfo.singleVariant,\n        body.single_variant,\n        false,\n      );\n\n      questionInfo.showCorrectAnswer = propertyValueWithDefault(\n        questionInfo.showCorrectAnswer,\n        body.show_correct_answer,\n        true,\n      );\n\n      const workspaceOptions = {\n        comment: questionInfo.workspaceOptions?.comment ?? undefined,\n        image: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.image,\n          body.workspace_image?.trim(),\n          '',\n        ),\n        port: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.port,\n          body.workspace_port,\n          null,\n        ),\n        home: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.home,\n          body.workspace_home?.trim(),\n          '',\n        ),\n        args: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.args,\n          body.workspace_args,\n          (v: any) => !v || v.length === 0,\n        ),\n        rewriteUrl: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.rewriteUrl,\n          body.workspace_rewrite_url,\n          true,\n        ),\n        gradedFiles: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.gradedFiles,\n          body.workspace_graded_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.enableNetworking,\n          body.workspace_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.environment,\n          JSON.parse(body.workspace_environment?.replaceAll('\\r\\n', '\\n') || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n\n      // We'll only write the workspace options if the request contains the\n      // required fields. Client-side validation will ensure that these are\n      // present if a workspace is configured.\n      if (workspaceOptions.image && workspaceOptions.port && workspaceOptions.home) {\n        const filteredOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.workspaceOptions,\n              workspaceOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n        questionInfo.workspaceOptions =\n          Object.keys(filteredOptions).length > 0\n            ? applyKeyOrder(questionInfo.workspaceOptions, filteredOptions)\n            : undefined;\n      } else {\n        questionInfo.workspaceOptions = undefined;\n      }\n\n      const externalGradingOptions = {\n        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n        enabled: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enabled,\n          body.external_grading_enabled,\n          false,\n        ),\n        image: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.image,\n          body.external_grading_image,\n          '',\n        ),\n        entrypoint: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.entrypoint,\n          body.external_grading_entrypoint,\n          (v: any) => v == null || v.length === 0,\n        ),\n        serverFilesCourse: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.serverFilesCourse,\n          body.external_grading_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        timeout: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.timeout,\n          body.external_grading_timeout,\n          null,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enableNetworking,\n          body.external_grading_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.environment,\n          JSON.parse(body.external_grading_environment || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n      if (externalGradingOptions.image) {\n        const filteredExternalGradingOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.externalGradingOptions,\n              externalGradingOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n\n        questionInfo.externalGradingOptions =\n          Object.keys(filteredExternalGradingOptions).length > 0\n            ? applyKeyOrder(questionInfo.externalGradingOptions, filteredExternalGradingOptions)\n            : undefined;\n      } else {\n        questionInfo.externalGradingOptions = undefined;\n      }\n\n      const formattedJson = await formatJsonWithPrettier(JSON.stringify(questionInfo));\n\n      const qid_new = run(() => {\n        try {\n          return path.normalize(req.body.qid);\n        } catch {\n          throw new error.HttpStatusError(\n            400,\n            `Invalid QID (could not be normalized): ${req.body.qid}`,\n          );\n        }\n      });\n\n      const editor = new MultiEditor(\n        {\n          locals: res.locals,\n          // This won't reflect if the operation is an update or a rename; we think that's OK.\n          description: `Update question ${res.locals.question.qid}`,\n        },\n        [\n          // Each of these editors will no-op if there wasn't any change.\n          new FileModifyEditor({\n            locals: res.locals,\n            container: {\n              rootPath: paths.rootPath,\n              invalidRootPaths: paths.invalidRootPaths,\n            },\n            filePath: path.join(paths.rootPath, 'info.json'),\n            editContents: b64EncodeUnicode(formattedJson),\n            origHash,\n          }),\n          new QuestionRenameEditor({\n            locals: res.locals,\n            qid_new,\n          }),\n        ],\n      );\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n\n      flash('success', 'Question settings updated successfully');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'copy_question') {\n      if (idsEqual(req.body.to_course_id, res.locals.course.id)) {\n        // In this case, we are making a duplicate of this question in the same course\n        const editor = new QuestionCopyEditor({\n          locals: res.locals,\n          from_qid: res.locals.question.qid!,\n          from_course: res.locals.course,\n          from_path: path.join(res.locals.course.path, 'questions', res.locals.question.qid!),\n          is_transfer: false,\n        });\n        const serverJob = await editor.prepareServerJob();\n        try {\n          await editor.executeWithServerJob(serverJob);\n        } catch {\n          return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n        }\n\n        const question = await selectQuestionByUuid({\n          course_id: res.locals.course.id,\n          uuid: editor.uuid,\n        });\n\n        flash(\n          'success',\n          'Question copied successfully. You are now viewing your copy of the question.',\n        );\n        res.redirect(res.locals.urlPrefix + '/question/' + question.id + '/settings');\n      } else {\n        await copyQuestionBetweenCourses(res, {\n          fromCourse: res.locals.course,\n          toCourseId: req.body.to_course_id,\n          question: res.locals.question,\n        });\n      }\n    } else if (req.body.__action === 'delete_question') {\n      const editor = new QuestionDeleteEditor({\n        locals: res.locals,\n        questions: res.locals.question,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n        res.redirect(res.locals.urlPrefix + '/course_admin/questions');\n      } catch {\n        res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.get(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // Construct the path of the question test route. We'll do this based on\n    // `originalUrl` so that this router doesn't have to be aware of where it's\n    // mounted.\n    const host = getCanonicalHost(req);\n    let questionTestPath = new URL(req.originalUrl, host).pathname;\n    if (!questionTestPath.endsWith('/')) {\n      questionTestPath += '/';\n    }\n    questionTestPath += 'test';\n\n    // Generate a CSRF token for the test route. We can't use `res.locals.__csrf_token`\n    // here because this form will actually post to a different route, not `req.originalUrl`.\n    const questionTestCsrfToken = generateCsrfToken({\n      url: questionTestPath,\n      authnUserId: res.locals.authn_user.id,\n    });\n\n    const questionGHLink = courseRepoContentUrl(\n      res.locals.course,\n      `questions/${res.locals.question.qid}`,\n    );\n\n    const qids = await sqldb.queryRows(sql.qids, { course_id: res.locals.course.id }, z.string());\n\n    const assessmentsWithQuestion = await sqldb.queryRows(\n      sql.select_assessments_with_question_for_display,\n      { question_id: res.locals.question.id },\n      SelectedAssessmentsSchema,\n    );\n\n    const courseTopics = await selectTopicsByCourseId(res.locals.course.id);\n    const courseTags = await selectTagsByCourseId(res.locals.course.id);\n    const questionTags = await selectTagsByQuestionId(res.locals.question.id);\n\n    const sharingEnabled = await features.enabledFromLocals('question-sharing', res.locals);\n\n    let sharingSetsIn: SharingSetRow[] | undefined;\n    if (sharingEnabled) {\n      const result = await sqldb.queryRows(\n        sql.select_sharing_sets,\n        {\n          question_id: res.locals.question.id,\n          course_id: res.locals.course.id,\n        },\n        SharingSetRowSchema,\n      );\n      sharingSetsIn = result.filter((row) => row.in_set);\n    }\n    const editableCourses = await selectCoursesWithEditAccess({\n      user_id: res.locals.user.id,\n      is_administrator: res.locals.is_administrator,\n    });\n    const infoPath = path.join('questions', res.locals.question.qid!, 'info.json');\n    const fullInfoPath = path.join(res.locals.course.path, infoPath);\n\n    const origHash = (await getOriginalHash(fullInfoPath)) ?? '';\n\n    const canEdit =\n      res.locals.authz_data.has_course_permission_edit && !res.locals.course.example_course;\n\n    res.send(\n      InstructorQuestionSettings({\n        resLocals: res.locals,\n        questionTestPath,\n        questionTestCsrfToken,\n        questionGHLink,\n        questionTags,\n        qids,\n        assessmentsWithQuestion,\n        sharingEnabled,\n        sharingSetsIn,\n        editableCourses,\n        infoPath,\n        origHash,\n        canEdit,\n        courseTopics,\n        courseTags,\n      }),\n    );\n  }),\n);\n\nexport default router;\n","structuredPatch":[{"oldStart":276,"oldLines":11,"newStart":276,"newLines":7,"lines":[" ","       const externalGradingOptions = {","         comment: questionInfo.externalGradingOptions?.comment ?? undefined,","-        enabled: propertyValueWithDefault(","-          questionInfo.externalGradingOptions?.enabled,","-          body.external_grading_enabled,","-          false,","-        ),","+        enabled: questionInfo.externalGradingOptions?.enabled,","         image: propertyValueWithDefault(","           questionInfo.externalGradingOptions?.image,","           body.external_grading_image,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6fe04e96-0fb4-46bc-b177-ab82e1b93dc3"}
{"parentUuid":"7c877efe-39d1-4d4d-b90c-4e76863d79d9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01ChA64Z8oPypufvuSdVCZRz","type":"message","role":"assistant","content":[{"type":"text","text":"Now the form no longer needs to post `external_grading_enabled` at all — we can remove it from the body schema too:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":257,"cache_read_input_tokens":65329,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":257},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YjBsEEXTRLZz1dZguy","type":"assistant","uuid":"3aebe359-419f-49e4-97bb-b7a1fdc857a2","timestamp":"2026-02-12T17:12:05.743Z"}
{"parentUuid":"3aebe359-419f-49e4-97bb-b7a1fdc857a2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01ChA64Z8oPypufvuSdVCZRz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","old_string":"          external_grading_enabled: BooleanFromCheckboxSchema,\n          external_grading_image: z.string().optional(),","new_string":"          external_grading_image: z.string().optional(),"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":257,"cache_read_input_tokens":65329,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":257},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YjBsEEXTRLZz1dZguy","type":"assistant","uuid":"a0acf742-9308-450f-bcf6-5587a41c1fba","timestamp":"2026-02-12T17:12:07.114Z"}
{"parentUuid":"a0acf742-9308-450f-bcf6-5587a41c1fba","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","toolUseID":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","timestamp":"2026-02-12T17:12:07.118Z","uuid":"c481d917-9f95-42df-858b-d22834618652"}
{"parentUuid":"c481d917-9f95-42df-858b-d22834618652","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","toolUseID":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","timestamp":"2026-02-12T17:12:07.118Z","uuid":"87dae687-5194-48e3-bd75-71c81343bfb1"}
{"parentUuid":"a0acf742-9308-450f-bcf6-5587a41c1fba","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CrCCXP6Bq4Z9piNQ2p2Hbe","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts has been updated successfully."}]},"uuid":"bff43365-6159-4a77-84fb-0a555594ccf2","timestamp":"2026-02-12T17:12:07.118Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","oldString":"          external_grading_enabled: BooleanFromCheckboxSchema,\n          external_grading_image: z.string().optional(),","newString":"          external_grading_image: z.string().optional(),","originalFile":"import * as path from 'path';\n\nimport { Router } from 'express';\nimport fs from 'fs-extra';\nimport * as shlex from 'shlex';\nimport { z } from 'zod';\n\nimport * as error from '@prairielearn/error';\nimport { flash } from '@prairielearn/flash';\nimport * as sqldb from '@prairielearn/postgres';\nimport { run } from '@prairielearn/run';\nimport {\n  ArrayFromStringOrArraySchema,\n  BooleanFromCheckboxSchema,\n  IntegerFromStringOrEmptySchema,\n} from '@prairielearn/zod';\n\nimport { b64EncodeUnicode } from '../../lib/base64-util.js';\nimport { copyQuestionBetweenCourses } from '../../lib/copy-content.js';\nimport { EnumGradingMethodSchema } from '../../lib/db-types.js';\nimport { propertyValueWithDefault } from '../../lib/editorUtil.shared.js';\nimport {\n  FileModifyEditor,\n  MultiEditor,\n  QuestionCopyEditor,\n  QuestionDeleteEditor,\n  QuestionRenameEditor,\n  getOriginalHash,\n} from '../../lib/editors.js';\nimport { features } from '../../lib/features/index.js';\nimport { courseRepoContentUrl } from '../../lib/github.js';\nimport { idsEqual } from '../../lib/id.js';\nimport { getPaths } from '../../lib/instructorFiles.js';\nimport { applyKeyOrder } from '../../lib/json.js';\nimport { formatJsonWithPrettier } from '../../lib/prettier.js';\nimport { startTestQuestion } from '../../lib/question-testing.js';\nimport { typedAsyncHandler } from '../../lib/res-locals.js';\nimport { validateShortName } from '../../lib/short-name.js';\nimport { getCanonicalHost } from '../../lib/url.js';\nimport { generateCsrfToken } from '../../middlewares/csrfToken.js';\nimport { selectCoursesWithEditAccess } from '../../models/course.js';\nimport { selectQuestionByUuid } from '../../models/question.js';\nimport { selectTagsByCourseId, selectTagsByQuestionId } from '../../models/tags.js';\nimport { selectTopicsByCourseId } from '../../models/topics.js';\n\nimport { InstructorQuestionSettings } from './instructorQuestionSettings.html.js';\nimport {\n  SelectedAssessmentsSchema,\n  type SharingSetRow,\n  SharingSetRowSchema,\n} from './instructorQuestionSettings.types.js';\n\nconst router = Router();\nconst sql = sqldb.loadSqlEquiv(import.meta.url);\n\n// This will not correctly handle any filenames that have a comma in them.\n// Currently, we do not have any such filenames in prod so we don't think that\n// escaping commas in individual filenames is necessary.\nconst GradedFilesSchema = z\n  .string()\n  .transform((s) =>\n    s\n      .split(',')\n      .map((s) => s.trim())\n      .filter((s) => s !== ''),\n  )\n  .optional();\n\nconst ArgumentsSchema = z\n  .string()\n  .transform((s) => shlex.split(s || ''))\n  .optional();\n\nrouter.post(\n  '/test',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // We use a separate `test/` POST route so that we can always use the\n    // route to distinguish between pages that need to execute course code\n    // (this `test/` handler) and pages that need access to course content\n    // editing (here the plain '/' POST handler).\n    if (req.body.__action === 'test_once') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      const jobSequenceId = await startTestQuestion({\n        count: 1,\n        showDetails: true,\n        question: res.locals.question,\n        course_instance: res.locals.course_instance ?? null,\n        course: res.locals.course,\n        user_id: res.locals.user.id,\n        authn_user_id: res.locals.authn_user.id,\n        // Optional variant seed prefix for deterministic testing.\n        // Not exposed in UI - for internal use with automated testing scripts.\n        variantSeedPrefix: req.body.variant_seed_prefix,\n      });\n      res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n    } else if (req.body.__action === 'test_100') {\n      if (!res.locals.authz_data.has_course_permission_view) {\n        throw new error.HttpStatusError(403, 'Access denied (must be a course Viewer)');\n      }\n      if (res.locals.question.grading_method !== 'External') {\n        const jobSequenceId = await startTestQuestion({\n          count: 100,\n          showDetails: false,\n          question: res.locals.question,\n          course_instance: res.locals.course_instance ?? null,\n          course: res.locals.course,\n          user_id: res.locals.user.id,\n          authn_user_id: res.locals.authn_user.id,\n          // Optional variant seed prefix for deterministic testing.\n          // Not exposed in UI - for internal use with automated testing scripts.\n          variantSeedPrefix: req.body.variant_seed_prefix,\n        });\n        res.redirect(res.locals.urlPrefix + '/jobSequence/' + jobSequenceId);\n      } else {\n        throw new Error('Not supported for externally-graded questions');\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.post(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    if (req.body.__action === 'update_question') {\n      const infoPath = path.join(\n        res.locals.course.path,\n        'questions',\n        res.locals.question.qid!,\n        'info.json',\n      );\n      if (!(await fs.pathExists(infoPath))) {\n        throw new error.HttpStatusError(400, 'Question info file does not exist');\n      }\n\n      const body = z\n        .object({\n          orig_hash: z.string(),\n          qid: z.string(),\n          title: z.string(),\n          topic: z.string().optional(),\n          tags: ArrayFromStringOrArraySchema.optional(),\n          grading_method: EnumGradingMethodSchema.optional(),\n          single_variant: BooleanFromCheckboxSchema,\n          show_correct_answer: BooleanFromCheckboxSchema,\n          workspace_image: z.string().optional(),\n          workspace_port: IntegerFromStringOrEmptySchema.nullable().optional(),\n          workspace_home: z.string().optional(),\n          workspace_args: ArgumentsSchema,\n          workspace_rewrite_url: BooleanFromCheckboxSchema,\n          workspace_graded_files: GradedFilesSchema,\n          workspace_enable_networking: BooleanFromCheckboxSchema,\n          workspace_environment: z.string().optional(),\n          external_grading_enabled: BooleanFromCheckboxSchema,\n          external_grading_image: z.string().optional(),\n          external_grading_files: GradedFilesSchema,\n          external_grading_entrypoint: ArgumentsSchema,\n          external_grading_timeout: IntegerFromStringOrEmptySchema.optional(),\n          external_grading_enable_networking: BooleanFromCheckboxSchema,\n          external_grading_environment: z.string().optional(),\n        })\n        .parse(req.body);\n\n      const shortNameValidation = validateShortName(body.qid, res.locals.question.qid ?? undefined);\n      if (!shortNameValidation.valid) {\n        throw new error.HttpStatusError(\n          400,\n          `Invalid QID: ${shortNameValidation.lowercaseMessage}`,\n        );\n      }\n\n      const paths = getPaths(undefined, res.locals);\n\n      const questionInfo = JSON.parse(await fs.readFile(infoPath, 'utf8'));\n\n      const origHash = body.orig_hash;\n      questionInfo.title = body.title;\n      questionInfo.topic = body.topic;\n      questionInfo.tags = propertyValueWithDefault(\n        questionInfo.tags,\n        body.tags,\n        (val: any) => !val || val.length === 0,\n      );\n\n      questionInfo.gradingMethod = propertyValueWithDefault(\n        questionInfo.gradingMethod,\n        body.grading_method,\n        'Internal',\n      );\n\n      questionInfo.singleVariant = propertyValueWithDefault(\n        questionInfo.singleVariant,\n        body.single_variant,\n        false,\n      );\n\n      questionInfo.showCorrectAnswer = propertyValueWithDefault(\n        questionInfo.showCorrectAnswer,\n        body.show_correct_answer,\n        true,\n      );\n\n      const workspaceOptions = {\n        comment: questionInfo.workspaceOptions?.comment ?? undefined,\n        image: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.image,\n          body.workspace_image?.trim(),\n          '',\n        ),\n        port: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.port,\n          body.workspace_port,\n          null,\n        ),\n        home: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.home,\n          body.workspace_home?.trim(),\n          '',\n        ),\n        args: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.args,\n          body.workspace_args,\n          (v: any) => !v || v.length === 0,\n        ),\n        rewriteUrl: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.rewriteUrl,\n          body.workspace_rewrite_url,\n          true,\n        ),\n        gradedFiles: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.gradedFiles,\n          body.workspace_graded_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.enableNetworking,\n          body.workspace_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.workspaceOptions?.environment,\n          JSON.parse(body.workspace_environment?.replaceAll('\\r\\n', '\\n') || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n\n      // We'll only write the workspace options if the request contains the\n      // required fields. Client-side validation will ensure that these are\n      // present if a workspace is configured.\n      if (workspaceOptions.image && workspaceOptions.port && workspaceOptions.home) {\n        const filteredOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.workspaceOptions,\n              workspaceOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n        questionInfo.workspaceOptions =\n          Object.keys(filteredOptions).length > 0\n            ? applyKeyOrder(questionInfo.workspaceOptions, filteredOptions)\n            : undefined;\n      } else {\n        questionInfo.workspaceOptions = undefined;\n      }\n\n      const externalGradingOptions = {\n        comment: questionInfo.externalGradingOptions?.comment ?? undefined,\n        enabled: questionInfo.externalGradingOptions?.enabled,\n        image: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.image,\n          body.external_grading_image,\n          '',\n        ),\n        entrypoint: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.entrypoint,\n          body.external_grading_entrypoint,\n          (v: any) => v == null || v.length === 0,\n        ),\n        serverFilesCourse: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.serverFilesCourse,\n          body.external_grading_files,\n          (v: any) => !v || v.length === 0,\n        ),\n        timeout: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.timeout,\n          body.external_grading_timeout,\n          null,\n        ),\n        enableNetworking: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.enableNetworking,\n          body.external_grading_enable_networking,\n          false,\n        ),\n        environment: propertyValueWithDefault(\n          questionInfo.externalGradingOptions?.environment,\n          JSON.parse(body.external_grading_environment || '{}'),\n          (val: any) => !val || Object.keys(val).length === 0,\n        ),\n      };\n      if (externalGradingOptions.image) {\n        const filteredExternalGradingOptions = Object.fromEntries(\n          Object.entries(\n            propertyValueWithDefault(\n              questionInfo.externalGradingOptions,\n              externalGradingOptions,\n              (val: any) => !val || Object.keys(val).length === 0,\n            ),\n          ).filter(([_, value]) => value !== undefined),\n        );\n\n        questionInfo.externalGradingOptions =\n          Object.keys(filteredExternalGradingOptions).length > 0\n            ? applyKeyOrder(questionInfo.externalGradingOptions, filteredExternalGradingOptions)\n            : undefined;\n      } else {\n        questionInfo.externalGradingOptions = undefined;\n      }\n\n      const formattedJson = await formatJsonWithPrettier(JSON.stringify(questionInfo));\n\n      const qid_new = run(() => {\n        try {\n          return path.normalize(req.body.qid);\n        } catch {\n          throw new error.HttpStatusError(\n            400,\n            `Invalid QID (could not be normalized): ${req.body.qid}`,\n          );\n        }\n      });\n\n      const editor = new MultiEditor(\n        {\n          locals: res.locals,\n          // This won't reflect if the operation is an update or a rename; we think that's OK.\n          description: `Update question ${res.locals.question.qid}`,\n        },\n        [\n          // Each of these editors will no-op if there wasn't any change.\n          new FileModifyEditor({\n            locals: res.locals,\n            container: {\n              rootPath: paths.rootPath,\n              invalidRootPaths: paths.invalidRootPaths,\n            },\n            filePath: path.join(paths.rootPath, 'info.json'),\n            editContents: b64EncodeUnicode(formattedJson),\n            origHash,\n          }),\n          new QuestionRenameEditor({\n            locals: res.locals,\n            qid_new,\n          }),\n        ],\n      );\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n      } catch {\n        return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n\n      flash('success', 'Question settings updated successfully');\n      return res.redirect(req.originalUrl);\n    } else if (req.body.__action === 'copy_question') {\n      if (idsEqual(req.body.to_course_id, res.locals.course.id)) {\n        // In this case, we are making a duplicate of this question in the same course\n        const editor = new QuestionCopyEditor({\n          locals: res.locals,\n          from_qid: res.locals.question.qid!,\n          from_course: res.locals.course,\n          from_path: path.join(res.locals.course.path, 'questions', res.locals.question.qid!),\n          is_transfer: false,\n        });\n        const serverJob = await editor.prepareServerJob();\n        try {\n          await editor.executeWithServerJob(serverJob);\n        } catch {\n          return res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n        }\n\n        const question = await selectQuestionByUuid({\n          course_id: res.locals.course.id,\n          uuid: editor.uuid,\n        });\n\n        flash(\n          'success',\n          'Question copied successfully. You are now viewing your copy of the question.',\n        );\n        res.redirect(res.locals.urlPrefix + '/question/' + question.id + '/settings');\n      } else {\n        await copyQuestionBetweenCourses(res, {\n          fromCourse: res.locals.course,\n          toCourseId: req.body.to_course_id,\n          question: res.locals.question,\n        });\n      }\n    } else if (req.body.__action === 'delete_question') {\n      const editor = new QuestionDeleteEditor({\n        locals: res.locals,\n        questions: res.locals.question,\n      });\n      const serverJob = await editor.prepareServerJob();\n      try {\n        await editor.executeWithServerJob(serverJob);\n        res.redirect(res.locals.urlPrefix + '/course_admin/questions');\n      } catch {\n        res.redirect(res.locals.urlPrefix + '/edit_error/' + serverJob.jobSequenceId);\n      }\n    } else {\n      throw new error.HttpStatusError(400, `unknown __action: ${req.body.__action}`);\n    }\n  }),\n);\n\nrouter.get(\n  '/',\n  typedAsyncHandler<'instructor-question'>(async (req, res) => {\n    if (res.locals.question.course_id !== res.locals.course.id) {\n      throw new error.HttpStatusError(403, 'Access denied');\n    }\n    // Construct the path of the question test route. We'll do this based on\n    // `originalUrl` so that this router doesn't have to be aware of where it's\n    // mounted.\n    const host = getCanonicalHost(req);\n    let questionTestPath = new URL(req.originalUrl, host).pathname;\n    if (!questionTestPath.endsWith('/')) {\n      questionTestPath += '/';\n    }\n    questionTestPath += 'test';\n\n    // Generate a CSRF token for the test route. We can't use `res.locals.__csrf_token`\n    // here because this form will actually post to a different route, not `req.originalUrl`.\n    const questionTestCsrfToken = generateCsrfToken({\n      url: questionTestPath,\n      authnUserId: res.locals.authn_user.id,\n    });\n\n    const questionGHLink = courseRepoContentUrl(\n      res.locals.course,\n      `questions/${res.locals.question.qid}`,\n    );\n\n    const qids = await sqldb.queryRows(sql.qids, { course_id: res.locals.course.id }, z.string());\n\n    const assessmentsWithQuestion = await sqldb.queryRows(\n      sql.select_assessments_with_question_for_display,\n      { question_id: res.locals.question.id },\n      SelectedAssessmentsSchema,\n    );\n\n    const courseTopics = await selectTopicsByCourseId(res.locals.course.id);\n    const courseTags = await selectTagsByCourseId(res.locals.course.id);\n    const questionTags = await selectTagsByQuestionId(res.locals.question.id);\n\n    const sharingEnabled = await features.enabledFromLocals('question-sharing', res.locals);\n\n    let sharingSetsIn: SharingSetRow[] | undefined;\n    if (sharingEnabled) {\n      const result = await sqldb.queryRows(\n        sql.select_sharing_sets,\n        {\n          question_id: res.locals.question.id,\n          course_id: res.locals.course.id,\n        },\n        SharingSetRowSchema,\n      );\n      sharingSetsIn = result.filter((row) => row.in_set);\n    }\n    const editableCourses = await selectCoursesWithEditAccess({\n      user_id: res.locals.user.id,\n      is_administrator: res.locals.is_administrator,\n    });\n    const infoPath = path.join('questions', res.locals.question.qid!, 'info.json');\n    const fullInfoPath = path.join(res.locals.course.path, infoPath);\n\n    const origHash = (await getOriginalHash(fullInfoPath)) ?? '';\n\n    const canEdit =\n      res.locals.authz_data.has_course_permission_edit && !res.locals.course.example_course;\n\n    res.send(\n      InstructorQuestionSettings({\n        resLocals: res.locals,\n        questionTestPath,\n        questionTestCsrfToken,\n        questionGHLink,\n        questionTags,\n        qids,\n        assessmentsWithQuestion,\n        sharingEnabled,\n        sharingSetsIn,\n        editableCourses,\n        infoPath,\n        origHash,\n        canEdit,\n        courseTopics,\n        courseTags,\n      }),\n    );\n  }),\n);\n\nexport default router;\n","structuredPatch":[{"oldStart":160,"oldLines":7,"newStart":160,"newLines":6,"lines":["           workspace_graded_files: GradedFilesSchema,","           workspace_enable_networking: BooleanFromCheckboxSchema,","           workspace_environment: z.string().optional(),","-          external_grading_enabled: BooleanFromCheckboxSchema,","           external_grading_image: z.string().optional(),","           external_grading_files: GradedFilesSchema,","           external_grading_entrypoint: ArgumentsSchema,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"a0acf742-9308-450f-bcf6-5587a41c1fba"}
{"parentUuid":"bff43365-6159-4a77-84fb-0a555594ccf2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01TXwnKmQNGQivfvzYMMMANN","type":"message","role":"assistant","content":[{"type":"text","text":"And we can remove the unused `BooleanFromCheckboxSchema` import if it's only used for that... let me check:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":276,"cache_read_input_tokens":65586,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":276},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YjXmJZQSKBm7UYiEgh","type":"assistant","uuid":"27b3c716-e5da-46a6-a883-83e3e38aef09","timestamp":"2026-02-12T17:12:10.186Z"}
{"parentUuid":"27b3c716-e5da-46a6-a883-83e3e38aef09","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_01TXwnKmQNGQivfvzYMMMANN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ABsp737omxGu6bA1RKASMJ","name":"Grep","input":{"pattern":"BooleanFromCheckboxSchema","path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","output_mode":"count"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":276,"cache_read_input_tokens":65586,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":276},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4YjXmJZQSKBm7UYiEgh","type":"assistant","uuid":"2cfeff50-505f-4394-829a-2f12d71548f3","timestamp":"2026-02-12T17:12:11.050Z"}
{"parentUuid":"2cfeff50-505f-4394-829a-2f12d71548f3","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01ABsp737omxGu6bA1RKASMJ","toolUseID":"toolu_01ABsp737omxGu6bA1RKASMJ","timestamp":"2026-02-12T17:12:11.284Z","uuid":"4b79dbcd-e25d-4afb-908e-8719552049ba"}
{"parentUuid":"2cfeff50-505f-4394-829a-2f12d71548f3","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ABsp737omxGu6bA1RKASMJ","type":"tool_result","content":"6\n\nFound 0 total occurrences across 0 files."}]},"uuid":"db93c0f5-39dd-493e-89c4-41d8da12f9a8","timestamp":"2026-02-12T17:12:11.284Z","toolUseResult":{"mode":"count","numFiles":0,"filenames":[],"content":"6","numMatches":0},"sourceToolAssistantUUID":"2cfeff50-505f-4394-829a-2f12d71548f3"}
{"parentUuid":"db93c0f5-39dd-493e-89c4-41d8da12f9a8","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_018UNyJRpPB7yzwiwVr8VYo4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ppnezyh8gjXEAoBgGLTp3i","name":"Grep","input":{"pattern":"BooleanFromCheckboxSchema","path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/instructorQuestionSettings.ts","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":187,"cache_read_input_tokens":65862,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":187},"output_tokens":19,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4Yjqux787C5wPDdkNL8","type":"assistant","uuid":"b43beb18-30b5-4791-951c-8cf4f919ec4c","timestamp":"2026-02-12T17:12:14.273Z"}
{"parentUuid":"b43beb18-30b5-4791-951c-8cf4f919ec4c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Grep","command":"callback"},"parentToolUseID":"toolu_01Ppnezyh8gjXEAoBgGLTp3i","toolUseID":"toolu_01Ppnezyh8gjXEAoBgGLTp3i","timestamp":"2026-02-12T17:12:14.534Z","uuid":"71b8ca48-c089-418d-89c7-587d848b07ee"}
{"parentUuid":"b43beb18-30b5-4791-951c-8cf4f919ec4c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ppnezyh8gjXEAoBgGLTp3i","type":"tool_result","content":"14:  BooleanFromCheckboxSchema,\n153:          single_variant: BooleanFromCheckboxSchema,\n154:          show_correct_answer: BooleanFromCheckboxSchema,\n159:          workspace_rewrite_url: BooleanFromCheckboxSchema,\n161:          workspace_enable_networking: BooleanFromCheckboxSchema,\n167:          external_grading_enable_networking: BooleanFromCheckboxSchema,"}]},"uuid":"7908b0e8-dfb4-4029-b316-1cc080f3245c","timestamp":"2026-02-12T17:12:14.533Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"14:  BooleanFromCheckboxSchema,\n153:          single_variant: BooleanFromCheckboxSchema,\n154:          show_correct_answer: BooleanFromCheckboxSchema,\n159:          workspace_rewrite_url: BooleanFromCheckboxSchema,\n161:          workspace_enable_networking: BooleanFromCheckboxSchema,\n167:          external_grading_enable_networking: BooleanFromCheckboxSchema,","numLines":6},"sourceToolAssistantUUID":"b43beb18-30b5-4791-951c-8cf4f919ec4c"}
{"parentUuid":"7908b0e8-dfb4-4029-b316-1cc080f3245c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","message":{"model":"claude-opus-4-6","id":"msg_011nxQbnisnpCbgd6y5zEf5a","type":"message","role":"assistant","content":[{"type":"text","text":"Still used elsewhere, so the import stays.\n\nSummary: The backend now just preserves whatever `enabled` value was in the existing JSON (if any), and the form's `external_grading_enabled` checkbox is purely a frontend UI concern for showing/hiding the external grading options section. Since `enabled` is deprecated, the form shouldn't be writing to it at all."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":246,"cache_read_input_tokens":66049,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":246},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4Yk5VX6BU2p1KXyF9j9","type":"assistant","uuid":"6af0a8f4-d544-46c3-a32c-247d768dd134","timestamp":"2026-02-12T17:12:18.641Z"}
{"parentUuid":"6af0a8f4-d544-46c3-a32c-247d768dd134","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"15d8517d-4c95-40d8-8236-d3ef4c400873","toolUseID":"15d8517d-4c95-40d8-8236-d3ef4c400873","timestamp":"2026-02-12T17:12:18.683Z","uuid":"551972de-a9c4-42d3-8f57-9775a456414e"}
{"parentUuid":"551972de-a9c4-42d3-8f57-9775a456414e","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"},"parentToolUseID":"15d8517d-4c95-40d8-8236-d3ef4c400873","toolUseID":"15d8517d-4c95-40d8-8236-d3ef4c400873","timestamp":"2026-02-12T17:12:18.683Z","uuid":"e5457e15-fd61-471f-b585-358ccdaa9933"}
{"parentUuid":"e5457e15-fd61-471f-b585-358ccdaa9933","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"system","subtype":"stop_hook_summary","hookCount":2,"hookInfos":[{"command":"entire hooks claude-code stop"},{"command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-12T17:12:22.615Z","uuid":"79902a78-246f-470b-bdb9-f2549753a4b1","toolUseID":"15d8517d-4c95-40d8-8236-d3ef4c400873"}
{"parentUuid":"79902a78-246f-470b-bdb9-f2549753a4b1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"e13d7589-442a-4e90-b164-6e2fae674f4e","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"glittery-baking-manatee","type":"system","subtype":"turn_duration","durationMs":71757,"timestamp":"2026-02-12T17:12:22.619Z","uuid":"7fefe085-d21e-4bbc-836b-e5949f0653bf","isMeta":false}
