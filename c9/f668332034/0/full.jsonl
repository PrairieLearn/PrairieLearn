{"type":"file-history-snapshot","messageId":"ce862acd-c799-48a6-bb5c-0f1254c1dfc5","snapshot":{"messageId":"ce862acd-c799-48a6-bb5c-0f1254c1dfc5","trackedFileBackups":{},"timestamp":"2026-02-12T16:50:53.178Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:startup","command":"~/.claude/hooks/fix-lsp-plugins.sh"},"parentToolUseID":"5e0a5f5c-2523-477d-a76e-f0f50f7e003c","toolUseID":"5e0a5f5c-2523-477d-a76e-f0f50f7e003c","timestamp":"2026-02-12T16:50:15.051Z","uuid":"1a658ecd-1bc2-402e-aad7-cfed22b7db80"}
{"parentUuid":"1a658ecd-1bc2-402e-aad7-cfed22b7db80","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"progress","data":{"type":"hook_progress","hookEvent":"SessionStart","hookName":"SessionStart:startup","command":"entire hooks claude-code session-start"},"parentToolUseID":"5e0a5f5c-2523-477d-a76e-f0f50f7e003c","toolUseID":"5e0a5f5c-2523-477d-a76e-f0f50f7e003c","timestamp":"2026-02-12T16:50:15.067Z","uuid":"7aef9168-85ce-4b17-a2a6-a1e5ec8f3211"}
{"parentUuid":"7aef9168-85ce-4b17-a2a6-a1e5ec8f3211","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","type":"user","message":{"role":"user","content":"add aria to the form in apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx -- with aria-errormessage and aria-isinvalid"},"uuid":"ce862acd-c799-48a6-bb5c-0f1254c1dfc5","timestamp":"2026-02-12T16:50:42.726Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"bypassPermissions"}
{"parentUuid":"ce862acd-c799-48a6-bb5c-0f1254c1dfc5","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","message":{"model":"claude-opus-4-6","id":"msg_01XoQ5kwgJmdN9H69489jpKt","type":"message","role":"assistant","content":[{"type":"text","text":"\n\nLet me read the current form file to understand its structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8900,"cache_read_input_tokens":35472,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8900},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X7dG5ctUT5R7AMH2k2","type":"assistant","uuid":"501e8167-992e-40e1-b73a-68d919e77aea","timestamp":"2026-02-12T16:50:56.516Z"}
{"parentUuid":"501e8167-992e-40e1-b73a-68d919e77aea","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01XoQ5kwgJmdN9H69489jpKt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BVwbbA4GUU4HdPCrTLCVXt","name":"Read","input":{"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8900,"cache_read_input_tokens":35472,"output_tokens":106,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":8900,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[]}},"requestId":"req_011CY4X7dG5ctUT5R7AMH2k2","type":"assistant","uuid":"bcb33f63-881a-4f20-b801-16d9bd3df6bc","timestamp":"2026-02-12T16:50:57.251Z"}
{"parentUuid":"bcb33f63-881a-4f20-b801-16d9bd3df6bc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01BVwbbA4GUU4HdPCrTLCVXt","toolUseID":"toolu_01BVwbbA4GUU4HdPCrTLCVXt","timestamp":"2026-02-12T16:50:57.486Z","uuid":"3f32d5ff-a09a-4444-a2a1-e9b8f368eed4"}
{"parentUuid":"bcb33f63-881a-4f20-b801-16d9bd3df6bc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BVwbbA4GUU4HdPCrTLCVXt","type":"tool_result","content":"     1→import clsx from 'clsx';\n     2→import { useMemo } from 'react';\n     3→import { useForm } from 'react-hook-form';\n     4→\n     5→import { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n     6→\n     7→import { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\n     8→import { TagBadge } from '../../../components/TagBadge.js';\n     9→import { TagDescription } from '../../../components/TagDescription.js';\n    10→import { TopicBadge } from '../../../components/TopicBadge.js';\n    11→import { TopicDescription } from '../../../components/TopicDescription.js';\n    12→import type {\n    13→  StaffCourseInstance,\n    14→  StaffQuestion,\n    15→  StaffTag,\n    16→  StaffTopic,\n    17→} from '../../../lib/client/safe-db-types.js';\n    18→import { idsEqual } from '../../../lib/id.js';\n    19→import { validateShortName } from '../../../lib/short-name.js';\n    20→import type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n    21→\n    22→function AssessmentBadges({\n    23→  assessmentsWithQuestion,\n    24→  courseInstanceId,\n    25→}: {\n    26→  assessmentsWithQuestion: SelectedAssessments[];\n    27→  courseInstanceId: string;\n    28→}) {\n    29→  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    30→    idsEqual(a.course_instance_id, courseInstanceId),\n    31→  );\n    32→\n    33→  if (\n    34→    !assessmentsInCourseInstance?.assessments ||\n    35→    assessmentsInCourseInstance.assessments.length === 0\n    36→  ) {\n    37→    return (\n    38→      <small className=\"text-muted text-center\">\n    39→        This question is not included in any assessments in this course instance.\n    40→      </small>\n    41→    );\n    42→  }\n    43→\n    44→  return (\n    45→    <div className=\"d-flex flex-wrap gap-1\">\n    46→      {assessmentsInCourseInstance.assessments.map((assessment) => (\n    47→        <a\n    48→          key={assessment.assessment_id}\n    49→          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n    50→          className={`btn btn-badge color-${assessment.color}`}\n    51→        >\n    52→          {assessment.label}\n    53→        </a>\n    54→      ))}\n    55→    </div>\n    56→  );\n    57→}\n    58→\n    59→interface QuestionSettingsFormValues {\n    60→  qid: string;\n    61→  title: string;\n    62→  topic: string;\n    63→  tags: string[];\n    64→  grading_method: 'Internal' | 'External' | 'Manual';\n    65→  single_variant: boolean;\n    66→  show_correct_answer: boolean;\n    67→  workspace_enabled: boolean;\n    68→  workspace_image: string;\n    69→  workspace_port: string;\n    70→  workspace_home: string;\n    71→  workspace_graded_files: string;\n    72→  workspace_args: string;\n    73→  workspace_environment: string;\n    74→  workspace_enable_networking: boolean;\n    75→  workspace_rewrite_url: boolean;\n    76→  external_grading_enabled: boolean;\n    77→  external_grading_image: string;\n    78→  external_grading_entrypoint: string;\n    79→  external_grading_files: string;\n    80→  external_grading_timeout: string;\n    81→  external_grading_enable_networking: boolean;\n    82→  external_grading_environment: string;\n    83→}\n    84→\n    85→export function validateJson(value: string): string | true {\n    86→  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n    87→  try {\n    88→    const parsed = JSON.parse(value);\n    89→    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n    90→      return 'Must be a valid JSON object';\n    91→    }\n    92→    return true;\n    93→  } catch {\n    94→    return 'Invalid JSON format';\n    95→  }\n    96→}\n    97→\n    98→export const QuestionSettingsForm = ({\n    99→  question,\n   100→  topic,\n   101→  courseInstance,\n   102→  assessmentsWithQuestion,\n   103→  courseTopics,\n   104→  courseTags,\n   105→  questionTags,\n   106→  qids,\n   107→  origHash,\n   108→  csrfToken,\n   109→  canEdit,\n   110→}: {\n   111→  question: StaffQuestion;\n   112→  courseInstance?: StaffCourseInstance | null;\n   113→  assessmentsWithQuestion: SelectedAssessments[];\n   114→  topic: StaffTopic;\n   115→  courseTopics: StaffTopic[];\n   116→  courseTags: StaffTag[];\n   117→  questionTags: StaffTag[];\n   118→  qids: string[];\n   119→  origHash: string;\n   120→  csrfToken: string;\n   121→  canEdit: boolean;\n   122→}) => {\n   123→  const defaultValues: QuestionSettingsFormValues = {\n   124→    qid: question.qid ?? '',\n   125→    title: question.title ?? '',\n   126→    topic: topic.name,\n   127→    tags: questionTags.map((t) => t.name),\n   128→    grading_method: question.grading_method,\n   129→    single_variant: question.single_variant ?? false,\n   130→    show_correct_answer: question.show_correct_answer ?? true,\n   131→    workspace_enabled: !!question.workspace_image,\n   132→    workspace_image: question.workspace_image ?? '',\n   133→    workspace_port: question.workspace_port?.toString() ?? '',\n   134→    workspace_home: question.workspace_home ?? '',\n   135→    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n   136→    workspace_args: question.workspace_args ?? '',\n   137→    workspace_environment:\n   138→      Object.keys(question.workspace_environment ?? {}).length > 0\n   139→        ? JSON.stringify(question.workspace_environment, null, 2)\n   140→        : '{}',\n   141→    workspace_enable_networking: question.workspace_enable_networking ?? false,\n   142→    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n   143→    external_grading_enabled: !!question.external_grading_image,\n   144→    external_grading_image: question.external_grading_image ?? '',\n   145→    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n   146→    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n   147→    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n   148→    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n   149→    external_grading_environment:\n   150→      Object.keys(question.external_grading_environment).length > 0\n   151→        ? JSON.stringify(question.external_grading_environment, null, 2)\n   152→        : '{}',\n   153→  };\n   154→\n   155→  const {\n   156→    register,\n   157→    watch,\n   158→    setValue,\n   159→    trigger,\n   160→    clearErrors,\n   161→    formState: { errors, isDirty },\n   162→  } = useForm<QuestionSettingsFormValues>({\n   163→    mode: 'onChange',\n   164→    defaultValues,\n   165→  });\n   166→\n   167→  const selectedTopic = watch('topic');\n   168→  const selectedTags = watch('tags');\n   169→  const selectedGradingMethod = watch('grading_method');\n   170→  const workspaceEnabled = watch('workspace_enabled');\n   171→  const externalGradingEnabled = watch('external_grading_enabled');\n   172→\n   173→  const isExternalGrading = selectedGradingMethod === 'External';\n   174→\n   175→  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n   176→    () =>\n   177→      courseTopics.map((t) => ({\n   178→        id: t.name,\n   179→        data: t,\n   180→        label: t.name,\n   181→        searchableText: `${t.name} ${t.description}`,\n   182→      })),\n   183→    [courseTopics],\n   184→  );\n   185→\n   186→  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n   187→    () =>\n   188→      [...courseTags]\n   189→        .sort((a, b) => {\n   190→          // Sort explicit tags above implicit tags, then by name\n   191→          if (a.implicit !== b.implicit) {\n   192→            return a.implicit ? 1 : -1;\n   193→          }\n   194→          return a.name.localeCompare(b.name);\n   195→        })\n   196→        .map((t) => ({\n   197→          id: t.name,\n   198→          data: t,\n   199→          label: t.name,\n   200→          searchableText: `${t.name} ${t.description}`,\n   201→        })),\n   202→    [courseTags],\n   203→  );\n   204→\n   205→  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n   206→  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n   207→\n   208→  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n   209→\n   210→  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n   211→    const isValid = await trigger();\n   212→    if (!isValid) {\n   213→      e.preventDefault();\n   214→    }\n   215→  };\n   216→\n   217→  return (\n   218→    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n   219→      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n   220→      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n   221→\n   222→      <div className=\"mb-3\">\n   223→        <label className=\"form-label\" htmlFor=\"qid\">\n   224→          QID\n   225→        </label>\n   226→        <input\n   227→          type=\"text\"\n   228→          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n   229→          id=\"qid\"\n   230→          disabled={!canEdit}\n   231→          {...register('qid', {\n   232→            required: 'QID is required',\n   233→            validate: {\n   234→              shortName: (value) => {\n   235→                const result = validateShortName(value, defaultValues.qid);\n   236→                return result.valid || result.message;\n   237→              },\n   238→              duplicate: (value) => {\n   239→                if (otherQids.has(value)) {\n   240→                  return 'This QID is already in use';\n   241→                }\n   242→                return true;\n   243→              },\n   244→            },\n   245→          })}\n   246→        />\n   247→        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}\n   248→        <small className=\"form-text text-muted\">\n   249→          <QuestionShortNameDescription />\n   250→        </small>\n   251→      </div>\n   252→\n   253→      <div className=\"mb-3\">\n   254→        <h2 className=\"h4\">General</h2>\n   255→        <label className=\"form-label\" htmlFor=\"title\">\n   256→          Title\n   257→        </label>\n   258→        <input\n   259→          type=\"text\"\n   260→          className=\"form-control\"\n   261→          id=\"title\"\n   262→          disabled={!canEdit}\n   263→          {...register('title')}\n   264→        />\n   265→        <small className=\"form-text text-muted\">\n   266→          The title of the question (e.g., \"Add two numbers\").\n   267→        </small>\n   268→      </div>\n   269→\n   270→      <div className=\"table-responsive card mb-3 overflow-visible\">\n   271→        <table\n   272→          className=\"table two-column-description\"\n   273→          aria-label=\"Question topic, tags, and assessments\"\n   274→        >\n   275→          <tbody>\n   276→            <tr>\n   277→              <th className=\"align-middle\">\n   278→                <label id=\"topic-label\" htmlFor=\"topic\">\n   279→                  Topic\n   280→                </label>\n   281→              </th>\n   282→              <td>\n   283→                {canEdit ? (\n   284→                  <ComboBox\n   285→                    id=\"topic\"\n   286→                    name=\"topic\"\n   287→                    items={topicItems}\n   288→                    value={selectedTopic}\n   289→                    placeholder=\"Select a topic\"\n   290→                    aria-labelledby=\"topic-label\"\n   291→                    renderItem={(item) => (\n   292→                      <div style={{ whiteSpace: 'normal' }}>\n   293→                        <TopicBadge topic={item.data!} />\n   294→                        {item.data!.description && (\n   295→                          <div>\n   296→                            <small className=\"text-muted\">\n   297→                              <TopicDescription topic={item.data!} />\n   298→                            </small>\n   299→                          </div>\n   300→                        )}\n   301→                      </div>\n   302→                    )}\n   303→                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n   304→                  />\n   305→                ) : currentTopicData ? (\n   306→                  <TopicBadge topic={currentTopicData} />\n   307→                ) : null}\n   308→              </td>\n   309→            </tr>\n   310→            <tr>\n   311→              <th className=\"align-middle\">\n   312→                <label id=\"tags-label\" htmlFor=\"tags\">\n   313→                  Tags\n   314→                </label>\n   315→              </th>\n   316→              <td>\n   317→                {canEdit ? (\n   318→                  <TagPicker\n   319→                    id=\"tags\"\n   320→                    name=\"tags\"\n   321→                    items={tagItems}\n   322→                    value={selectedTags}\n   323→                    placeholder=\"Select tags\"\n   324→                    aria-labelledby=\"tags-label\"\n   325→                    renderItem={(item) => (\n   326→                      <div style={{ whiteSpace: 'normal' }}>\n   327→                        <TagBadge tag={item.data!} />\n   328→                        {!item.data!.implicit && item.data!.description && (\n   329→                          <div>\n   330→                            <small className=\"text-muted\">\n   331→                              <TagDescription tag={item.data!} />\n   332→                            </small>\n   333→                          </div>\n   334→                        )}\n   335→                      </div>\n   336→                    )}\n   337→                    renderTagContent={(data) => data.name}\n   338→                    tagClassName={(data) => `badge color-${data.color}`}\n   339→                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n   340→                  />\n   341→                ) : (\n   342→                  currentTagsData.map((tag) => (\n   343→                    <span key={tag.name} className=\"me-1\">\n   344→                      <TagBadge tag={tag} />\n   345→                    </span>\n   346→                  ))\n   347→                )}\n   348→              </td>\n   349→            </tr>\n   350→            {courseInstance && (\n   351→              <tr>\n   352→                <th className=\"align-middle\">Assessments</th>\n   353→                <td>\n   354→                  <AssessmentBadges\n   355→                    assessmentsWithQuestion={assessmentsWithQuestion}\n   356→                    courseInstanceId={courseInstance.id}\n   357→                  />\n   358→                </td>\n   359→              </tr>\n   360→            )}\n   361→          </tbody>\n   362→        </table>\n   363→      </div>\n   364→\n   365→      <div className=\"mb-3\">\n   366→        <label className=\"form-label\" htmlFor=\"grading_method\">\n   367→          Grading method\n   368→        </label>\n   369→        <select\n   370→          className=\"form-select\"\n   371→          id=\"grading_method\"\n   372→          disabled={!canEdit}\n   373→          {...register('grading_method', {\n   374→            onChange: (e) => {\n   375→              if (e.target.value === 'External') {\n   376→                setValue('external_grading_enabled', true, { shouldDirty: true });\n   377→              }\n   378→            },\n   379→          })}\n   380→        >\n   381→          <option value=\"Internal\">Internal</option>\n   382→          <option value=\"External\">External</option>\n   383→          <option value=\"Manual\">Manual</option>\n   384→        </select>\n   385→        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n   386→      </div>\n   387→\n   388→      <div className=\"mb-3 form-check\">\n   389→        <input\n   390→          className=\"form-check-input\"\n   391→          type=\"checkbox\"\n   392→          id=\"single_variant\"\n   393→          disabled={!canEdit}\n   394→          {...register('single_variant')}\n   395→        />\n   396→        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n   397→          Single variant\n   398→        </label>\n   399→        <div className=\"small text-muted\">\n   400→          If enabled, students will only be able to try a single variant of this question on any\n   401→          given assessment.\n   402→        </div>\n   403→      </div>\n   404→\n   405→      <div className=\"mb-3 form-check\">\n   406→        <input\n   407→          className=\"form-check-input\"\n   408→          type=\"checkbox\"\n   409→          id=\"show_correct_answer\"\n   410→          disabled={!canEdit}\n   411→          {...register('show_correct_answer')}\n   412→        />\n   413→        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n   414→          Show correct answer\n   415→        </label>\n   416→        <div className=\"small text-muted\">\n   417→          If enabled, the correct answer panel will be shown after all submission attempts have been\n   418→          exhausted.\n   419→        </div>\n   420→      </div>\n   421→\n   422→      <div className=\"mb-3\">\n   423→        <div className=\"form-check\">\n   424→          <input\n   425→            className=\"form-check-input\"\n   426→            type=\"checkbox\"\n   427→            id=\"workspaceEnabled\"\n   428→            checked={workspaceEnabled}\n   429→            disabled={!canEdit}\n   430→            onChange={() => {\n   431→              if (workspaceEnabled) {\n   432→                clearErrors([\n   433→                  'workspace_image',\n   434→                  'workspace_port',\n   435→                  'workspace_home',\n   436→                  'workspace_environment',\n   437→                ]);\n   438→              }\n   439→              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n   440→            }}\n   441→          />\n   442→          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n   443→            Workspace\n   444→          </label>\n   445→        </div>\n   446→        <small className=\"text-muted ps-4\">\n   447→          Configure a{' '}\n   448→          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n   449→            remote development environment\n   450→          </a>{' '}\n   451→          for students.\n   452→        </small>\n   453→        {workspaceEnabled && (\n   454→          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n   455→            <div className=\"mb-3\">\n   456→              <label className=\"form-label\" htmlFor=\"workspace_image\">\n   457→                Image\n   458→              </label>\n   459→              <input\n   460→                type=\"text\"\n   461→                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n   462→                id=\"workspace_image\"\n   463→                disabled={!canEdit}\n   464→                {...register('workspace_image', {\n   465→                  required: 'Image is required for workspace',\n   466→                })}\n   467→              />\n   468→              {errors.workspace_image && (\n   469→                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n   470→              )}\n   471→              <small className=\"form-text text-muted\">\n   472→                The Docker image that will be used to serve this workspace. Only images from the\n   473→                Dockerhub registry are supported.\n   474→              </small>\n   475→            </div>\n   476→\n   477→            <div className=\"mb-3\">\n   478→              <label className=\"form-label\" htmlFor=\"workspace_port\">\n   479→                Port\n   480→              </label>\n   481→              <input\n   482→                type=\"number\"\n   483→                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n   484→                id=\"workspace_port\"\n   485→                disabled={!canEdit}\n   486→                // Disable default behavior of incrementing/decrementing the value when scrolling\n   487→                onWheel={(e) => e.currentTarget.blur()}\n   488→                {...register('workspace_port', {\n   489→                  required: 'Port is required for workspace',\n   490→                })}\n   491→              />\n   492→              {errors.workspace_port && (\n   493→                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n   494→              )}\n   495→              <small className=\"form-text text-muted\">\n   496→                The port number used in the Docker image.\n   497→              </small>\n   498→            </div>\n   499→\n   500→            <div className=\"mb-3\">\n   501→              <label className=\"form-label\" htmlFor=\"workspace_home\">\n   502→                Home\n   503→              </label>\n   504→              <input\n   505→                type=\"text\"\n   506→                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n   507→                id=\"workspace_home\"\n   508→                disabled={!canEdit}\n   509→                {...register('workspace_home', {\n   510→                  required: 'Home is required for workspace',\n   511→                })}\n   512→              />\n   513→              {errors.workspace_home && (\n   514→                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n   515→              )}\n   516→              <small className=\"form-text text-muted\">\n   517→                The home directory of the workspace container.\n   518→              </small>\n   519→            </div>\n   520→\n   521→            <div className=\"mb-3\">\n   522→              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n   523→                Graded files\n   524→              </label>\n   525→              <input\n   526→                type=\"text\"\n   527→                className=\"form-control\"\n   528→                id=\"workspace_graded_files\"\n   529→                disabled={!canEdit}\n   530→                {...register('workspace_graded_files')}\n   531→              />\n   532→              <small className=\"form-text text-muted\">\n   533→                The list of files or directories that will be copied out of the workspace container\n   534→                when saving a submission. You may enter multiple files or directories, separated by\n   535→                commas.\n   536→              </small>\n   537→            </div>\n   538→\n   539→            <div className=\"mb-3\">\n   540→              <label className=\"form-label\" htmlFor=\"workspace_args\">\n   541→                Arguments\n   542→              </label>\n   543→              <input\n   544→                type=\"text\"\n   545→                className=\"form-control\"\n   546→                id=\"workspace_args\"\n   547→                disabled={!canEdit}\n   548→                {...register('workspace_args')}\n   549→              />\n   550→              <small className=\"form-text text-muted\">\n   551→                Command line arguments to pass to the Docker container. Multiple arguments should be\n   552→                separated by spaces and escaped as necessary using the same format as a typical\n   553→                shell.\n   554→              </small>\n   555→            </div>\n   556→\n   557→            <div className=\"mb-3\">\n   558→              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n   559→                Environment\n   560→              </label>\n   561→              <textarea\n   562→                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n   563→                id=\"workspace_environment\"\n   564→                disabled={!canEdit}\n   565→                {...register('workspace_environment', {\n   566→                  validate: validateJson,\n   567→                })}\n   568→              />\n   569→              {errors.workspace_environment && (\n   570→                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n   571→              )}\n   572→              <small className=\"form-text text-muted\">\n   573→                Environment variables to set inside the workspace container. Variables must be\n   574→                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n   575→              </small>\n   576→            </div>\n   577→\n   578→            <div className=\"mb-3 form-check\">\n   579→              <input\n   580→                className=\"form-check-input\"\n   581→                type=\"checkbox\"\n   582→                id=\"workspace_enable_networking\"\n   583→                disabled={!canEdit}\n   584→                {...register('workspace_enable_networking')}\n   585→              />\n   586→              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n   587→                Enable networking\n   588→              </label>\n   589→              <div className=\"small text-muted\">\n   590→                Whether the workspace should have network access. Access is disabled by default.\n   591→              </div>\n   592→            </div>\n   593→\n   594→            <div className=\"mb-3 form-check\">\n   595→              <input\n   596→                className=\"form-check-input\"\n   597→                type=\"checkbox\"\n   598→                id=\"workspace_rewrite_url\"\n   599→                disabled={!canEdit}\n   600→                {...register('workspace_rewrite_url')}\n   601→              />\n   602→              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n   603→                Rewrite URL\n   604→              </label>\n   605→              <div className=\"small text-muted\">\n   606→                If enabled, the URL will be rewritten such that the workspace container will see all\n   607→                requests as originating from \"/\".\n   608→              </div>\n   609→            </div>\n   610→          </div>\n   611→        )}\n   612→      </div>\n   613→\n   614→      <div className=\"mb-3\">\n   615→        {isExternalGrading ? (\n   616→          <h4 className=\"mb-0\">External grading</h4>\n   617→        ) : (\n   618→          <div className=\"form-check\">\n   619→            <input\n   620→              className=\"form-check-input\"\n   621→              type=\"checkbox\"\n   622→              id=\"externalGradingEnabled\"\n   623→              checked={externalGradingEnabled}\n   624→              disabled={!canEdit}\n   625→              onChange={() => {\n   626→                if (externalGradingEnabled) {\n   627→                  clearErrors(['external_grading_image', 'external_grading_environment']);\n   628→                }\n   629→                setValue('external_grading_enabled', !externalGradingEnabled, {\n   630→                  shouldDirty: true,\n   631→                });\n   632→              }}\n   633→            />\n   634→            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n   635→              External grading\n   636→            </label>\n   637→          </div>\n   638→        )}\n   639→        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n   640→          Configure{' '}\n   641→          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n   642→            grading using a Docker container\n   643→          </a>\n   644→          .\n   645→        </small>\n   646→        {(isExternalGrading || externalGradingEnabled) && (\n   647→          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n   648→            <div className=\"mb-3\">\n   649→              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n   650→                Image\n   651→              </label>\n   652→              <input\n   653→                type=\"text\"\n   654→                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n   655→                id=\"external_grading_image\"\n   656→                disabled={!canEdit}\n   657→                {...register('external_grading_image', {\n   658→                  required: externalGradingEnabled && 'Image is required for external grading',\n   659→                })}\n   660→              />\n   661→              {errors.external_grading_image && (\n   662→                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n   663→              )}\n   664→              <small className=\"form-text text-muted\">\n   665→                The Docker image that will be used to grade this question. Only images from the\n   666→                Dockerhub registry are supported.\n   667→              </small>\n   668→            </div>\n   669→\n   670→            <div className=\"mb-3\">\n   671→              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n   672→                Entrypoint\n   673→              </label>\n   674→              <input\n   675→                type=\"text\"\n   676→                className=\"form-control\"\n   677→                id=\"external_grading_entrypoint\"\n   678→                disabled={!canEdit}\n   679→                {...register('external_grading_entrypoint')}\n   680→              />\n   681→              <small className=\"form-text text-muted\">\n   682→                Program or command to run as the entrypoint to your grader. If not provided, the\n   683→                default entrypoint for the image will be used.\n   684→              </small>\n   685→            </div>\n   686→\n   687→            <div className=\"mb-3\">\n   688→              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n   689→                Server files\n   690→              </label>\n   691→              <input\n   692→                type=\"text\"\n   693→                className=\"form-control\"\n   694→                id=\"external_grading_files\"\n   695→                disabled={!canEdit}\n   696→                {...register('external_grading_files')}\n   697→              />\n   698→              <small className=\"form-text text-muted\">\n   699→                The list of files or directories that will be copied from{' '}\n   700→                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n   701→                files or directories, separated by commas.\n   702→              </small>\n   703→            </div>\n   704→\n   705→            <div className=\"mb-3\">\n   706→              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n   707→                Timeout\n   708→              </label>\n   709→              <input\n   710→                type=\"number\"\n   711→                className=\"form-control\"\n   712→                id=\"external_grading_timeout\"\n   713→                min=\"0\"\n   714→                disabled={!canEdit}\n   715→                // Disable default behavior of incrementing/decrementing the value when scrolling\n   716→                onWheel={(e) => e.currentTarget.blur()}\n   717→                {...register('external_grading_timeout')}\n   718→              />\n   719→              <small className=\"form-text text-muted\">\n   720→                The number of seconds after which the grading job will timeout.\n   721→              </small>\n   722→            </div>\n   723→\n   724→            <div className=\"mb-3\">\n   725→              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n   726→                Environment\n   727→              </label>\n   728→              <textarea\n   729→                className={clsx(\n   730→                  'form-control',\n   731→                  errors.external_grading_environment && 'is-invalid',\n   732→                )}\n   733→                id=\"external_grading_environment\"\n   734→                disabled={!canEdit}\n   735→                {...register('external_grading_environment', {\n   736→                  validate: validateJson,\n   737→                })}\n   738→              />\n   739→              {errors.external_grading_environment && (\n   740→                <div className=\"invalid-feedback\">\n   741→                  {errors.external_grading_environment.message}\n   742→                </div>\n   743→              )}\n   744→              <small className=\"form-text text-muted\">\n   745→                Environment variables to set inside the grading container. Variables must be\n   746→                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n   747→              </small>\n   748→            </div>\n   749→\n   750→            <div className=\"mb-3 form-check\">\n   751→              <input\n   752→                className=\"form-check-input\"\n   753→                type=\"checkbox\"\n   754→                id=\"external_grading_enable_networking\"\n   755→                disabled={!canEdit}\n   756→                {...register('external_grading_enable_networking')}\n   757→              />\n   758→              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n   759→                Enable networking\n   760→              </label>\n   761→              <div className=\"small text-muted\">\n   762→                Whether the grading containers should have network access. Access is disabled by\n   763→                default.\n   764→              </div>\n   765→            </div>\n   766→          </div>\n   767→        )}\n   768→      </div>\n   769→\n   770→      {canEdit && (\n   771→        <>\n   772→          <button\n   773→            id=\"save-button\"\n   774→            type=\"submit\"\n   775→            className=\"btn btn-primary mb-2\"\n   776→            name=\"__action\"\n   777→            value=\"update_question\"\n   778→            disabled={!isDirty}\n   779→          >\n   780→            Save\n   781→          </button>\n   782→          <button\n   783→            type=\"button\"\n   784→            className=\"btn btn-secondary mb-2 ms-2\"\n   785→            onClick={() => window.location.reload()}\n   786→          >\n   787→            Cancel\n   788→          </button>\n   789→        </>\n   790→      )}\n   791→    </form>\n   792→  );\n   793→};\n   794→\n   795→QuestionSettingsForm.displayName = 'QuestionSettingsForm';\n   796→"}]},"uuid":"70bc303c-f829-4783-820f-84114ff8d466","timestamp":"2026-02-12T16:50:57.485Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","content":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","numLines":796,"startLine":1,"totalLines":796}},"sourceToolAssistantUUID":"bcb33f63-881a-4f20-b801-16d9bd3df6bc"}
{"parentUuid":"70bc303c-f829-4783-820f-84114ff8d466","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01CDpREPjuCSAXUpckQcSJUD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to add `aria-errormessage` and `aria-invalid` attributes to the form inputs that have validation errors. Let me identify all inputs that can have errors:\n\n1. `qid` (line 226-245) - has `errors.qid` and error feedback div\n2. `workspace_image` (line 459-467) - has `errors.workspace_image`\n3. `workspace_port` (line 482-492) - has `errors.workspace_port`\n4. `workspace_home` (line 505-512) - has `errors.workspace_home`\n\n\n5. `workspace_environment` (line 561-568) - has `errors.workspace_environment`\n6. `external_grading_image` (line 652-660) - has `errors.external_grading_image`\n7. `external_grading_environment` (line 728-738) - has `errors.external_grading_environment`\n\nFor each of these fields, I need to add `aria-invalid` set to true when there's an error, and `aria-errormessage` pointing to the corresponding error message element ID.\n\nI should note that the correct ARIA attribute is `aria-invalid`, not `aria-isinvalid`. I'll add these attributes alongside the spread from `register()` to ensure they're properly applied to each input field.\n\nFor the implementation, I need to conditionally set `aria-invalid` to `true` only when errors exist, and conditionally add `aria-errormessage` to point to the error element's id only when that error is present—since the spec requires the referenced element to actually exist.","signature":"EvIYCkYICxgCKkCw1Ym/kXNM0AMl2NE87EP3LpQ5A5onDWIV0HG5q9rSoISBmF8G5swRBjngFeRrZ+xKmt7lzBVCQhpgXP4uu9GrEgy3pitULB2VL1IueU8aDMx1pd+sahoqIW3SYiIwWG8TlllmjChoMl2SPFdsbR59XxCZTDuu7g5DEEihZTVEJyAosSRe36F3+LgBFmrZKtkXYAKDxZmz7FB+wzr+tbUQi8TSwYd8I3RgKcKpkwdLvLzpMCZKYkMJKRvIUcZ2trMZnBZ1InvC9iVr7bpa1RfZtlhT9ZEnpBhnI1alD4I2+HCMs1jdUHa8kyhRMN6lk7jiJwEtf+/lrIbihel9R3yOVxC7FoAwWfrBK+K82e/uSHqyqoz8NlzjIq26iLUFqT2m6Xcry2lediwtX3i9Z970+R7Hhw1BpfvZqR2YUAqf1423da/URuEs7fkpVr/kPtLViCDlBFljS1iISu90p+ul+y0ltDb76inuLpipC514JgwAUhaEDgVoT7t7cuSPBoXxTJ+KL+loRhyQBVWfYbWIL5uUuEM78VW7ik/p4KIWAy2yTeHSqEJD9bvo/H8B/ieLOhruZpsrZprHuW8ley682lhaI/cKeSD3WhG4i7ICQ8LcJKvDeDlNn+Aq1wviE4f2R05dmg8kVPOfq3qRg4EYT2Ecr8NrTBgH/Mc3zIcmEZkNJOEtO+gYy10+EkC3xsgMFO523W/9K4pFzt5iHG7Lx8Q8UzobnpNHZNRDDVJkgj4HxuXqx7Jl0RLdQizOuXGQCWezPMogiJe2vea4inlC53J5kC6ye2UE/D5xWlNfmG+atmtwwjPF6aj5wozqPbSrwybEHy/afAY9LJZUiq5pnoT+1LWEHciQ7cJDF8UXy2lMsCKeFHm1MKf5QGngJj/OrPu+UWImvksmb7TMYF7Yj3OJ1DJ4j4/lbdexQK5lDcZKauAxYgEZqjkBPiCv9BqFqvrM2PZUk5uObM6XIoy8rQf0LJz/yRFNxvigtQWyGLvpQV0WQ0QrTpBfW8xrszZaF8zGGwvl32k4HeShhg5rUm+0Fo1Zx1KhLYcpHXT2U31OGPJ9SrWqfMfvde+byoQdSghUUeR/RXmw/8RkiXMMEc25Vx/uvl6kK51C+VdLnp336xrOfB83OarAsZ/0dlJBYhUjXHdJlwMw8xU3OaIBhs+JxdMHt+o5NXqH/9EleuzP5nk7yAGw44T+auXWPiLFjBhQ3I+ff1qWS61fjD1DI4u+kvghuLfli0MnjHxgMLQHGkZDGUlPo5ryIXKnYBlQI8UoYmo9NW0woR0RxwDZC3uFvXevhrTiGxYrezT4Uydu4DmR/eovEEoj6laSKxr/jRhHki+onmd5luq1gafZfw2RXPkWtTz70u6UcwZHYSw3od8LFiGoOxuU7EP72zKCOpHrm4BswWg0fpQQaUCKbMACVGRbhgZcabyuPHlsUwwDXFMnqmm5rnWRb/BcvF26z9kCBhL17BS16oycmFXhYE6vB/NgTM4sTiwXGNGVZkVAMW4DLPsbrBAPOghmat0E7dRA12rqtMiObLselWnyXflbDzuZhHnKv9hQNS4pQn0hN1q1zQoTLTamDKjO+DtzM3vLw24wK/sIcH2KEtLZNxTI9XVv3q3LRK7C8utEVpQYxgPtTcBlPa0wJHpXpU6DG97n30sUlwL3njdA90Hzj7NJlQe8gEb7uIqwgAp7wWJF/d+jTowDHXznefx8oqiCVdwWWmX/9PHoFac1QxWMikMJTkJPZjwSUoOsY5UCjx7vd0O41pllmGrLvEDaOhWjOdekXoOaP6DkShWYLnn9X9cSzx96UZ4Td4hC0bmP8oeWQDGBVom1Xvc9DixNd8jtKX0VOLbcBBUu9ZHsgbpmgNppFZ4Dj7OVCbo0pCHsqCBxz7V7r0LzBfprfBzuhT3DgY0ktQlEGUD20+1Ov6xok4YpU3E1kDcDNMaXgarhALRTgA2wkpsqZNyCxweaoXJuxXRR2QrSWirCRrYRAI59/TaNDOts5bel/DuH/kq0Fm4+jRuyT9Dwq96gwsIxZXu/ErkLQlvWAIBBeLeNYj9+7QL6XZOC7Xb+wNYFI3MZPn1pF5uB4mGcfkWiDjqTRErWeGgBqHuOdpDfD+qCxjPJ2qW4mlQrOdeN5Vki3smD0tM00p3i303KFr9KhDlFBdf2HrTGFCP/i1W55erkWt7FU9W+9x5qoGaTFLepVyZ5TnDX4kR0bTDbTCKxQTPX9F8Ub5XTQOByo54Fa+IheIvIL8VSH/mB3un0cdvOseYw0NPOuavRwENxi5JdJ+JOqt6HAYLIxdCekXb2VZb2dVS+eu5tgWZeGXz+FYB3plUmjc9OiRbOyGNIzNiwFXM9JNa/1tAfUt5wMaS0yL0tS4JPBUtdFjWCHhyldMntt7anXvucFAcYQHwNr2thwTl9zaTNxf6b8kCSVMRieiOV4HsUjNMlkxxsSyMlSQ9AbviZtBee67medrS3tyVnWacYSh0ISJ7GSDT/uI5I/3Q6gW41X7Qg0frjGqwnKfQ5r4KHBplOudHec4Cc4wFo6cSdzfrsxNzwm4YVfVZsgyGDZEQyHMRfkIQOY65RpSm7UU1ODOUKpewQJzN5mqtxtZkiBkZ5Jj4o36k3Fe5Y/Ji8x+PztoPBheSqmtToNawafXIZZIJw8ht7aigmdH5jrhs/gmVwSW1aFwfLP+Ehr/QPYsIrloVaMLB8s2xaiQe803aD+z9REBi6nEW/YUzUnLgQQiTqwQsxBZ4iqTI6zsFqAks+NPokMzgKnlDQkkP92wDf4EnnV4TJRDVTK/OsFOuLzyf5wPSZOy18bzCCwrudbB2wk07pwMgUbtghDvsoFJ4H9K3n12kRwE0Na0ud65Mt18o8jtk+kD3J+Nk8pi2M7xrBuwE/SJGbsuwnGHMqttFyiCZPDMIdecC1pwzFWKdqNKIkPqRJYInyr02+eFhOFoV8psQOgt8PlrYz//kID54EdQpaUpCkpGOXGUN0AbwHR+7XzHX533z9A3yzxRZDxl6BlqiWVoDedzPWKK7HYXDDu55Fjs4II4tYHfqxHjJGo5J0tducqgS23BDzCQQbErDrX63ke/PXuAHiM4BAHAKPJ5zS4F7HhpEohP81Hqi/BmubjFXENW1AaWkWXc+P+1cs2XTdKao3sjPA42ethXKvKzJoucgGTweTeQM9Omjn1MDu6kbJR/zGTIsRmftFbdyONfbNkPxopxcrlZa1KTrHd4E7Ikh/+r/ojpbMqSa9w+CM9tGw4BawpGMXhsd+ZpbEghNU4wKOyYCGsLHZM+8J7KQY1/sqAeiymkpl+pns/gMjc0EfbEingBDROiU9Yxv0dyFST80kR7dUhwtyi9wllwaBVdY4pNH//0VsKBflp624QBHlOad/JfLk9zxLdVPAeGFm2Q+XxNRxo3BhNX3u/pNUBBZK26BjMyq7DXdH6Ds92v6AoLT/57wW36xpo82IXQwl4I4HRhYfaHz45vkunkEjDI+S1b01Wv8VCVzhpw2W/LdugNXH+cGvEW6pTVTfpGE0+qxYF/S0t2dIXawYl5xHrfBWRIOeWgkNTj4+1jk56JJjJh9E0Rl9Yc92NGF+MGCRpznXGCPJ05/VKNcbNQwKQj17XkYAI8XLkyfjUnSeYwdybvi78Lixstbg+XZ6TSt4Tmg9My6w5KTkA48ggUEXvoOZf0E1Nb8shFg5aiQ7cuAx53eStLywvCul5UEDZXUjphT255g22ROh59Snovfk0U3ju9i2RCU3+PtzyNBWM0LOY+Aj91hFRFHZCTzMX4WGbZp/SNDe0k8WlIuLWqFu/Vm7kiirW3uqgIylcJiDrAJs+qZ7aijbG0EuQq3V4jrGEm5DFgEDSo+KUKNac3s6FvFuEWkxoKE0zoE5N9NAvSThGjQs/Du8ZM3P4FZbBXB/oRMcRYe43mqZugZQVLngZ9gPL1c1WW9dcl3hr0RXwAIJ7OLhhkToo1UqeNn7xT5ythCc2eYALiDTmIqMpFj7HpU/YlltJvS90uFM7q2Ek9hh3YNBzgcQ53aabWjuef63BLZyNLziq+Oshe7oIz2SqXnJcvLYZuOVChFTQzj2cyzTa1ipym3OU4OunKEpK4jaHPuv7mFGibP+mCCvZ2RyGVWbFVOKdT03OjwISK5BKYmlWKMt7+I2YGkQzipJWvH/+LXFz1qZeSa/tRXSwq78HkE8eSbpplhTQBwfqHiyYvbkGETQtn0vGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9854,"cache_read_input_tokens":44372,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9854},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X7waQAZEwKwwayX61s","type":"assistant","uuid":"cadafa24-1349-4827-be0e-b686d98d6d18","timestamp":"2026-02-12T16:51:15.990Z"}
{"parentUuid":"cadafa24-1349-4827-be0e-b686d98d6d18","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01CDpREPjuCSAXUpckQcSJUD","type":"message","role":"assistant","content":[{"type":"text","text":"I need to add `aria-invalid` and `aria-errormessage` to all inputs that have validation errors, and add corresponding `id`s to the error message divs. There are 7 inputs with error states.\n\nLet me make all the edits:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9854,"cache_read_input_tokens":44372,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9854},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X7waQAZEwKwwayX61s","type":"assistant","uuid":"90c803d7-e14e-4712-80cb-fd0b57c74f02","timestamp":"2026-02-12T16:51:16.160Z"}
{"type":"file-history-snapshot","messageId":"81b61634-bece-4595-85bd-51cd0f5a1919","snapshot":{"messageId":"ce862acd-c799-48a6-bb5c-0f1254c1dfc5","trackedFileBackups":{"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx":{"backupFileName":"dcea02e665f28672@v1","version":1,"backupTime":"2026-02-12T16:51:18.809Z"}},"timestamp":"2026-02-12T16:50:53.178Z"},"isSnapshotUpdate":true}
{"parentUuid":"90c803d7-e14e-4712-80cb-fd0b57c74f02","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01CDpREPjuCSAXUpckQcSJUD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LBMurT7AHWXgLsarTLXjGe","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          {...register('qid', {","new_string":"          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9854,"cache_read_input_tokens":44372,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":9854},"output_tokens":8,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X7waQAZEwKwwayX61s","type":"assistant","uuid":"81b61634-bece-4595-85bd-51cd0f5a1919","timestamp":"2026-02-12T16:51:18.804Z"}
{"parentUuid":"81b61634-bece-4595-85bd-51cd0f5a1919","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01LBMurT7AHWXgLsarTLXjGe","toolUseID":"toolu_01LBMurT7AHWXgLsarTLXjGe","timestamp":"2026-02-12T16:51:18.813Z","uuid":"5b7ef6d2-ac4d-47fa-9b34-e3505b42f9ba"}
{"parentUuid":"5b7ef6d2-ac4d-47fa-9b34-e3505b42f9ba","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01LBMurT7AHWXgLsarTLXjGe","toolUseID":"toolu_01LBMurT7AHWXgLsarTLXjGe","timestamp":"2026-02-12T16:51:18.813Z","uuid":"04ad81c0-ffc8-4cb1-a58d-7bb4b443eac1"}
{"parentUuid":"81b61634-bece-4595-85bd-51cd0f5a1919","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LBMurT7AHWXgLsarTLXjGe","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"535fde5b-63d7-47a2-9a3e-68789d5fb2a9","timestamp":"2026-02-12T16:51:18.812Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          {...register('qid', {","newString":"          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":228,"oldLines":6,"newStart":228,"newLines":8,"lines":["           className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}","           id=\"qid\"","           disabled={!canEdit}","+          aria-invalid={!!errors.qid || undefined}","+          aria-errormessage={errors.qid ? 'qid-error' : undefined}","           {...register('qid', {","             required: 'QID is required',","             validate: {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"81b61634-bece-4595-85bd-51cd0f5a1919"}
{"parentUuid":"535fde5b-63d7-47a2-9a3e-68789d5fb2a9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_016YAGBreFYBBDLVna3NmfHF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}","new_string":"        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1266,"cache_read_input_tokens":54226,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1266},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X9Wutc7k39R7FmXJ8y","type":"assistant","uuid":"e3fd92e1-11dd-4f94-9ae3-f1c9f50f76f1","timestamp":"2026-02-12T16:51:22.593Z"}
{"parentUuid":"e3fd92e1-11dd-4f94-9ae3-f1c9f50f76f1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","toolUseID":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","timestamp":"2026-02-12T16:51:22.597Z","uuid":"f3ef0991-4c79-42c3-89ba-4a4b2b6aa4cc"}
{"parentUuid":"f3ef0991-4c79-42c3-89ba-4a4b2b6aa4cc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","toolUseID":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","timestamp":"2026-02-12T16:51:22.597Z","uuid":"651a0c19-34a6-46a0-832d-64ffe75dd53f"}
{"parentUuid":"e3fd92e1-11dd-4f94-9ae3-f1c9f50f76f1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ybx44vS2NNK5bp8pmh3SNp","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"d1ca3a2b-8fd8-4e84-8eb1-ae4da746cdd4","timestamp":"2026-02-12T16:51:22.596Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}","newString":"        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":246,"oldLines":7,"newStart":246,"newLines":11,"lines":["             },","           })}","         />","-        {errors.qid && <div className=\"invalid-feedback\">{errors.qid.message}</div>}","+        {errors.qid && (","+          <div id=\"qid-error\" className=\"invalid-feedback\">","+            {errors.qid.message}","+          </div>","+        )}","         <small className=\"form-text text-muted\">","           <QuestionShortNameDescription />","         </small>"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e3fd92e1-11dd-4f94-9ae3-f1c9f50f76f1"}
{"parentUuid":"d1ca3a2b-8fd8-4e84-8eb1-ae4da746cdd4","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01QcbDA9MxKVgzUTB5cKA6en","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {","new_string":"                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":273,"cache_read_input_tokens":55492,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":273},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4X9oN6aK9ow21q78MvM","type":"assistant","uuid":"1d39db13-e8e9-459c-b8ac-a5be57fd4c45","timestamp":"2026-02-12T16:51:27.115Z"}
{"parentUuid":"1d39db13-e8e9-459c-b8ac-a5be57fd4c45","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","toolUseID":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","timestamp":"2026-02-12T16:51:27.120Z","uuid":"d7e3f45e-67b2-4487-93b1-18fa84429ca8"}
{"parentUuid":"d7e3f45e-67b2-4487-93b1-18fa84429ca8","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","toolUseID":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","timestamp":"2026-02-12T16:51:27.120Z","uuid":"51bccce3-5b46-46ce-994c-7b0eac698761"}
{"parentUuid":"1d39db13-e8e9-459c-b8ac-a5be57fd4c45","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BQ1xM6NZmVECnmUsYnxyG4","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"d175d0e0-f2bd-4579-91b0-75669b6c0676","timestamp":"2026-02-12T16:51:27.120Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {","newString":"                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":467,"oldLines":6,"newStart":467,"newLines":8,"lines":["                 className={clsx('form-control', errors.workspace_image && 'is-invalid')}","                 id=\"workspace_image\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.workspace_image || undefined}","+                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}","                 {...register('workspace_image', {","                   required: 'Image is required for workspace',","                 })}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"1d39db13-e8e9-459c-b8ac-a5be57fd4c45"}
{"parentUuid":"d175d0e0-f2bd-4579-91b0-75669b6c0676","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01VxRBpK4ApSMrBjQkG4ESYy","type":"message","role":"assistant","content":[{"type":"text","text":"Those diagnostics are pre-existing and unrelated to my changes. Continuing with the remaining edits."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":737,"cache_read_input_tokens":55765,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":737},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XA8bjk3dFxonz6jx22","type":"assistant","uuid":"e3ee50a9-6781-4d33-9269-7e84ee041d5c","timestamp":"2026-02-12T16:51:31.093Z"}
{"parentUuid":"e3ee50a9-6781-4d33-9269-7e84ee041d5c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01VxRBpK4ApSMrBjQkG4ESYy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}","new_string":"              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":737,"cache_read_input_tokens":55765,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":737},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XA8bjk3dFxonz6jx22","type":"assistant","uuid":"2897570f-f494-4012-ae7a-136a9bbc3a92","timestamp":"2026-02-12T16:51:32.630Z"}
{"parentUuid":"2897570f-f494-4012-ae7a-136a9bbc3a92","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","toolUseID":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","timestamp":"2026-02-12T16:51:32.634Z","uuid":"1ea3fae8-ebf7-4906-85e9-06dc75e6c993"}
{"parentUuid":"1ea3fae8-ebf7-4906-85e9-06dc75e6c993","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","toolUseID":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","timestamp":"2026-02-12T16:51:32.634Z","uuid":"33d3b62c-516f-4da7-aba9-312f0f889699"}
{"parentUuid":"2897570f-f494-4012-ae7a-136a9bbc3a92","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CAVZNxvUKgnAxf4ZxrPPC7","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"8d6120be-12de-44d0-a645-9a2ecbff5e94","timestamp":"2026-02-12T16:51:32.633Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}","newString":"              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":474,"oldLines":7,"newStart":474,"newLines":9,"lines":["                 })}","               />","               {errors.workspace_image && (","-                <div className=\"invalid-feedback\">{errors.workspace_image.message}</div>","+                <div id=\"workspace_image-error\" className=\"invalid-feedback\">","+                  {errors.workspace_image.message}","+                </div>","               )}","               <small className=\"form-text text-muted\">","                 The Docker image that will be used to serve this workspace. Only images from the"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"2897570f-f494-4012-ae7a-136a9bbc3a92"}
{"parentUuid":"8d6120be-12de-44d0-a645-9a2ecbff5e94","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_011qzWiyWnEZz6msfVaanVQw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012vAHqV7TDKCeg2rhYaTgCr","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {","new_string":"                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":308,"cache_read_input_tokens":56502,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":308},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XAXtTEsjgsSug4wzrB","type":"assistant","uuid":"c145316b-aa34-4ec7-a676-1a70b1e25d77","timestamp":"2026-02-12T16:51:37.578Z"}
{"parentUuid":"c145316b-aa34-4ec7-a676-1a70b1e25d77","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_012vAHqV7TDKCeg2rhYaTgCr","toolUseID":"toolu_012vAHqV7TDKCeg2rhYaTgCr","timestamp":"2026-02-12T16:51:37.583Z","uuid":"cbb62733-6874-4e97-8cf7-a9b23d17fc19"}
{"parentUuid":"cbb62733-6874-4e97-8cf7-a9b23d17fc19","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_012vAHqV7TDKCeg2rhYaTgCr","toolUseID":"toolu_012vAHqV7TDKCeg2rhYaTgCr","timestamp":"2026-02-12T16:51:37.583Z","uuid":"88e96a8f-b174-451b-a08d-e1b5350fda65"}
{"parentUuid":"c145316b-aa34-4ec7-a676-1a70b1e25d77","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012vAHqV7TDKCeg2rhYaTgCr","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"e65f94fb-9610-43a9-9119-4d8db5dd0603","timestamp":"2026-02-12T16:51:37.583Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {","newString":"                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":493,"oldLines":6,"newStart":493,"newLines":8,"lines":["                 className={clsx('form-control', errors.workspace_port && 'is-invalid')}","                 id=\"workspace_port\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.workspace_port || undefined}","+                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}","                 // Disable default behavior of incrementing/decrementing the value when scrolling","                 onWheel={(e) => e.currentTarget.blur()}","                 {...register('workspace_port', {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"c145316b-aa34-4ec7-a676-1a70b1e25d77"}
{"parentUuid":"e65f94fb-9610-43a9-9119-4d8db5dd0603","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01D2nw8mV1iwTCCxZa5U2jiq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KSUznZ32yWiNfHSTuPkXhC","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}","new_string":"              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":414,"cache_read_input_tokens":56810,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":414},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XAu8PmvvPsf2BDti7d","type":"assistant","uuid":"6e6e717a-a71d-41d4-a405-b1926cd450b9","timestamp":"2026-02-12T16:51:41.491Z"}
{"parentUuid":"6e6e717a-a71d-41d4-a405-b1926cd450b9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01KSUznZ32yWiNfHSTuPkXhC","toolUseID":"toolu_01KSUznZ32yWiNfHSTuPkXhC","timestamp":"2026-02-12T16:51:41.496Z","uuid":"623a1a4c-d8ac-4c4c-9920-805efa85f9e0"}
{"parentUuid":"623a1a4c-d8ac-4c4c-9920-805efa85f9e0","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01KSUznZ32yWiNfHSTuPkXhC","toolUseID":"toolu_01KSUznZ32yWiNfHSTuPkXhC","timestamp":"2026-02-12T16:51:41.496Z","uuid":"280e5e3d-87be-461d-b8a4-cc48f4f2407a"}
{"parentUuid":"6e6e717a-a71d-41d4-a405-b1926cd450b9","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KSUznZ32yWiNfHSTuPkXhC","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"f939e904-dae2-465b-b2b9-c23ca633c8ed","timestamp":"2026-02-12T16:51:41.496Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}","newString":"              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":502,"oldLines":7,"newStart":502,"newLines":9,"lines":["                 })}","               />","               {errors.workspace_port && (","-                <div className=\"invalid-feedback\">{errors.workspace_port.message}</div>","+                <div id=\"workspace_port-error\" className=\"invalid-feedback\">","+                  {errors.workspace_port.message}","+                </div>","               )}","               <small className=\"form-text text-muted\">","                 The port number used in the Docker image."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6e6e717a-a71d-41d4-a405-b1926cd450b9"}
{"parentUuid":"f939e904-dae2-465b-b2b9-c23ca633c8ed","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01XidxdYsuxLcdkseG35QXVf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012nHsML9NLEAJEFDyjMkpdJ","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {","new_string":"                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":396,"cache_read_input_tokens":57224,"output_tokens":286,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":396,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[]}},"requestId":"req_011CY4XBBpjdBjwDXawUuSJ3","type":"assistant","uuid":"a32fa372-f341-4d3c-a330-d63f7a1379dc","timestamp":"2026-02-12T16:51:46.313Z"}
{"parentUuid":"a32fa372-f341-4d3c-a330-d63f7a1379dc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_012nHsML9NLEAJEFDyjMkpdJ","toolUseID":"toolu_012nHsML9NLEAJEFDyjMkpdJ","timestamp":"2026-02-12T16:51:46.319Z","uuid":"9c4ba89c-a9fa-4586-80d0-1745ecd7b23b"}
{"parentUuid":"9c4ba89c-a9fa-4586-80d0-1745ecd7b23b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_012nHsML9NLEAJEFDyjMkpdJ","toolUseID":"toolu_012nHsML9NLEAJEFDyjMkpdJ","timestamp":"2026-02-12T16:51:46.319Z","uuid":"29526cae-11a1-4ecb-9b06-7dcab508db49"}
{"parentUuid":"a32fa372-f341-4d3c-a330-d63f7a1379dc","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012nHsML9NLEAJEFDyjMkpdJ","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"1559fe92-bc1e-46ad-a49a-8971996d34ce","timestamp":"2026-02-12T16:51:46.318Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {","newString":"                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":520,"oldLines":6,"newStart":520,"newLines":8,"lines":["                 className={clsx('form-control', errors.workspace_home && 'is-invalid')}","                 id=\"workspace_home\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.workspace_home || undefined}","+                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}","                 {...register('workspace_home', {","                   required: 'Home is required for workspace',","                 })}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"a32fa372-f341-4d3c-a330-d63f7a1379dc"}
{"parentUuid":"1559fe92-bc1e-46ad-a49a-8971996d34ce","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_014q4XSkQvVgwJJWLm29reGb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016c4PmVsYeBvjK4daHS3B8v","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}","new_string":"              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":344,"cache_read_input_tokens":57620,"output_tokens":227,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":344,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[]}},"requestId":"req_011CY4XBYo3xYVcDpys5xX1e","type":"assistant","uuid":"de0d09f5-44e4-454c-a4d9-467496f6904f","timestamp":"2026-02-12T16:51:50.449Z"}
{"parentUuid":"de0d09f5-44e4-454c-a4d9-467496f6904f","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_016c4PmVsYeBvjK4daHS3B8v","toolUseID":"toolu_016c4PmVsYeBvjK4daHS3B8v","timestamp":"2026-02-12T16:51:50.457Z","uuid":"3275cfd5-d626-40f0-97ac-c3321f343d9b"}
{"parentUuid":"3275cfd5-d626-40f0-97ac-c3321f343d9b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_016c4PmVsYeBvjK4daHS3B8v","toolUseID":"toolu_016c4PmVsYeBvjK4daHS3B8v","timestamp":"2026-02-12T16:51:50.457Z","uuid":"72bdfcd7-4a9a-4998-94ed-8be37036a230"}
{"parentUuid":"de0d09f5-44e4-454c-a4d9-467496f6904f","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016c4PmVsYeBvjK4daHS3B8v","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"92753f49-1222-4335-9f82-8c9a5345092b","timestamp":"2026-02-12T16:51:50.457Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}","newString":"              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":527,"oldLines":7,"newStart":527,"newLines":9,"lines":["                 })}","               />","               {errors.workspace_home && (","-                <div className=\"invalid-feedback\">{errors.workspace_home.message}</div>","+                <div id=\"workspace_home-error\" className=\"invalid-feedback\">","+                  {errors.workspace_home.message}","+                </div>","               )}","               <small className=\"form-text text-muted\">","                 The home directory of the workspace container."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"de0d09f5-44e4-454c-a4d9-467496f6904f"}
{"parentUuid":"92753f49-1222-4335-9f82-8c9a5345092b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01BFRKVkPadmx21ECTyDJE54","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EJE5yrpMF7iTzt21kT64rJ","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {","new_string":"              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":285,"cache_read_input_tokens":57964,"output_tokens":299,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":285,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[]}},"requestId":"req_011CY4XBr7r1DQzhuR11VEg8","type":"assistant","uuid":"256c11e2-2860-407c-a2f1-49faa5d7bf90","timestamp":"2026-02-12T16:51:55.314Z"}
{"parentUuid":"256c11e2-2860-407c-a2f1-49faa5d7bf90","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01EJE5yrpMF7iTzt21kT64rJ","toolUseID":"toolu_01EJE5yrpMF7iTzt21kT64rJ","timestamp":"2026-02-12T16:51:55.323Z","uuid":"b2c98c76-8f5a-4a13-aaa6-bd1152dd60f2"}
{"parentUuid":"b2c98c76-8f5a-4a13-aaa6-bd1152dd60f2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01EJE5yrpMF7iTzt21kT64rJ","toolUseID":"toolu_01EJE5yrpMF7iTzt21kT64rJ","timestamp":"2026-02-12T16:51:55.323Z","uuid":"f5278f93-7db6-4b0d-8028-1a472b7da44c"}
{"parentUuid":"256c11e2-2860-407c-a2f1-49faa5d7bf90","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EJE5yrpMF7iTzt21kT64rJ","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"61684b9c-920b-4edc-8102-a07821f8b636","timestamp":"2026-02-12T16:51:55.323Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {","newString":"              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":580,"oldLines":6,"newStart":580,"newLines":10,"lines":["                 className={clsx('form-control', errors.workspace_environment && 'is-invalid')}","                 id=\"workspace_environment\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.workspace_environment || undefined}","+                aria-errormessage={","+                  errors.workspace_environment ? 'workspace_environment-error' : undefined","+                }","                 {...register('workspace_environment', {","                   validate: validateJson,","                 })}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"256c11e2-2860-407c-a2f1-49faa5d7bf90"}
{"parentUuid":"61684b9c-920b-4edc-8102-a07821f8b636","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01QobK8ajCMT3p6Py2JviqB5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CTaWxoJLxboDbGSXeZUyWA","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}","new_string":"              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":357,"cache_read_input_tokens":58249,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":357},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XCDGpteUFqJHq3zGRb","type":"assistant","uuid":"e2e95f1a-46b5-4282-8e95-11da5c5e76b2","timestamp":"2026-02-12T16:51:59.178Z"}
{"parentUuid":"e2e95f1a-46b5-4282-8e95-11da5c5e76b2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01CTaWxoJLxboDbGSXeZUyWA","toolUseID":"toolu_01CTaWxoJLxboDbGSXeZUyWA","timestamp":"2026-02-12T16:51:59.188Z","uuid":"4ba809f5-dd4f-4c25-931f-a9f3a6ec8316"}
{"parentUuid":"4ba809f5-dd4f-4c25-931f-a9f3a6ec8316","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01CTaWxoJLxboDbGSXeZUyWA","toolUseID":"toolu_01CTaWxoJLxboDbGSXeZUyWA","timestamp":"2026-02-12T16:51:59.188Z","uuid":"61fdaa2b-8a46-47d8-ae87-fc2b6b9baa64"}
{"parentUuid":"e2e95f1a-46b5-4282-8e95-11da5c5e76b2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CTaWxoJLxboDbGSXeZUyWA","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"2a2b2a29-0d58-4798-bab3-9d93e7da6508","timestamp":"2026-02-12T16:51:59.187Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}","newString":"              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":589,"oldLines":7,"newStart":589,"newLines":9,"lines":["                 })}","               />","               {errors.workspace_environment && (","-                <div className=\"invalid-feedback\">{errors.workspace_environment.message}</div>","+                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">","+                  {errors.workspace_environment.message}","+                </div>","               )}","               <small className=\"form-text text-muted\">","                 Environment variables to set inside the workspace container. Variables must be"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e2e95f1a-46b5-4282-8e95-11da5c5e76b2"}
{"parentUuid":"2a2b2a29-0d58-4798-bab3-9d93e7da6508","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01XXdBkZR3qNT5dhnzT3R5n5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KswVMugLZdRsZWtTJ5g1YP","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {","new_string":"                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":285,"cache_read_input_tokens":58606,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":285},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XCVVtasepxnX19s7qP","type":"assistant","uuid":"e79627d9-32c9-4591-a1ad-64a8a6a6dcbd","timestamp":"2026-02-12T16:52:04.128Z"}
{"parentUuid":"e79627d9-32c9-4591-a1ad-64a8a6a6dcbd","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01KswVMugLZdRsZWtTJ5g1YP","toolUseID":"toolu_01KswVMugLZdRsZWtTJ5g1YP","timestamp":"2026-02-12T16:52:04.134Z","uuid":"c2eeb94d-ba7e-4c2d-9360-2fc1a034432c"}
{"parentUuid":"c2eeb94d-ba7e-4c2d-9360-2fc1a034432c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01KswVMugLZdRsZWtTJ5g1YP","toolUseID":"toolu_01KswVMugLZdRsZWtTJ5g1YP","timestamp":"2026-02-12T16:52:04.134Z","uuid":"b88e748f-2d35-4f4f-8cf7-3ff8a0861425"}
{"parentUuid":"e79627d9-32c9-4591-a1ad-64a8a6a6dcbd","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KswVMugLZdRsZWtTJ5g1YP","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"1ce3eb8a-90cf-4547-8662-5ceb6e2b325d","timestamp":"2026-02-12T16:52:04.133Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {","newString":"                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":678,"oldLines":6,"newStart":678,"newLines":10,"lines":["                 className={clsx('form-control', errors.external_grading_image && 'is-invalid')}","                 id=\"external_grading_image\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.external_grading_image || undefined}","+                aria-errormessage={","+                  errors.external_grading_image ? 'external_grading_image-error' : undefined","+                }","                 {...register('external_grading_image', {","                   required: externalGradingEnabled && 'Image is required for external grading',","                 })}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e79627d9-32c9-4591-a1ad-64a8a6a6dcbd"}
{"parentUuid":"1ce3eb8a-90cf-4547-8662-5ceb6e2b325d","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01PrVmpgkBrkyB2d7DbypL58","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015VhkhP5vYg8TNoyRjKsfdV","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}","new_string":"              {errors.external_grading_image && (\n                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_image.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":376,"cache_read_input_tokens":58891,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":376},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XCs5Rg6giAgNhNA21p","type":"assistant","uuid":"ecfd5b15-ddc3-4ad8-b6a0-bd9c6c515e0c","timestamp":"2026-02-12T16:52:08.022Z"}
{"parentUuid":"ecfd5b15-ddc3-4ad8-b6a0-bd9c6c515e0c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_015VhkhP5vYg8TNoyRjKsfdV","toolUseID":"toolu_015VhkhP5vYg8TNoyRjKsfdV","timestamp":"2026-02-12T16:52:08.027Z","uuid":"cb6b1979-8e25-4585-8ac2-c31f50389441"}
{"parentUuid":"cb6b1979-8e25-4585-8ac2-c31f50389441","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_015VhkhP5vYg8TNoyRjKsfdV","toolUseID":"toolu_015VhkhP5vYg8TNoyRjKsfdV","timestamp":"2026-02-12T16:52:08.027Z","uuid":"2067ccd0-8f68-4aa9-927f-9c21c88f65d3"}
{"parentUuid":"ecfd5b15-ddc3-4ad8-b6a0-bd9c6c515e0c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015VhkhP5vYg8TNoyRjKsfdV","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"cf0ef489-a566-47be-9e00-3bd00ae1ef02","timestamp":"2026-02-12T16:52:08.027Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}","newString":"              {errors.external_grading_image && (\n                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_image.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":687,"oldLines":7,"newStart":687,"newLines":9,"lines":["                 })}","               />","               {errors.external_grading_image && (","-                <div className=\"invalid-feedback\">{errors.external_grading_image.message}</div>","+                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">","+                  {errors.external_grading_image.message}","+                </div>","               )}","               <small className=\"form-text text-muted\">","                 The Docker image that will be used to grade this question. Only images from the"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"ecfd5b15-ddc3-4ad8-b6a0-bd9c6c515e0c"}
{"parentUuid":"cf0ef489-a566-47be-9e00-3bd00ae1ef02","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01FdDf2EkQgtM3ijexNntLE9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {","new_string":"              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_environment || undefined}\n                aria-errormessage={\n                  errors.external_grading_environment\n                    ? 'external_grading_environment-error'\n                    : undefined\n                }\n                {...register('external_grading_environment', {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":300,"cache_read_input_tokens":59267,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":300},"output_tokens":24,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XD9DHPHqwb5hgkZw5u","type":"assistant","uuid":"537285ed-88f8-43c2-8281-13f1e03038a1","timestamp":"2026-02-12T16:52:13.017Z"}
{"parentUuid":"537285ed-88f8-43c2-8281-13f1e03038a1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","toolUseID":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","timestamp":"2026-02-12T16:52:13.023Z","uuid":"ebe32c15-3017-4103-9b77-2acc412dca73"}
{"parentUuid":"ebe32c15-3017-4103-9b77-2acc412dca73","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","toolUseID":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","timestamp":"2026-02-12T16:52:13.023Z","uuid":"054b9f74-8866-476d-b874-c3fe1390dc33"}
{"parentUuid":"537285ed-88f8-43c2-8281-13f1e03038a1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VrrdwSMJ6zGPWzfFYD5KNQ","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"47b4b898-83b4-47cd-9d96-b89c2b29aa46","timestamp":"2026-02-12T16:52:13.022Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {","newString":"              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_environment || undefined}\n                aria-errormessage={\n                  errors.external_grading_environment\n                    ? 'external_grading_environment-error'\n                    : undefined\n                }\n                {...register('external_grading_environment', {","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":762,"oldLines":6,"newStart":762,"newLines":12,"lines":["                 )}","                 id=\"external_grading_environment\"","                 disabled={!canEdit}","+                aria-invalid={!!errors.external_grading_environment || undefined}","+                aria-errormessage={","+                  errors.external_grading_environment","+                    ? 'external_grading_environment-error'","+                    : undefined","+                }","                 {...register('external_grading_environment', {","                   validate: validateJson,","                 })}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"537285ed-88f8-43c2-8281-13f1e03038a1"}
{"parentUuid":"47b4b898-83b4-47cd-9d96-b89c2b29aa46","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_0146WDibDpLWWeBJEtybKuPr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QTvwc33t4k8szNH1EEsrou","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","old_string":"              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}","new_string":"              {errors.external_grading_environment && (\n                <div id=\"external_grading_environment-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":408,"cache_read_input_tokens":59567,"output_tokens":248,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":408,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[]}},"requestId":"req_011CY4XDWwVKt7rJGCiriCSj","type":"assistant","uuid":"46e89839-4b04-4004-a7b7-65974972ebc6","timestamp":"2026-02-12T16:52:16.886Z"}
{"parentUuid":"46e89839-4b04-4004-a7b7-65974972ebc6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01QTvwc33t4k8szNH1EEsrou","toolUseID":"toolu_01QTvwc33t4k8szNH1EEsrou","timestamp":"2026-02-12T16:52:16.893Z","uuid":"949fa594-37c6-4775-80d3-dbe9e4c3d207"}
{"parentUuid":"949fa594-37c6-4775-80d3-dbe9e4c3d207","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01QTvwc33t4k8szNH1EEsrou","toolUseID":"toolu_01QTvwc33t4k8szNH1EEsrou","timestamp":"2026-02-12T16:52:16.893Z","uuid":"e08b415b-00d6-4758-92a8-1ba7f8966dc4"}
{"parentUuid":"46e89839-4b04-4004-a7b7-65974972ebc6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QTvwc33t4k8szNH1EEsrou","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx has been updated successfully."}]},"uuid":"9366b877-b01f-435f-a954-45a0a1d7e544","timestamp":"2026-02-12T16:52:16.892Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","oldString":"              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}","newString":"              {errors.external_grading_environment && (\n                <div id=\"external_grading_environment-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}","originalFile":"import clsx from 'clsx';\nimport { useMemo } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { ComboBox, type ComboBoxItem, TagPicker } from '@prairielearn/ui';\n\nimport { QuestionShortNameDescription } from '../../../components/ShortNameDescriptions.js';\nimport { TagBadge } from '../../../components/TagBadge.js';\nimport { TagDescription } from '../../../components/TagDescription.js';\nimport { TopicBadge } from '../../../components/TopicBadge.js';\nimport { TopicDescription } from '../../../components/TopicDescription.js';\nimport type {\n  StaffCourseInstance,\n  StaffQuestion,\n  StaffTag,\n  StaffTopic,\n} from '../../../lib/client/safe-db-types.js';\nimport { idsEqual } from '../../../lib/id.js';\nimport { validateShortName } from '../../../lib/short-name.js';\nimport type { SelectedAssessments } from '../instructorQuestionSettings.types.js';\n\nfunction AssessmentBadges({\n  assessmentsWithQuestion,\n  courseInstanceId,\n}: {\n  assessmentsWithQuestion: SelectedAssessments[];\n  courseInstanceId: string;\n}) {\n  const assessmentsInCourseInstance = assessmentsWithQuestion.find((a) =>\n    idsEqual(a.course_instance_id, courseInstanceId),\n  );\n\n  if (\n    !assessmentsInCourseInstance?.assessments ||\n    assessmentsInCourseInstance.assessments.length === 0\n  ) {\n    return (\n      <small className=\"text-muted text-center\">\n        This question is not included in any assessments in this course instance.\n      </small>\n    );\n  }\n\n  return (\n    <div className=\"d-flex flex-wrap gap-1\">\n      {assessmentsInCourseInstance.assessments.map((assessment) => (\n        <a\n          key={assessment.assessment_id}\n          href={`/pl/course_instance/${assessmentsInCourseInstance.course_instance_id}/instructor/assessment/${assessment.assessment_id}`}\n          className={`btn btn-badge color-${assessment.color}`}\n        >\n          {assessment.label}\n        </a>\n      ))}\n    </div>\n  );\n}\n\ninterface QuestionSettingsFormValues {\n  qid: string;\n  title: string;\n  topic: string;\n  tags: string[];\n  grading_method: 'Internal' | 'External' | 'Manual';\n  single_variant: boolean;\n  show_correct_answer: boolean;\n  workspace_enabled: boolean;\n  workspace_image: string;\n  workspace_port: string;\n  workspace_home: string;\n  workspace_graded_files: string;\n  workspace_args: string;\n  workspace_environment: string;\n  workspace_enable_networking: boolean;\n  workspace_rewrite_url: boolean;\n  external_grading_enabled: boolean;\n  external_grading_image: string;\n  external_grading_entrypoint: string;\n  external_grading_files: string;\n  external_grading_timeout: string;\n  external_grading_enable_networking: boolean;\n  external_grading_environment: string;\n}\n\nexport function validateJson(value: string): string | true {\n  if (!value || value.trim() === '' || value.trim() === '{}') return true;\n  try {\n    const parsed = JSON.parse(value);\n    if (typeof parsed !== 'object' || Array.isArray(parsed)) {\n      return 'Must be a valid JSON object';\n    }\n    return true;\n  } catch {\n    return 'Invalid JSON format';\n  }\n}\n\nexport const QuestionSettingsForm = ({\n  question,\n  topic,\n  courseInstance,\n  assessmentsWithQuestion,\n  courseTopics,\n  courseTags,\n  questionTags,\n  qids,\n  origHash,\n  csrfToken,\n  canEdit,\n}: {\n  question: StaffQuestion;\n  courseInstance?: StaffCourseInstance | null;\n  assessmentsWithQuestion: SelectedAssessments[];\n  topic: StaffTopic;\n  courseTopics: StaffTopic[];\n  courseTags: StaffTag[];\n  questionTags: StaffTag[];\n  qids: string[];\n  origHash: string;\n  csrfToken: string;\n  canEdit: boolean;\n}) => {\n  const defaultValues: QuestionSettingsFormValues = {\n    qid: question.qid ?? '',\n    title: question.title ?? '',\n    topic: topic.name,\n    tags: questionTags.map((t) => t.name),\n    grading_method: question.grading_method,\n    single_variant: question.single_variant ?? false,\n    show_correct_answer: question.show_correct_answer ?? true,\n    workspace_enabled: !!question.workspace_image,\n    workspace_image: question.workspace_image ?? '',\n    workspace_port: question.workspace_port?.toString() ?? '',\n    workspace_home: question.workspace_home ?? '',\n    workspace_graded_files: question.workspace_graded_files?.join(', ') ?? '',\n    workspace_args: question.workspace_args ?? '',\n    workspace_environment:\n      Object.keys(question.workspace_environment ?? {}).length > 0\n        ? JSON.stringify(question.workspace_environment, null, 2)\n        : '{}',\n    workspace_enable_networking: question.workspace_enable_networking ?? false,\n    workspace_rewrite_url: question.workspace_url_rewrite ?? true,\n    external_grading_enabled: !!question.external_grading_image,\n    external_grading_image: question.external_grading_image ?? '',\n    external_grading_entrypoint: question.external_grading_entrypoint ?? '',\n    external_grading_files: question.external_grading_files?.join(', ') ?? '',\n    external_grading_timeout: question.external_grading_timeout?.toString() ?? '',\n    external_grading_enable_networking: question.external_grading_enable_networking ?? false,\n    external_grading_environment:\n      Object.keys(question.external_grading_environment).length > 0\n        ? JSON.stringify(question.external_grading_environment, null, 2)\n        : '{}',\n  };\n\n  const {\n    register,\n    watch,\n    setValue,\n    trigger,\n    clearErrors,\n    formState: { errors, isDirty },\n  } = useForm<QuestionSettingsFormValues>({\n    mode: 'onChange',\n    defaultValues,\n  });\n\n  const selectedTopic = watch('topic');\n  const selectedTags = watch('tags');\n  const selectedGradingMethod = watch('grading_method');\n  const workspaceEnabled = watch('workspace_enabled');\n  const externalGradingEnabled = watch('external_grading_enabled');\n\n  const isExternalGrading = selectedGradingMethod === 'External';\n\n  const topicItems: ComboBoxItem<StaffTopic>[] = useMemo(\n    () =>\n      courseTopics.map((t) => ({\n        id: t.name,\n        data: t,\n        label: t.name,\n        searchableText: `${t.name} ${t.description}`,\n      })),\n    [courseTopics],\n  );\n\n  const tagItems: ComboBoxItem<StaffTag>[] = useMemo(\n    () =>\n      [...courseTags]\n        .sort((a, b) => {\n          // Sort explicit tags above implicit tags, then by name\n          if (a.implicit !== b.implicit) {\n            return a.implicit ? 1 : -1;\n          }\n          return a.name.localeCompare(b.name);\n        })\n        .map((t) => ({\n          id: t.name,\n          data: t,\n          label: t.name,\n          searchableText: `${t.name} ${t.description}`,\n        })),\n    [courseTags],\n  );\n\n  const currentTopicData = courseTopics.find((t) => t.name === selectedTopic);\n  const currentTagsData = courseTags.filter((t) => selectedTags.includes(t.name));\n\n  const otherQids = new Set(qids.filter((q) => q !== defaultValues.qid));\n\n  const handleFormSubmit = async (e: React.SubmitEvent<HTMLFormElement>) => {\n    const isValid = await trigger();\n    if (!isValid) {\n      e.preventDefault();\n    }\n  };\n\n  return (\n    <form name=\"edit-question-settings-form\" method=\"POST\" onSubmit={handleFormSubmit}>\n      <input type=\"hidden\" name=\"__csrf_token\" value={csrfToken} />\n      <input type=\"hidden\" name=\"orig_hash\" value={origHash} />\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"qid\">\n          QID\n        </label>\n        <input\n          type=\"text\"\n          className={clsx('form-control font-monospace', errors.qid && 'is-invalid')}\n          id=\"qid\"\n          disabled={!canEdit}\n          aria-invalid={!!errors.qid || undefined}\n          aria-errormessage={errors.qid ? 'qid-error' : undefined}\n          {...register('qid', {\n            required: 'QID is required',\n            validate: {\n              shortName: (value) => {\n                const result = validateShortName(value, defaultValues.qid);\n                return result.valid || result.message;\n              },\n              duplicate: (value) => {\n                if (otherQids.has(value)) {\n                  return 'This QID is already in use';\n                }\n                return true;\n              },\n            },\n          })}\n        />\n        {errors.qid && (\n          <div id=\"qid-error\" className=\"invalid-feedback\">\n            {errors.qid.message}\n          </div>\n        )}\n        <small className=\"form-text text-muted\">\n          <QuestionShortNameDescription />\n        </small>\n      </div>\n\n      <div className=\"mb-3\">\n        <h2 className=\"h4\">General</h2>\n        <label className=\"form-label\" htmlFor=\"title\">\n          Title\n        </label>\n        <input\n          type=\"text\"\n          className=\"form-control\"\n          id=\"title\"\n          disabled={!canEdit}\n          {...register('title')}\n        />\n        <small className=\"form-text text-muted\">\n          The title of the question (e.g., \"Add two numbers\").\n        </small>\n      </div>\n\n      <div className=\"table-responsive card mb-3 overflow-visible\">\n        <table\n          className=\"table two-column-description\"\n          aria-label=\"Question topic, tags, and assessments\"\n        >\n          <tbody>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"topic-label\" htmlFor=\"topic\">\n                  Topic\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <ComboBox\n                    id=\"topic\"\n                    name=\"topic\"\n                    items={topicItems}\n                    value={selectedTopic}\n                    placeholder=\"Select a topic\"\n                    aria-labelledby=\"topic-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TopicBadge topic={item.data!} />\n                        {item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TopicDescription topic={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    onChange={(value) => setValue('topic', value ?? '', { shouldDirty: true })}\n                  />\n                ) : currentTopicData ? (\n                  <TopicBadge topic={currentTopicData} />\n                ) : null}\n              </td>\n            </tr>\n            <tr>\n              <th className=\"align-middle\">\n                <label id=\"tags-label\" htmlFor=\"tags\">\n                  Tags\n                </label>\n              </th>\n              <td>\n                {canEdit ? (\n                  <TagPicker\n                    id=\"tags\"\n                    name=\"tags\"\n                    items={tagItems}\n                    value={selectedTags}\n                    placeholder=\"Select tags\"\n                    aria-labelledby=\"tags-label\"\n                    renderItem={(item) => (\n                      <div style={{ whiteSpace: 'normal' }}>\n                        <TagBadge tag={item.data!} />\n                        {!item.data!.implicit && item.data!.description && (\n                          <div>\n                            <small className=\"text-muted\">\n                              <TagDescription tag={item.data!} />\n                            </small>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                    renderTagContent={(data) => data.name}\n                    tagClassName={(data) => `badge color-${data.color}`}\n                    onChange={(value) => setValue('tags', value, { shouldDirty: true })}\n                  />\n                ) : (\n                  currentTagsData.map((tag) => (\n                    <span key={tag.name} className=\"me-1\">\n                      <TagBadge tag={tag} />\n                    </span>\n                  ))\n                )}\n              </td>\n            </tr>\n            {courseInstance && (\n              <tr>\n                <th className=\"align-middle\">Assessments</th>\n                <td>\n                  <AssessmentBadges\n                    assessmentsWithQuestion={assessmentsWithQuestion}\n                    courseInstanceId={courseInstance.id}\n                  />\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"mb-3\">\n        <label className=\"form-label\" htmlFor=\"grading_method\">\n          Grading method\n        </label>\n        <select\n          className=\"form-select\"\n          id=\"grading_method\"\n          disabled={!canEdit}\n          {...register('grading_method', {\n            onChange: (e) => {\n              if (e.target.value === 'External') {\n                setValue('external_grading_enabled', true, { shouldDirty: true });\n              }\n            },\n          })}\n        >\n          <option value=\"Internal\">Internal</option>\n          <option value=\"External\">External</option>\n          <option value=\"Manual\">Manual</option>\n        </select>\n        <small className=\"form-text text-muted\">The grading method used for this question.</small>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"single_variant\"\n          disabled={!canEdit}\n          {...register('single_variant')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"single_variant\">\n          Single variant\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, students will only be able to try a single variant of this question on any\n          given assessment.\n        </div>\n      </div>\n\n      <div className=\"mb-3 form-check\">\n        <input\n          className=\"form-check-input\"\n          type=\"checkbox\"\n          id=\"show_correct_answer\"\n          disabled={!canEdit}\n          {...register('show_correct_answer')}\n        />\n        <label className=\"form-check-label\" htmlFor=\"show_correct_answer\">\n          Show correct answer\n        </label>\n        <div className=\"small text-muted\">\n          If enabled, the correct answer panel will be shown after all submission attempts have been\n          exhausted.\n        </div>\n      </div>\n\n      <div className=\"mb-3\">\n        <div className=\"form-check\">\n          <input\n            className=\"form-check-input\"\n            type=\"checkbox\"\n            id=\"workspaceEnabled\"\n            checked={workspaceEnabled}\n            disabled={!canEdit}\n            onChange={() => {\n              if (workspaceEnabled) {\n                clearErrors([\n                  'workspace_image',\n                  'workspace_port',\n                  'workspace_home',\n                  'workspace_environment',\n                ]);\n              }\n              setValue('workspace_enabled', !workspaceEnabled, { shouldDirty: true });\n            }}\n          />\n          <label className=\"form-check-label h4 mb-0\" htmlFor=\"workspaceEnabled\">\n            Workspace\n          </label>\n        </div>\n        <small className=\"text-muted ps-4\">\n          Configure a{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/workspaces/\">\n            remote development environment\n          </a>{' '}\n          for students.\n        </small>\n        {workspaceEnabled && (\n          <div className=\"mt-3 ps-4\" id=\"workspace-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_image && 'is-invalid')}\n                id=\"workspace_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_image || undefined}\n                aria-errormessage={errors.workspace_image ? 'workspace_image-error' : undefined}\n                {...register('workspace_image', {\n                  required: 'Image is required for workspace',\n                })}\n              />\n              {errors.workspace_image && (\n                <div id=\"workspace_image-error\" className=\"invalid-feedback\">\n                  {errors.workspace_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to serve this workspace. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_port\">\n                Port\n              </label>\n              <input\n                type=\"number\"\n                className={clsx('form-control', errors.workspace_port && 'is-invalid')}\n                id=\"workspace_port\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_port || undefined}\n                aria-errormessage={errors.workspace_port ? 'workspace_port-error' : undefined}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('workspace_port', {\n                  required: 'Port is required for workspace',\n                })}\n              />\n              {errors.workspace_port && (\n                <div id=\"workspace_port-error\" className=\"invalid-feedback\">\n                  {errors.workspace_port.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The port number used in the Docker image.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_home\">\n                Home\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.workspace_home && 'is-invalid')}\n                id=\"workspace_home\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_home || undefined}\n                aria-errormessage={errors.workspace_home ? 'workspace_home-error' : undefined}\n                {...register('workspace_home', {\n                  required: 'Home is required for workspace',\n                })}\n              />\n              {errors.workspace_home && (\n                <div id=\"workspace_home-error\" className=\"invalid-feedback\">\n                  {errors.workspace_home.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The home directory of the workspace container.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_graded_files\">\n                Graded files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_graded_files\"\n                disabled={!canEdit}\n                {...register('workspace_graded_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied out of the workspace container\n                when saving a submission. You may enter multiple files or directories, separated by\n                commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_args\">\n                Arguments\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"workspace_args\"\n                disabled={!canEdit}\n                {...register('workspace_args')}\n              />\n              <small className=\"form-text text-muted\">\n                Command line arguments to pass to the Docker container. Multiple arguments should be\n                separated by spaces and escaped as necessary using the same format as a typical\n                shell.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"workspace_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx('form-control', errors.workspace_environment && 'is-invalid')}\n                id=\"workspace_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.workspace_environment || undefined}\n                aria-errormessage={\n                  errors.workspace_environment ? 'workspace_environment-error' : undefined\n                }\n                {...register('workspace_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.workspace_environment && (\n                <div id=\"workspace_environment-error\" className=\"invalid-feedback\">\n                  {errors.workspace_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the workspace container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_enable_networking\"\n                disabled={!canEdit}\n                {...register('workspace_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the workspace should have network access. Access is disabled by default.\n              </div>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"workspace_rewrite_url\"\n                disabled={!canEdit}\n                {...register('workspace_rewrite_url')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"workspace_rewrite_url\">\n                Rewrite URL\n              </label>\n              <div className=\"small text-muted\">\n                If enabled, the URL will be rewritten such that the workspace container will see all\n                requests as originating from \"/\".\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"mb-3\">\n        {isExternalGrading ? (\n          <h4 className=\"mb-0\">External grading</h4>\n        ) : (\n          <div className=\"form-check\">\n            <input\n              className=\"form-check-input\"\n              type=\"checkbox\"\n              id=\"externalGradingEnabled\"\n              checked={externalGradingEnabled}\n              disabled={!canEdit}\n              onChange={() => {\n                if (externalGradingEnabled) {\n                  clearErrors(['external_grading_image', 'external_grading_environment']);\n                }\n                setValue('external_grading_enabled', !externalGradingEnabled, {\n                  shouldDirty: true,\n                });\n              }}\n            />\n            <label className=\"form-check-label h4 mb-0\" htmlFor=\"externalGradingEnabled\">\n              External grading\n            </label>\n          </div>\n        )}\n        <small className={clsx('text-muted', !isExternalGrading && 'ps-4')}>\n          Configure{' '}\n          <a href=\"https://prairielearn.readthedocs.io/en/latest/externalGrading/\">\n            grading using a Docker container\n          </a>\n          .\n        </small>\n        {(isExternalGrading || externalGradingEnabled) && (\n          <div className={clsx('mt-3', !isExternalGrading && 'ps-4')} id=\"external-grading-options\">\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_image\">\n                Image\n              </label>\n              <input\n                type=\"text\"\n                className={clsx('form-control', errors.external_grading_image && 'is-invalid')}\n                id=\"external_grading_image\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_image || undefined}\n                aria-errormessage={\n                  errors.external_grading_image ? 'external_grading_image-error' : undefined\n                }\n                {...register('external_grading_image', {\n                  required: externalGradingEnabled && 'Image is required for external grading',\n                })}\n              />\n              {errors.external_grading_image && (\n                <div id=\"external_grading_image-error\" className=\"invalid-feedback\">\n                  {errors.external_grading_image.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                The Docker image that will be used to grade this question. Only images from the\n                Dockerhub registry are supported.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_entrypoint\">\n                Entrypoint\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_entrypoint\"\n                disabled={!canEdit}\n                {...register('external_grading_entrypoint')}\n              />\n              <small className=\"form-text text-muted\">\n                Program or command to run as the entrypoint to your grader. If not provided, the\n                default entrypoint for the image will be used.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_files\">\n                Server files\n              </label>\n              <input\n                type=\"text\"\n                className=\"form-control\"\n                id=\"external_grading_files\"\n                disabled={!canEdit}\n                {...register('external_grading_files')}\n              />\n              <small className=\"form-text text-muted\">\n                The list of files or directories that will be copied from{' '}\n                <code>course/serverFilesCourse</code> into the grading job. You may enter multiple\n                files or directories, separated by commas.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_timeout\">\n                Timeout\n              </label>\n              <input\n                type=\"number\"\n                className=\"form-control\"\n                id=\"external_grading_timeout\"\n                min=\"0\"\n                disabled={!canEdit}\n                // Disable default behavior of incrementing/decrementing the value when scrolling\n                onWheel={(e) => e.currentTarget.blur()}\n                {...register('external_grading_timeout')}\n              />\n              <small className=\"form-text text-muted\">\n                The number of seconds after which the grading job will timeout.\n              </small>\n            </div>\n\n            <div className=\"mb-3\">\n              <label className=\"form-label\" htmlFor=\"external_grading_environment\">\n                Environment\n              </label>\n              <textarea\n                className={clsx(\n                  'form-control',\n                  errors.external_grading_environment && 'is-invalid',\n                )}\n                id=\"external_grading_environment\"\n                disabled={!canEdit}\n                aria-invalid={!!errors.external_grading_environment || undefined}\n                aria-errormessage={\n                  errors.external_grading_environment\n                    ? 'external_grading_environment-error'\n                    : undefined\n                }\n                {...register('external_grading_environment', {\n                  validate: validateJson,\n                })}\n              />\n              {errors.external_grading_environment && (\n                <div className=\"invalid-feedback\">\n                  {errors.external_grading_environment.message}\n                </div>\n              )}\n              <small className=\"form-text text-muted\">\n                Environment variables to set inside the grading container. Variables must be\n                specified as a JSON object (e.g. <code>{'{\"key\":\"value\"}'}</code>).\n              </small>\n            </div>\n\n            <div className=\"mb-3 form-check\">\n              <input\n                className=\"form-check-input\"\n                type=\"checkbox\"\n                id=\"external_grading_enable_networking\"\n                disabled={!canEdit}\n                {...register('external_grading_enable_networking')}\n              />\n              <label className=\"form-check-label\" htmlFor=\"external_grading_enable_networking\">\n                Enable networking\n              </label>\n              <div className=\"small text-muted\">\n                Whether the grading containers should have network access. Access is disabled by\n                default.\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {canEdit && (\n        <>\n          <button\n            id=\"save-button\"\n            type=\"submit\"\n            className=\"btn btn-primary mb-2\"\n            name=\"__action\"\n            value=\"update_question\"\n            disabled={!isDirty}\n          >\n            Save\n          </button>\n          <button\n            type=\"button\"\n            className=\"btn btn-secondary mb-2 ms-2\"\n            onClick={() => window.location.reload()}\n          >\n            Cancel\n          </button>\n        </>\n      )}\n    </form>\n  );\n};\n\nQuestionSettingsForm.displayName = 'QuestionSettingsForm';\n","structuredPatch":[{"oldStart":773,"oldLines":7,"newStart":773,"newLines":7,"lines":["                 })}","               />","               {errors.external_grading_environment && (","-                <div className=\"invalid-feedback\">","+                <div id=\"external_grading_environment-error\" className=\"invalid-feedback\">","                   {errors.external_grading_environment.message}","                 </div>","               )}"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"46e89839-4b04-4004-a7b7-65974972ebc6"}
{"parentUuid":"9366b877-b01f-435f-a954-45a0a1d7e544","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_016Ndcma3fEvC8pkT7K1w4yb","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me typecheck and format the file."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":306,"cache_read_input_tokens":59975,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":306},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XDoG1WZpyRCG5CC6ca","type":"assistant","uuid":"a16083db-130b-4464-87d8-bb0d6f4a64d2","timestamp":"2026-02-12T16:52:19.625Z"}
{"parentUuid":"a16083db-130b-4464-87d8-bb0d6f4a64d2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_016Ndcma3fEvC8pkT7K1w4yb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GwHvrvhFYoZkktrcx7wx27","name":"Bash","input":{"command":"./scripts/typecheck-file.sh apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","description":"Typecheck the modified file","timeout":30000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":306,"cache_read_input_tokens":59975,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":306},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XDoG1WZpyRCG5CC6ca","type":"assistant","uuid":"6cf646de-d3a7-4293-b7a9-d6b24420178f","timestamp":"2026-02-12T16:52:20.902Z"}
{"parentUuid":"6cf646de-d3a7-4293-b7a9-d6b24420178f","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Exit code 2\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(343,21): error TS2322: Type '{ id: string; name: string; items: ComboBoxItem<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>[]; ... 6 more ...; onChange: (value: string[]) => void; }' is not assignable to type 'IntrinsicAttributes & TagPickerProps<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>'.\n  Property 'renderTagContent' does not exist on type 'IntrinsicAttributes & TagPickerProps<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>'.\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(343,40): error TS7006: Parameter 'data' implicitly has an 'any' type.\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(344,36): error TS7006: Parameter 'data' implicitly has an 'any' type.","is_error":true,"tool_use_id":"toolu_01GwHvrvhFYoZkktrcx7wx27"}]},"uuid":"3e322c6a-96ac-4024-938c-1adbe2201879","timestamp":"2026-02-12T16:52:23.377Z","toolUseResult":"Error: Exit code 2\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(343,21): error TS2322: Type '{ id: string; name: string; items: ComboBoxItem<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>[]; ... 6 more ...; onChange: (value: string[]) => void; }' is not assignable to type 'IntrinsicAttributes & TagPickerProps<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>'.\n  Property 'renderTagContent' does not exist on type 'IntrinsicAttributes & TagPickerProps<{ color: string; course_id: string; description: string; id: string; implicit: boolean; json_comment: string | any[] | Record<string, any> | null; name: string; number: number | null; } & BRAND<...>>'.\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(343,40): error TS7006: Parameter 'data' implicitly has an 'any' type.\napps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx(344,36): error TS7006: Parameter 'data' implicitly has an 'any' type.","sourceToolAssistantUUID":"6cf646de-d3a7-4293-b7a9-d6b24420178f"}
{"parentUuid":"3e322c6a-96ac-4024-938c-1adbe2201879","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01EjXZuHFJesfsLWtAeenxMQ","type":"message","role":"assistant","content":[{"type":"text","text":"The only type errors are pre-existing (the `renderTagContent`/`data` issues on line 343-344), not from my changes. Let me format the file."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":677,"cache_read_input_tokens":60281,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":677},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XEGufV6FKspAfRigwA","type":"assistant","uuid":"52aa7e2d-a1ac-4a96-9774-ef2448bbb765","timestamp":"2026-02-12T16:52:27.156Z"}
{"parentUuid":"52aa7e2d-a1ac-4a96-9774-ef2448bbb765","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01EjXZuHFJesfsLWtAeenxMQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LEem7kmLMx5qPquWh2ekZn","name":"Bash","input":{"command":"yarn prettier --write apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx","description":"Format the modified file","timeout":15000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":677,"cache_read_input_tokens":60281,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":677},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XEGufV6FKspAfRigwA","type":"assistant","uuid":"c457aa48-c699-4ecc-af30-8570d4bf276b","timestamp":"2026-02-12T16:52:27.952Z"}
{"parentUuid":"c457aa48-c699-4ecc-af30-8570d4bf276b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LEem7kmLMx5qPquWh2ekZn","type":"tool_result","content":"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx 56ms (unchanged)","is_error":false}]},"uuid":"52711e65-aa14-4f34-a237-e386de6a35c5","timestamp":"2026-02-12T16:52:28.907Z","toolUseResult":{"stdout":"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx 56ms (unchanged)","stderr":"","interrupted":false,"isImage":false,"noOutputExpected":false},"sourceToolAssistantUUID":"c457aa48-c699-4ecc-af30-8570d4bf276b"}
{"parentUuid":"52711e65-aa14-4f34-a237-e386de6a35c5","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01LE5tA4u5NGtawGTrMex7et","type":"message","role":"assistant","content":[{"type":"text","text":"Already formatted. Here's a summary of all the changes:\n\nAdded `aria-invalid` and `aria-errormessage` to all 7 form inputs that have validation errors:\n\n| Input | Error ID |\n|---|---|\n| `qid` | `qid-error` |\n| `workspace_image` | `workspace_image-error` |\n| `workspace_port` | `workspace_port-error` |\n| `workspace_home` | `workspace_home-error` |\n| `workspace_environment` | `workspace_environment-error` |\n| `external_grading_image` | `external_grading_image-error` |\n| `external_grading_environment` | `external_grading_environment-error` |\n\nFor each input:\n- `aria-invalid` is set to `true` when there's an error, omitted otherwise\n- `aria-errormessage` references the error div's `id` when there's an error, omitted otherwise\n- The error feedback `div` gets a matching `id`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":201,"cache_read_input_tokens":60958,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":201},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XEgks1APFTDqNGMwvJ","type":"assistant","uuid":"5b701c47-08db-4a40-90a0-a6df4aa867ff","timestamp":"2026-02-12T16:52:35.048Z"}
{"parentUuid":"5b701c47-08db-4a40-90a0-a6df4aa867ff","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"31e4053a-8e20-4d5c-84a2-03724dbb24f3","toolUseID":"31e4053a-8e20-4d5c-84a2-03724dbb24f3","timestamp":"2026-02-12T16:52:35.163Z","uuid":"f96d9d38-cd6f-4273-95de-77583f014a7c"}
{"parentUuid":"f96d9d38-cd6f-4273-95de-77583f014a7c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"},"parentToolUseID":"31e4053a-8e20-4d5c-84a2-03724dbb24f3","toolUseID":"31e4053a-8e20-4d5c-84a2-03724dbb24f3","timestamp":"2026-02-12T16:52:35.164Z","uuid":"f330ca76-703a-4411-b441-038a63068b11"}
{"parentUuid":"f330ca76-703a-4411-b441-038a63068b11","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"system","subtype":"stop_hook_summary","hookCount":2,"hookInfos":[{"command":"entire hooks claude-code stop"},{"command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-12T16:52:39.208Z","uuid":"2b34223e-37f8-438f-8001-ad1f1db264f6","toolUseID":"31e4053a-8e20-4d5c-84a2-03724dbb24f3"}
{"parentUuid":"2b34223e-37f8-438f-8001-ad1f1db264f6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"system","subtype":"turn_duration","durationMs":106031,"timestamp":"2026-02-12T16:52:39.215Z","uuid":"54f1b016-963d-4bfd-be9e-f4ce95fdd3ae","isMeta":false}
{"type":"file-history-snapshot","messageId":"515eac62-a1e4-4c35-839a-78dd1f87b301","snapshot":{"messageId":"515eac62-a1e4-4c35-839a-78dd1f87b301","trackedFileBackups":{"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx":{"backupFileName":"dcea02e665f28672@v2","version":2,"backupTime":"2026-02-12T16:53:21.533Z"}},"timestamp":"2026-02-12T16:53:21.532Z"},"isSnapshotUpdate":false}
{"parentUuid":"54f1b016-963d-4bfd-be9e-f4ce95fdd3ae","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":"add a note to agents.md about this"},"uuid":"515eac62-a1e4-4c35-839a-78dd1f87b301","timestamp":"2026-02-12T16:53:15.327Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"bypassPermissions"}
{"parentUuid":"515eac62-a1e4-4c35-839a-78dd1f87b301","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_011qU4S4aLpPwGtCrqk583Si","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":12,"cache_read_input_tokens":61401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XJZVfe6ByeoH6iBNGr","type":"assistant","uuid":"2059f4fa-ca2b-4aba-8a5b-b89aecf115e7","timestamp":"2026-02-12T16:53:23.866Z"}
{"parentUuid":"2059f4fa-ca2b-4aba-8a5b-b89aecf115e7","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_011qU4S4aLpPwGtCrqk583Si","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to add a note to an agents.md file about the aria-errormessage and aria-invalid pattern. Let me find this file first.","signature":"ErACCkYICxgCKkDpv/rCaEkAhYuKxaTp5ZqKlV3LXPpbpUGWj5n9akdzHIcYiNKzMg3I41ZAkhdbrQg+Z/5RoBl6/lX1cH1inHuDEgxI0KWXP1YobE9bXeYaDHuWchpmQn7l00JKeSIwf9CeNsRr1c2dMXVG1DYD/OyP7plxMLlfvZsyNkQ5+lz4Dn5czDsL6xt65Nyg19pKKpcBhHUfXbF5t+jopu58wOOvndNjFEwLUEOGripB2AMWwhxPDYUpzQ6oDbXj7XpTO7fdQSF0KCXFy7EjxBlqeAQ+JgOsgkkUNGmlxoMye5GS8HdXthk7g6Qi0tjSDRRR4gepAvBoXRm+Icyfbh0z0zUw+6lxXr/yq0rklozXCQ4RMfbAiW0GM8uFSzT33QWqzUAc3yb4dChiuhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":12,"cache_read_input_tokens":61401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XJZVfe6ByeoH6iBNGr","type":"assistant","uuid":"bc1f7549-94a4-4fd2-aff9-f33028e21e1d","timestamp":"2026-02-12T16:53:24.763Z"}
{"parentUuid":"bc1f7549-94a4-4fd2-aff9-f33028e21e1d","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_011qU4S4aLpPwGtCrqk583Si","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FZ3LvqV2odT9ydCfaaRg8d","name":"Glob","input":{"pattern":"**/*agents*.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":12,"cache_read_input_tokens":61401,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":12},"output_tokens":14,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XJZVfe6ByeoH6iBNGr","type":"assistant","uuid":"bd268337-cf15-4006-8007-a3e4f74691c0","timestamp":"2026-02-12T16:53:25.212Z"}
{"parentUuid":"bd268337-cf15-4006-8007-a3e4f74691c0","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_01FZ3LvqV2odT9ydCfaaRg8d","toolUseID":"toolu_01FZ3LvqV2odT9ydCfaaRg8d","timestamp":"2026-02-12T16:53:26.313Z","uuid":"ae7e1498-2863-4f0c-9336-9295ad18ec08"}
{"parentUuid":"bd268337-cf15-4006-8007-a3e4f74691c0","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FZ3LvqV2odT9ydCfaaRg8d","type":"tool_result","content":"No files found"}]},"uuid":"221d55c3-104c-45b0-b155-2dfe196c56d2","timestamp":"2026-02-12T16:53:26.313Z","toolUseResult":{"filenames":[],"durationMs":1098,"numFiles":0,"truncated":false},"sourceToolAssistantUUID":"bd268337-cf15-4006-8007-a3e4f74691c0"}
{"parentUuid":"221d55c3-104c-45b0-b155-2dfe196c56d2","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_0159DtSv8qNSdDeFK6GUWN66","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017MJsX238Apjo3WFM9PoCFC","name":"Glob","input":{"pattern":"**/.agents/**/*.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":125,"cache_read_input_tokens":61413,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":125},"output_tokens":26,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XJuyDjvSi1G1AL6GYa","type":"assistant","uuid":"70610810-2dff-4eed-8772-53ed11f33dea","timestamp":"2026-02-12T16:53:29.018Z"}
{"parentUuid":"70610810-2dff-4eed-8772-53ed11f33dea","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Glob","command":"callback"},"parentToolUseID":"toolu_017MJsX238Apjo3WFM9PoCFC","toolUseID":"toolu_017MJsX238Apjo3WFM9PoCFC","timestamp":"2026-02-12T16:53:30.087Z","uuid":"2b638a54-8fe5-46b9-81a6-704b6946b957"}
{"parentUuid":"70610810-2dff-4eed-8772-53ed11f33dea","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017MJsX238Apjo3WFM9PoCFC","type":"tool_result","content":"/Users/peter/work/PrairieLearn/.agents/skills/groups-and-teams/SKILL.md\n/Users/peter/work/PrairieLearn/.agents/skills/playwright-testing/SKILL.md"}]},"uuid":"b7830ec7-4e38-444e-98b9-0b506270e5b4","timestamp":"2026-02-12T16:53:30.086Z","toolUseResult":{"filenames":["/Users/peter/work/PrairieLearn/.agents/skills/groups-and-teams/SKILL.md","/Users/peter/work/PrairieLearn/.agents/skills/playwright-testing/SKILL.md"],"durationMs":1063,"numFiles":2,"truncated":false},"sourceToolAssistantUUID":"70610810-2dff-4eed-8772-53ed11f33dea"}
{"parentUuid":"b7830ec7-4e38-444e-98b9-0b506270e5b4","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_019BjhD9PggQy4wJ1UVf84J2","type":"message","role":"assistant","content":[{"type":"text","text":"There's no `agents.md` file in the repo. Did you mean CLAUDE.md, MEMORY.md, or a new file? Where would you like this note added?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":123,"cache_read_input_tokens":61538,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":123},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XKC5qSGVMWb3k8fcJa","type":"assistant","uuid":"523a975b-18a5-446a-b14c-657c29f17b03","timestamp":"2026-02-12T16:53:33.529Z"}
{"parentUuid":"523a975b-18a5-446a-b14c-657c29f17b03","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"a29e9661-69a9-4773-95a3-40f1672f0d72","toolUseID":"a29e9661-69a9-4773-95a3-40f1672f0d72","timestamp":"2026-02-12T16:53:33.659Z","uuid":"95ef4100-d37f-4249-9fe3-2013a58e269b"}
{"parentUuid":"95ef4100-d37f-4249-9fe3-2013a58e269b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"},"parentToolUseID":"a29e9661-69a9-4773-95a3-40f1672f0d72","toolUseID":"a29e9661-69a9-4773-95a3-40f1672f0d72","timestamp":"2026-02-12T16:53:33.659Z","uuid":"c1e03de0-38f5-4ed1-a80c-56e0c02928b6"}
{"parentUuid":"c1e03de0-38f5-4ed1-a80c-56e0c02928b6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"system","subtype":"stop_hook_summary","hookCount":2,"hookInfos":[{"command":"entire hooks claude-code stop"},{"command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-12T16:53:38.881Z","uuid":"c97aa545-4c13-446f-9055-393e10ba05d8","toolUseID":"a29e9661-69a9-4773-95a3-40f1672f0d72"}
{"type":"file-history-snapshot","messageId":"e04d3981-837c-4069-a615-0a47522a471b","snapshot":{"messageId":"e04d3981-837c-4069-a615-0a47522a471b","trackedFileBackups":{"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx":{"backupFileName":"dcea02e665f28672@v2","version":2,"backupTime":"2026-02-12T16:53:21.533Z"}},"timestamp":"2026-02-12T16:54:06.906Z"},"isSnapshotUpdate":false}
{"parentUuid":"c97aa545-4c13-446f-9055-393e10ba05d8","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":"yes, claude.md"},"uuid":"e04d3981-837c-4069-a615-0a47522a471b","timestamp":"2026-02-12T16:54:00.099Z","thinkingMetadata":{"maxThinkingTokens":31999},"todos":[],"permissionMode":"bypassPermissions"}
{"parentUuid":"e04d3981-837c-4069-a615-0a47522a471b","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01TF1dSHSf6steRPW8f2m3Vw","type":"message","role":"assistant","content":[{"type":"text","text":"\n\n"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8,"cache_read_input_tokens":61701,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XMuYkg6CPd3yMj6D9i","type":"assistant","uuid":"5535bf4c-fcef-4b29-97da-da67821665e6","timestamp":"2026-02-12T16:54:09.364Z"}
{"parentUuid":"5535bf4c-fcef-4b29-97da-da67821665e6","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01TF1dSHSf6steRPW8f2m3Vw","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to add a note to CLAUDE.md about using `aria-invalid` and `aria-errormessage` on form inputs with validation errors. Let me re-read the CLAUDE.md to find the right place to add it.","signature":"Eu8CCkYICxgCKkBYSt/YAr2gM9N1VYlcCGYwgaIS3ax1aDBL6JhbRJHNMxdweDrXGspWGCmS2f6p7hI8RVq+h20FSE8YhjkKlSelEgzVM+Z1C7AYvOnvyxAaDJOd3BwYdC0GUhuvGCIwL35blTZSIKa6pc+r7sIbF/0jNM9JkVl2tm/X5E75Xdiz5gOmZ9KSvKOzwKjWgCRRKtYBV7cAkGzZShAb9OPqTO3JIbbcWyL39+6iMPHcNPmAXHVCqQCCGWR23AobQ22EFq370i8pcUo//lu+3YHy4wvwKm4kjzWtrTBFSUI4bPEO3ytRntimJ9YZXdgW5WdHEmf7aWp1nwnMffn9qt6cYVUAb9lP3cnuB+zzIf0tZsw4E27aZo5AeT5qWg23d6URcCx+K3f1ljVlcG11X8Ojl0Rwjjx3FmRER/85nniVYOho1uTlPMRcxS7ZUn0M/OWuVjmfcDqh/AF47PTegjMjGOswvy9lulJ6VxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8,"cache_read_input_tokens":61701,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XMuYkg6CPd3yMj6D9i","type":"assistant","uuid":"624d297d-6309-4f42-8ee5-e0fd603479e1","timestamp":"2026-02-12T16:54:10.331Z"}
{"parentUuid":"624d297d-6309-4f42-8ee5-e0fd603479e1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01TF1dSHSf6steRPW8f2m3Vw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01P1DBLor3CNboVjzwefYk4m","name":"Read","input":{"file_path":"/Users/peter/work/PrairieLearn/CLAUDE.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":8,"cache_read_input_tokens":61701,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":8},"output_tokens":9,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XMuYkg6CPd3yMj6D9i","type":"assistant","uuid":"0551d287-dd34-4256-8c1d-2066d97585d1","timestamp":"2026-02-12T16:54:10.998Z"}
{"parentUuid":"0551d287-dd34-4256-8c1d-2066d97585d1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01P1DBLor3CNboVjzwefYk4m","toolUseID":"toolu_01P1DBLor3CNboVjzwefYk4m","timestamp":"2026-02-12T16:54:11.001Z","uuid":"87f66998-cec9-498b-bfec-db03c49a936d"}
{"parentUuid":"0551d287-dd34-4256-8c1d-2066d97585d1","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01P1DBLor3CNboVjzwefYk4m","type":"tool_result","content":"     1→# PrairieLearn\n     2→\n     3→PrairieLearn is an educational learning platform with a focus on automated assessments.\n     4→This is a monorepo that contains both applications (in `apps/*`) and libraries (in `packages/*`).\n     5→\n     6→## Tech stack\n     7→\n     8→Frontend: TypeScript / React / Bootstrap / Tanstack\n     9→Backend: TypeScript / Express / Python / PostgreSQL\n    10→\n    11→## Applications\n    12→\n    13→- `apps/prairielearn`: The main PrairieLearn web application. Key files:\n    14→  - `apps/prairielearn/src/server.ts`: Entry point for the PrairieLearn web application. Initializes the Express server and maps URLs to pages.\n    15→  - `apps/prairielearn/src/pages/`: Individual pages of the PrairieLearn application. You would add a new page here.\n    16→\n    17→- `apps/grader-host`: The application that runs external grading jobs.\n    18→- `apps/workspace-host`: The application that runs workspace containers.\n    19→\n    20→## Packages\n    21→\n    22→Libraries live in `packages/`. If you update a package, you MUST add a changeset. Create a markdown file in `.changeset/` with a name like `fix-my-bug.md` containing:\n    23→\n    24→```markdown\n    25→---\n    26→'@prairielearn/package-name': patch\n    27→---\n    28→\n    29→Description of the change\n    30→```\n    31→\n    32→Use `patch` for bug fixes, `minor` for new features, and `major` for breaking changes.\n    33→\n    34→Frequently used packages:\n    35→\n    36→- `@prairielearn/ui`: UI components for the PrairieLearn web application.\n    37→\n    38→## Git\n    39→\n    40→- NEVER amend commits or force push unless specifically requested.\n    41→- NEVER rebase unless specifically requested, always use merge commits.\n    42→\n    43→## Building, type checking, and linting\n    44→\n    45→When working on a task, you should typecheck / lint / format individual files as you go. When you are done, you should typecheck / lint / format all changed files.\n    46→\n    47→Run `make format-changed` from the root directory to format all changed files (staged + unstaged + untracked) compared to HEAD. This is useful for formatting all your work-in-progress changes.\n    48→\n    49→### TypeScript\n    50→\n    51→Typechecking:\n    52→\n    53→- Individual files: `./scripts/typecheck-file.sh path/to/file.ts [path/to/file2.ts] ...`\n    54→- All files: `make build`. You will need to do this after making changes to a package.\n    55→\n    56→Linting:\n    57→\n    58→- Individual files: `yarn eslint --fix path/to/file.ts`. Prefer using a skill / LSP / MCP for this to improve performance.\n    59→- All files: `make lint-js`\n    60→\n    61→Formatting:\n    62→\n    63→- Individual files: `yarn prettier --write path/to/file.ts`\n    64→- All files: `make format-js`\n    65→\n    66→### Python\n    67→\n    68→Typechecking:\n    69→\n    70→- Individual files: `yarn pyright path/to/file.py`. Prefer using a skill / LSP / MCP for this to improve performance.\n    71→- All files: `make typecheck-python`\n    72→\n    73→Linting:\n    74→\n    75→- Individual files: `uv run ruff check --fix path/to/file.py`\n    76→- All files: `make lint-python`\n    77→\n    78→Formatting:\n    79→\n    80→- Individual files: `uv run ruff format path/to/file.py`\n    81→- All files: `make format-python`\n    82→\n    83→### Other tools / languages (e.g. SQL, Markdown, Shell)\n    84→\n    85→SQL, shell, markdown, and JSON files should also be formatted with `yarn prettier --write path/to/file.{sql,sh,md,json}`.\n    86→Reference the Makefile for commands to format/lint/typecheck other tools / languages.\n    87→\n    88→## Database and schema changes\n    89→\n    90→All applications share a single Postgres database. See `database/` for descriptions of the database tables and enums. All tables have corresponding Zod types in `apps/prairielearn/src/lib/db-types.ts`.\n    91→\n    92→Migrations are stored in `apps/prairielearn/src/migrations`. See the [`README.md`](apps/prairielearn/src/migrations/README.md) file in that directory for details on how to create and run migrations.\n    93→\n    94→If you make a change to the database, make sure to update the database schema description in `database/` and the Zod types/table list in `apps/prairielearn/src/lib/db-types.ts`.\n    95→\n    96→Prefer interacting with the database using model functions in `apps/prairielearn/src/models/`.\n    97→\n    98→Course content repositories use JSON files like `infoCourse.json`, `infoCourseInstance.json`, and `infoAssessment.json` to configure different parts of the course. The schemas for these files are stored as Zod schemas in `schemas/`. If you make a change to a schema file in `schemas/`, make sure to update the JSON schema with `make update-jsonschema`.\n    99→\n   100→When working with assessment \"groups\" / \"teams\", see the [`groups-and-teams` skill](./.agents/skills/groups-and-teams/SKILL.md).\n   101→\n   102→## TypeScript guidance\n   103→\n   104→### Library usage conventions\n   105→\n   106→- Use `@tanstack/react-query` for API calls.\n   107→- Use `react-hook-form` for form handling.\n   108→- Prefer `extractPageContext(res.locals, ...)` over accessing `res.locals` properties directly in route handlers. This provides better type safety and ensures consistent access patterns.\n   109→- Use `nuqs` for URL query state in hydrated components. Use `NuqsAdapter` from `@prairielearn/ui` and pass the search string from the router. See `pages/home/` for an example.\n   110→\n   111→### Common mistakes & gotchas\n   112→\n   113→- Information about the current user, course instance, course, etc. is stored in `res.locals` in route handlers. Types for `res.locals` are defined in `apps/prairielearn/src/lib/res-locals.ts`.\n   114→- NEVER use `as any` casts in TypeScript code to avoid type errors.\n   115→- Don't add extra defensive checks or try/catch blocks that are abnormal for that area of the codebase (especially if called by trusted / validated codepaths).\n   116→- Don't add extra comments that a human wouldn't add or that are inconsistent with the rest of the file.\n   117→- Always check for existing model functions in `apps/prairielearn/src/models/` or lib functions before writing one-off database queries.\n   118→- Express request handlers must always either send a response (either by calling `res.send`/etc. or throwing an error) or explicitly pass control by calling `next(...)`.\n   119→- Don't re-export functions or types from other modules just for convenience or backward compatibility (e.g. `export { bar } from 'foo'`).\n   120→\n   121→### User interface conventions\n   122→\n   123→- Use `react-bootstrap` components for UI elements.\n   124→- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").\n   125→\n   126→### Testing\n   127→\n   128→Integration and unit tests are written with Vitest. End-to-end tests are written with Playwright. Unit tests are located next to the code they test in files with a `.test.ts` suffix. Integration tests are located in dedicated `tests` directories, e.g. `apps/prairielearn/src/tests`. End-to-end tests are located in `apps/prairielearn/src/tests/e2e`.\n   129→\n   130→Individual tests:\n   131→\n   132→- For integration and unit tests, use `yarn test path/to/file.test.ts` from the root directory.\n   133→- For end-to-end tests, use `yarn test:e2e path/to/integration.spec.ts` from the root directory.\n   134→\n   135→Avoid running the entire test suite unless necessary, as it can be time-consuming. However, if you must:\n   136→\n   137→- To run all TypeScript tests, use `yarn test` from the root directory\n   138→\n   139→Tests expect Postgres, Redis, and an S3-compatible store to be running, and usually they already are. If you suspect that they're not, run `make start-support` from the root directory.\n   140→\n   141→To test UI code looks correct, you should try to connect to the development server at `http://localhost:3000` and screenshot the page with `playwright`. A development server can be started with `make dev`, but the developer has typically already started one up.\n   142→\n   143→When writing tests:\n   144→\n   145→- Don't add assertion messages unless they provide information that isn't obvious from reading the assertion itself (e.g., `assert.isNull(linkRecord)` is clear without a message).\n   146→- Don't use defensive checks in tests -- tests should fail fast if unexpected data exists.\n   147→\n   148→### Rendering HTML\n   149→\n   150→The PrairieLearn web application renders HTML in one of two ways:\n   151→\n   152→- Static HTML is rendered with an `html` tagged-template literal from the `@prairielearn/html` package. See [`packages/html/README.md`](packages/html/README.md) for details.\n   153→- Interactive components are built and rendered with React and hydrated with utilities from the `@prairielearn/react` package. See [`packages/react/README.md`](packages/react/README.md) for details.\n   154→\n   155→### React guidance\n   156→\n   157→- A file at `./foo.tsx` should be imported as `./foo.js` from other files.\n   158→- Use `clsx` in React components.\n   159→- Inline prop definitions for components if they are not used outside of the component.\n   160→- Pass `res.locals` to `getPageContext` to get information about the course instance / authentication state.\n   161→- If you hydrate a component with `Hydrate`, you must register the component with `registerHydratedComponent` in a file in `apps/prairielearn/assets/scripts/esm-bundles/hydrated-components`.\n   162→- Don't use `useMemo` for cheap computations. Use `run` from `@prairielearn/run` instead (an IIFE helper that executes a function immediately).\n   163→- Avoid unnecessary `useEffect` when using `react-hook-form`. The `watch()` function returns reactive values that trigger re-renders automatically, so derived state can be computed directly without `useEffect`.\n   164→\n   165→## Python guidance\n   166→\n   167→Elements (similar to React components, used to build interactive questions) are written in Python and are located in `apps/prairielearn/elements/`.\n   168→\n   169→When changing element properties or options, you MUST update the corresponding documentation in `docs/elements/<element-name>.md` to match.\n   170→\n   171→### Testing\n   172→\n   173→- For Python tests, use `uv run pytest path/to/testfile.py` from the root directory.\n   174→- To run all Python tests, use `make test-python` from the root directory.\n   175→"}]},"uuid":"97bf1474-1ab4-4365-a34e-7e462b95856c","timestamp":"2026-02-12T16:54:11.000Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/peter/work/PrairieLearn/CLAUDE.md","content":"# PrairieLearn\n\nPrairieLearn is an educational learning platform with a focus on automated assessments.\nThis is a monorepo that contains both applications (in `apps/*`) and libraries (in `packages/*`).\n\n## Tech stack\n\nFrontend: TypeScript / React / Bootstrap / Tanstack\nBackend: TypeScript / Express / Python / PostgreSQL\n\n## Applications\n\n- `apps/prairielearn`: The main PrairieLearn web application. Key files:\n  - `apps/prairielearn/src/server.ts`: Entry point for the PrairieLearn web application. Initializes the Express server and maps URLs to pages.\n  - `apps/prairielearn/src/pages/`: Individual pages of the PrairieLearn application. You would add a new page here.\n\n- `apps/grader-host`: The application that runs external grading jobs.\n- `apps/workspace-host`: The application that runs workspace containers.\n\n## Packages\n\nLibraries live in `packages/`. If you update a package, you MUST add a changeset. Create a markdown file in `.changeset/` with a name like `fix-my-bug.md` containing:\n\n```markdown\n---\n'@prairielearn/package-name': patch\n---\n\nDescription of the change\n```\n\nUse `patch` for bug fixes, `minor` for new features, and `major` for breaking changes.\n\nFrequently used packages:\n\n- `@prairielearn/ui`: UI components for the PrairieLearn web application.\n\n## Git\n\n- NEVER amend commits or force push unless specifically requested.\n- NEVER rebase unless specifically requested, always use merge commits.\n\n## Building, type checking, and linting\n\nWhen working on a task, you should typecheck / lint / format individual files as you go. When you are done, you should typecheck / lint / format all changed files.\n\nRun `make format-changed` from the root directory to format all changed files (staged + unstaged + untracked) compared to HEAD. This is useful for formatting all your work-in-progress changes.\n\n### TypeScript\n\nTypechecking:\n\n- Individual files: `./scripts/typecheck-file.sh path/to/file.ts [path/to/file2.ts] ...`\n- All files: `make build`. You will need to do this after making changes to a package.\n\nLinting:\n\n- Individual files: `yarn eslint --fix path/to/file.ts`. Prefer using a skill / LSP / MCP for this to improve performance.\n- All files: `make lint-js`\n\nFormatting:\n\n- Individual files: `yarn prettier --write path/to/file.ts`\n- All files: `make format-js`\n\n### Python\n\nTypechecking:\n\n- Individual files: `yarn pyright path/to/file.py`. Prefer using a skill / LSP / MCP for this to improve performance.\n- All files: `make typecheck-python`\n\nLinting:\n\n- Individual files: `uv run ruff check --fix path/to/file.py`\n- All files: `make lint-python`\n\nFormatting:\n\n- Individual files: `uv run ruff format path/to/file.py`\n- All files: `make format-python`\n\n### Other tools / languages (e.g. SQL, Markdown, Shell)\n\nSQL, shell, markdown, and JSON files should also be formatted with `yarn prettier --write path/to/file.{sql,sh,md,json}`.\nReference the Makefile for commands to format/lint/typecheck other tools / languages.\n\n## Database and schema changes\n\nAll applications share a single Postgres database. See `database/` for descriptions of the database tables and enums. All tables have corresponding Zod types in `apps/prairielearn/src/lib/db-types.ts`.\n\nMigrations are stored in `apps/prairielearn/src/migrations`. See the [`README.md`](apps/prairielearn/src/migrations/README.md) file in that directory for details on how to create and run migrations.\n\nIf you make a change to the database, make sure to update the database schema description in `database/` and the Zod types/table list in `apps/prairielearn/src/lib/db-types.ts`.\n\nPrefer interacting with the database using model functions in `apps/prairielearn/src/models/`.\n\nCourse content repositories use JSON files like `infoCourse.json`, `infoCourseInstance.json`, and `infoAssessment.json` to configure different parts of the course. The schemas for these files are stored as Zod schemas in `schemas/`. If you make a change to a schema file in `schemas/`, make sure to update the JSON schema with `make update-jsonschema`.\n\nWhen working with assessment \"groups\" / \"teams\", see the [`groups-and-teams` skill](./.agents/skills/groups-and-teams/SKILL.md).\n\n## TypeScript guidance\n\n### Library usage conventions\n\n- Use `@tanstack/react-query` for API calls.\n- Use `react-hook-form` for form handling.\n- Prefer `extractPageContext(res.locals, ...)` over accessing `res.locals` properties directly in route handlers. This provides better type safety and ensures consistent access patterns.\n- Use `nuqs` for URL query state in hydrated components. Use `NuqsAdapter` from `@prairielearn/ui` and pass the search string from the router. See `pages/home/` for an example.\n\n### Common mistakes & gotchas\n\n- Information about the current user, course instance, course, etc. is stored in `res.locals` in route handlers. Types for `res.locals` are defined in `apps/prairielearn/src/lib/res-locals.ts`.\n- NEVER use `as any` casts in TypeScript code to avoid type errors.\n- Don't add extra defensive checks or try/catch blocks that are abnormal for that area of the codebase (especially if called by trusted / validated codepaths).\n- Don't add extra comments that a human wouldn't add or that are inconsistent with the rest of the file.\n- Always check for existing model functions in `apps/prairielearn/src/models/` or lib functions before writing one-off database queries.\n- Express request handlers must always either send a response (either by calling `res.send`/etc. or throwing an error) or explicitly pass control by calling `next(...)`.\n- Don't re-export functions or types from other modules just for convenience or backward compatibility (e.g. `export { bar } from 'foo'`).\n\n### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").\n\n### Testing\n\nIntegration and unit tests are written with Vitest. End-to-end tests are written with Playwright. Unit tests are located next to the code they test in files with a `.test.ts` suffix. Integration tests are located in dedicated `tests` directories, e.g. `apps/prairielearn/src/tests`. End-to-end tests are located in `apps/prairielearn/src/tests/e2e`.\n\nIndividual tests:\n\n- For integration and unit tests, use `yarn test path/to/file.test.ts` from the root directory.\n- For end-to-end tests, use `yarn test:e2e path/to/integration.spec.ts` from the root directory.\n\nAvoid running the entire test suite unless necessary, as it can be time-consuming. However, if you must:\n\n- To run all TypeScript tests, use `yarn test` from the root directory\n\nTests expect Postgres, Redis, and an S3-compatible store to be running, and usually they already are. If you suspect that they're not, run `make start-support` from the root directory.\n\nTo test UI code looks correct, you should try to connect to the development server at `http://localhost:3000` and screenshot the page with `playwright`. A development server can be started with `make dev`, but the developer has typically already started one up.\n\nWhen writing tests:\n\n- Don't add assertion messages unless they provide information that isn't obvious from reading the assertion itself (e.g., `assert.isNull(linkRecord)` is clear without a message).\n- Don't use defensive checks in tests -- tests should fail fast if unexpected data exists.\n\n### Rendering HTML\n\nThe PrairieLearn web application renders HTML in one of two ways:\n\n- Static HTML is rendered with an `html` tagged-template literal from the `@prairielearn/html` package. See [`packages/html/README.md`](packages/html/README.md) for details.\n- Interactive components are built and rendered with React and hydrated with utilities from the `@prairielearn/react` package. See [`packages/react/README.md`](packages/react/README.md) for details.\n\n### React guidance\n\n- A file at `./foo.tsx` should be imported as `./foo.js` from other files.\n- Use `clsx` in React components.\n- Inline prop definitions for components if they are not used outside of the component.\n- Pass `res.locals` to `getPageContext` to get information about the course instance / authentication state.\n- If you hydrate a component with `Hydrate`, you must register the component with `registerHydratedComponent` in a file in `apps/prairielearn/assets/scripts/esm-bundles/hydrated-components`.\n- Don't use `useMemo` for cheap computations. Use `run` from `@prairielearn/run` instead (an IIFE helper that executes a function immediately).\n- Avoid unnecessary `useEffect` when using `react-hook-form`. The `watch()` function returns reactive values that trigger re-renders automatically, so derived state can be computed directly without `useEffect`.\n\n## Python guidance\n\nElements (similar to React components, used to build interactive questions) are written in Python and are located in `apps/prairielearn/elements/`.\n\nWhen changing element properties or options, you MUST update the corresponding documentation in `docs/elements/<element-name>.md` to match.\n\n### Testing\n\n- For Python tests, use `uv run pytest path/to/testfile.py` from the root directory.\n- To run all Python tests, use `make test-python` from the root directory.\n","numLines":175,"startLine":1,"totalLines":175}},"sourceToolAssistantUUID":"0551d287-dd34-4256-8c1d-2066d97585d1"}
{"parentUuid":"97bf1474-1ab4-4365-a34e-7e462b95856c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01XJDJvjDQpkxvYjfmogMbeD","type":"message","role":"assistant","content":[{"type":"text","text":"The \"User interface conventions\" section is the right place. I'll add a note about form accessibility there."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3166,"cache_read_input_tokens":61709,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3166},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XNDfRUnwJ3Xn9whNk3","type":"assistant","uuid":"1e66e3d9-085b-404c-87bf-e45511011ba5","timestamp":"2026-02-12T16:54:14.179Z"}
{"type":"file-history-snapshot","messageId":"6a7ff50a-cdc5-4800-834a-e3fecee91520","snapshot":{"messageId":"e04d3981-837c-4069-a615-0a47522a471b","trackedFileBackups":{"apps/prairielearn/src/pages/instructorQuestionSettings/components/QuestionSettingsForm.tsx":{"backupFileName":"dcea02e665f28672@v2","version":2,"backupTime":"2026-02-12T16:53:21.533Z"},"CLAUDE.md":{"backupFileName":"c4083464d9bece31@v1","version":1,"backupTime":"2026-02-12T16:54:16.129Z"}},"timestamp":"2026-02-12T16:54:06.906Z"},"isSnapshotUpdate":true}
{"parentUuid":"1e66e3d9-085b-404c-87bf-e45511011ba5","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_01XJDJvjDQpkxvYjfmogMbeD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JpSukzJDKg4ABjmDkYKXJm","name":"Edit","input":{"replace_all":false,"file_path":"/Users/peter/work/PrairieLearn/CLAUDE.md","old_string":"### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").","new_string":"### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").\n- Form inputs with validation errors should include `aria-invalid` and `aria-errormessage` attributes pointing to the error message element's `id`."}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3166,"cache_read_input_tokens":61709,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":3166},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XNDfRUnwJ3Xn9whNk3","type":"assistant","uuid":"6a7ff50a-cdc5-4800-834a-e3fecee91520","timestamp":"2026-02-12T16:54:16.124Z"}
{"parentUuid":"6a7ff50a-cdc5-4800-834a-e3fecee91520","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"file=$(echo $TOOL_PARAMETERS | jq -r '.file_path'); if [[ \"$file\" == *.ts || \"$file\" == *.tsx ]]; then yarn prettier --write \"$file\" 2>&1 || true; fi"},"parentToolUseID":"toolu_01JpSukzJDKg4ABjmDkYKXJm","toolUseID":"toolu_01JpSukzJDKg4ABjmDkYKXJm","timestamp":"2026-02-12T16:54:16.132Z","uuid":"e64b0388-52f1-48b1-8f18-9f78c978ee3c"}
{"parentUuid":"e64b0388-52f1-48b1-8f18-9f78c978ee3c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01JpSukzJDKg4ABjmDkYKXJm","toolUseID":"toolu_01JpSukzJDKg4ABjmDkYKXJm","timestamp":"2026-02-12T16:54:16.132Z","uuid":"a02bb3ad-e0e2-4e44-89f2-73d56e7f2c72"}
{"parentUuid":"6a7ff50a-cdc5-4800-834a-e3fecee91520","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JpSukzJDKg4ABjmDkYKXJm","type":"tool_result","content":"The file /Users/peter/work/PrairieLearn/CLAUDE.md has been updated successfully."}]},"uuid":"d5eafc8b-31ca-47e6-91a8-73f7e2c5e825","timestamp":"2026-02-12T16:54:16.131Z","toolUseResult":{"filePath":"/Users/peter/work/PrairieLearn/CLAUDE.md","oldString":"### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").","newString":"### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").\n- Form inputs with validation errors should include `aria-invalid` and `aria-errormessage` attributes pointing to the error message element's `id`.","originalFile":"# PrairieLearn\n\nPrairieLearn is an educational learning platform with a focus on automated assessments.\nThis is a monorepo that contains both applications (in `apps/*`) and libraries (in `packages/*`).\n\n## Tech stack\n\nFrontend: TypeScript / React / Bootstrap / Tanstack\nBackend: TypeScript / Express / Python / PostgreSQL\n\n## Applications\n\n- `apps/prairielearn`: The main PrairieLearn web application. Key files:\n  - `apps/prairielearn/src/server.ts`: Entry point for the PrairieLearn web application. Initializes the Express server and maps URLs to pages.\n  - `apps/prairielearn/src/pages/`: Individual pages of the PrairieLearn application. You would add a new page here.\n\n- `apps/grader-host`: The application that runs external grading jobs.\n- `apps/workspace-host`: The application that runs workspace containers.\n\n## Packages\n\nLibraries live in `packages/`. If you update a package, you MUST add a changeset. Create a markdown file in `.changeset/` with a name like `fix-my-bug.md` containing:\n\n```markdown\n---\n'@prairielearn/package-name': patch\n---\n\nDescription of the change\n```\n\nUse `patch` for bug fixes, `minor` for new features, and `major` for breaking changes.\n\nFrequently used packages:\n\n- `@prairielearn/ui`: UI components for the PrairieLearn web application.\n\n## Git\n\n- NEVER amend commits or force push unless specifically requested.\n- NEVER rebase unless specifically requested, always use merge commits.\n\n## Building, type checking, and linting\n\nWhen working on a task, you should typecheck / lint / format individual files as you go. When you are done, you should typecheck / lint / format all changed files.\n\nRun `make format-changed` from the root directory to format all changed files (staged + unstaged + untracked) compared to HEAD. This is useful for formatting all your work-in-progress changes.\n\n### TypeScript\n\nTypechecking:\n\n- Individual files: `./scripts/typecheck-file.sh path/to/file.ts [path/to/file2.ts] ...`\n- All files: `make build`. You will need to do this after making changes to a package.\n\nLinting:\n\n- Individual files: `yarn eslint --fix path/to/file.ts`. Prefer using a skill / LSP / MCP for this to improve performance.\n- All files: `make lint-js`\n\nFormatting:\n\n- Individual files: `yarn prettier --write path/to/file.ts`\n- All files: `make format-js`\n\n### Python\n\nTypechecking:\n\n- Individual files: `yarn pyright path/to/file.py`. Prefer using a skill / LSP / MCP for this to improve performance.\n- All files: `make typecheck-python`\n\nLinting:\n\n- Individual files: `uv run ruff check --fix path/to/file.py`\n- All files: `make lint-python`\n\nFormatting:\n\n- Individual files: `uv run ruff format path/to/file.py`\n- All files: `make format-python`\n\n### Other tools / languages (e.g. SQL, Markdown, Shell)\n\nSQL, shell, markdown, and JSON files should also be formatted with `yarn prettier --write path/to/file.{sql,sh,md,json}`.\nReference the Makefile for commands to format/lint/typecheck other tools / languages.\n\n## Database and schema changes\n\nAll applications share a single Postgres database. See `database/` for descriptions of the database tables and enums. All tables have corresponding Zod types in `apps/prairielearn/src/lib/db-types.ts`.\n\nMigrations are stored in `apps/prairielearn/src/migrations`. See the [`README.md`](apps/prairielearn/src/migrations/README.md) file in that directory for details on how to create and run migrations.\n\nIf you make a change to the database, make sure to update the database schema description in `database/` and the Zod types/table list in `apps/prairielearn/src/lib/db-types.ts`.\n\nPrefer interacting with the database using model functions in `apps/prairielearn/src/models/`.\n\nCourse content repositories use JSON files like `infoCourse.json`, `infoCourseInstance.json`, and `infoAssessment.json` to configure different parts of the course. The schemas for these files are stored as Zod schemas in `schemas/`. If you make a change to a schema file in `schemas/`, make sure to update the JSON schema with `make update-jsonschema`.\n\nWhen working with assessment \"groups\" / \"teams\", see the [`groups-and-teams` skill](./.agents/skills/groups-and-teams/SKILL.md).\n\n## TypeScript guidance\n\n### Library usage conventions\n\n- Use `@tanstack/react-query` for API calls.\n- Use `react-hook-form` for form handling.\n- Prefer `extractPageContext(res.locals, ...)` over accessing `res.locals` properties directly in route handlers. This provides better type safety and ensures consistent access patterns.\n- Use `nuqs` for URL query state in hydrated components. Use `NuqsAdapter` from `@prairielearn/ui` and pass the search string from the router. See `pages/home/` for an example.\n\n### Common mistakes & gotchas\n\n- Information about the current user, course instance, course, etc. is stored in `res.locals` in route handlers. Types for `res.locals` are defined in `apps/prairielearn/src/lib/res-locals.ts`.\n- NEVER use `as any` casts in TypeScript code to avoid type errors.\n- Don't add extra defensive checks or try/catch blocks that are abnormal for that area of the codebase (especially if called by trusted / validated codepaths).\n- Don't add extra comments that a human wouldn't add or that are inconsistent with the rest of the file.\n- Always check for existing model functions in `apps/prairielearn/src/models/` or lib functions before writing one-off database queries.\n- Express request handlers must always either send a response (either by calling `res.send`/etc. or throwing an error) or explicitly pass control by calling `next(...)`.\n- Don't re-export functions or types from other modules just for convenience or backward compatibility (e.g. `export { bar } from 'foo'`).\n\n### User interface conventions\n\n- Use `react-bootstrap` components for UI elements.\n- Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").\n\n### Testing\n\nIntegration and unit tests are written with Vitest. End-to-end tests are written with Playwright. Unit tests are located next to the code they test in files with a `.test.ts` suffix. Integration tests are located in dedicated `tests` directories, e.g. `apps/prairielearn/src/tests`. End-to-end tests are located in `apps/prairielearn/src/tests/e2e`.\n\nIndividual tests:\n\n- For integration and unit tests, use `yarn test path/to/file.test.ts` from the root directory.\n- For end-to-end tests, use `yarn test:e2e path/to/integration.spec.ts` from the root directory.\n\nAvoid running the entire test suite unless necessary, as it can be time-consuming. However, if you must:\n\n- To run all TypeScript tests, use `yarn test` from the root directory\n\nTests expect Postgres, Redis, and an S3-compatible store to be running, and usually they already are. If you suspect that they're not, run `make start-support` from the root directory.\n\nTo test UI code looks correct, you should try to connect to the development server at `http://localhost:3000` and screenshot the page with `playwright`. A development server can be started with `make dev`, but the developer has typically already started one up.\n\nWhen writing tests:\n\n- Don't add assertion messages unless they provide information that isn't obvious from reading the assertion itself (e.g., `assert.isNull(linkRecord)` is clear without a message).\n- Don't use defensive checks in tests -- tests should fail fast if unexpected data exists.\n\n### Rendering HTML\n\nThe PrairieLearn web application renders HTML in one of two ways:\n\n- Static HTML is rendered with an `html` tagged-template literal from the `@prairielearn/html` package. See [`packages/html/README.md`](packages/html/README.md) for details.\n- Interactive components are built and rendered with React and hydrated with utilities from the `@prairielearn/react` package. See [`packages/react/README.md`](packages/react/README.md) for details.\n\n### React guidance\n\n- A file at `./foo.tsx` should be imported as `./foo.js` from other files.\n- Use `clsx` in React components.\n- Inline prop definitions for components if they are not used outside of the component.\n- Pass `res.locals` to `getPageContext` to get information about the course instance / authentication state.\n- If you hydrate a component with `Hydrate`, you must register the component with `registerHydratedComponent` in a file in `apps/prairielearn/assets/scripts/esm-bundles/hydrated-components`.\n- Don't use `useMemo` for cheap computations. Use `run` from `@prairielearn/run` instead (an IIFE helper that executes a function immediately).\n- Avoid unnecessary `useEffect` when using `react-hook-form`. The `watch()` function returns reactive values that trigger re-renders automatically, so derived state can be computed directly without `useEffect`.\n\n## Python guidance\n\nElements (similar to React components, used to build interactive questions) are written in Python and are located in `apps/prairielearn/elements/`.\n\nWhen changing element properties or options, you MUST update the corresponding documentation in `docs/elements/<element-name>.md` to match.\n\n### Testing\n\n- For Python tests, use `uv run pytest path/to/testfile.py` from the root directory.\n- To run all Python tests, use `make test-python` from the root directory.\n","structuredPatch":[{"oldStart":122,"oldLines":6,"newStart":122,"newLines":7,"lines":[" "," - Use `react-bootstrap` components for UI elements."," - Titles and buttons should use sentence case (\"Save course\", \"Discard these changes\").","+- Form inputs with validation errors should include `aria-invalid` and `aria-errormessage` attributes pointing to the error message element's `id`."," "," ### Testing"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6a7ff50a-cdc5-4800-834a-e3fecee91520"}
{"parentUuid":"d5eafc8b-31ca-47e6-91a8-73f7e2c5e825","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","message":{"model":"claude-opus-4-6","id":"msg_012s6sEnX4SVw2zsDw2f2GRS","type":"message","role":"assistant","content":[{"type":"text","text":"Added the note to the \"User interface conventions\" section in CLAUDE.md."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":405,"cache_read_input_tokens":64875,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":405},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CY4XNb1KDGVcKt4t4twSm","type":"assistant","uuid":"cd731987-fb86-4a7c-8f53-e7ab6f082b16","timestamp":"2026-02-12T16:54:18.770Z"}
{"parentUuid":"cd731987-fb86-4a7c-8f53-e7ab6f082b16","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"entire hooks claude-code stop"},"parentToolUseID":"de12e0b6-639c-428c-89d1-5d5ed24beb79","toolUseID":"de12e0b6-639c-428c-89d1-5d5ed24beb79","timestamp":"2026-02-12T16:54:18.794Z","uuid":"8ff73488-6775-4bc4-9029-9d05a68e3d4c"}
{"parentUuid":"8ff73488-6775-4bc4-9029-9d05a68e3d4c","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"progress","data":{"type":"hook_progress","hookEvent":"Stop","hookName":"Stop","command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"},"parentToolUseID":"de12e0b6-639c-428c-89d1-5d5ed24beb79","toolUseID":"de12e0b6-639c-428c-89d1-5d5ed24beb79","timestamp":"2026-02-12T16:54:18.794Z","uuid":"c6c72dde-4418-4e93-8a6b-8546f392e16e"}
{"parentUuid":"c6c72dde-4418-4e93-8a6b-8546f392e16e","isSidechain":false,"userType":"external","cwd":"/Users/peter/work/PrairieLearn","sessionId":"493b26e9-a4c7-422b-bb80-e1f38f769bf2","version":"2.1.39","gitBranch":"reteps/question-settings-react","slug":"sunny-brewing-penguin","type":"system","subtype":"stop_hook_summary","hookCount":2,"hookInfos":[{"command":"entire hooks claude-code stop"},{"command":"${CLAUDE_PLUGIN_ROOT}/hooks/stop-hook.sh"}],"hookErrors":[],"preventedContinuation":false,"stopReason":"","hasOutput":true,"level":"suggestion","timestamp":"2026-02-12T16:54:22.762Z","uuid":"16eed09c-eaa5-4f41-99f2-a10861b612d8","toolUseID":"de12e0b6-639c-428c-89d1-5d5ed24beb79"}
