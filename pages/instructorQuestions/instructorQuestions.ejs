<!DOCTYPE html>
<html lang="en">
  
  <head>
    <%- include('../partials/head'); %>
    <script src="<%= node_modules_asset_path('underscore/underscore-min.js') %>"></script>
    <script src="<%= node_modules_asset_path('bootstrap-table/dist/bootstrap-table.min.js') %>"></script>
    <script src="<%= node_modules_asset_path('bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js') %>"></script>
    <script src="<%= node_modules_asset_path('bootstrap-table/dist/extensions/filter-control/bootstrap-table-filter-control.min.js') %>"></script>
    <link href="<%= node_modules_asset_path('bootstrap-table/dist/bootstrap-table.min.css') %>" rel="stylesheet" />
    <link href="<%= node_modules_asset_path('bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.css') %>" rel="stylesheet" />
    <link href="<%= node_modules_asset_path('bootstrap-table/dist/extensions/filter-control/bootstrap-table-filter-control.min.css') %>" rel="stylesheet" />
  </head>
  
  <body>
    <script>
      $(function() {
          $('#questionsTable').bootstrapTable({
              //url: '<%= urlPrefix %>/<%= navPage %>/gradebook/raw_data.json',
              data: <%- JSON.stringify(questions) %>,
              onPreBody: function() {
              },
              onResetView: function () {
                  $('[data-toggle="popover"]').popover({
                      sanitize: false,
                      container: 'body',
                      html: true,
                      trigger: 'hover',
                  }).on("show.bs.popover", function() {
                      $($(this).data("bs.popover").getTipElement()).css("max-width", "80%");
                  });
              },
          });
      });

      function titleFormatter(title, question) {
          var text = '';
          if (question.sync_errors) {
              text += `<button class="btn btn-xs mr-1" data-toggle="popover" data-title="Sync Errors"
                               data-content="<pre style=&quot;background-color: black&quot; class=&quot;text-white rounded p-3&quot;>${_.escape(question.sync_errors_ansified)}</pre>">
                    <i class="fa fa-times text-danger" aria-hidden="true"></i>
                  </button>`;
          } else if (question.sync_warnings) {
              text += `<button class="btn btn-xs mr-1" data-toggle="popover" data-title="Sync Warnings"
                          data-content="<pre style=&quot;background-color: black&quot; class=&quot;text-white rounded p-3&quot;>${_.escape(question.sync_warnings_ansified)}</pre>">
                    <i class="fa fa-exclamation-triangle text-warning" aria-hidden="true"></i>
                  </button>`;
          }
          text += `<a class="formatter-data" href="<%= urlPrefix %>/question/${question.id}/">${_.escape(question.title)}</a>`;
          if (question.open_issue_count > 0) {
              text += `<a class="badge badge-pill badge-danger ml-1" href="<%= urlPrefix %>/course_admin/issues?q=qid%3A${_.escape(question.qid)}">${question.open_issue_count}</a>`;
          }
          return text;
      }

      function topicFormatter(topic, question) {
          return `<span class="badge color-${topic.color}">${_.escape(topic.name)}</span>`;
      }

      function tagsFormatter(tags, question) {
          return _.map(tags ?? [], tag => `<span class="badge color-${tag.color}">${tag.name}</span>`).join(' ');
      }

      function versionFormatter(version, question) {
          return `<span class="badge color-${version == 'v3' ? 'green1' : 'red1'}">${_.escape(version)}</span>`;
      }

      function assessmentsFormatter(assessments, question) {
          return _.map(assessments ?? [], assessment => `<a href="<%= urlPrefix %>/assessment/${assessment.assessment_id}" class="badge color-${assessment.color} color-hover" onclick="event.stopPropagation();"><span>${_.escape(assessment.label)}</span></a>`).join(' ');
      }

      function genericFilterSearch(search, value, field, data) {
          console.log($('<div>').html(value).find('.formatter-data').text(), search);
          return $('<div>').html(value).find('.formatter-data').text().includes(search);
      }

      function elementListFilterSearch(search, value, field, data) {
          var values = $('<div>').html(value).find('span')
              .filter((i, elem) => $(elem).text().toUpperCase() == search.toUpperCase())
              .length;
          console.log(value, values, !!values);
          return !!values;
      }
    </script>
    <style>
      .sticky-column {
          position: sticky;
          left: 0;
          background: white;
          box-shadow: inset -1px 0 #dee2e6;
      }
      .table-hover tbody tr:hover td.sticky-column {
          color: #212529;
          background-color: #efefef;
      }
      .fixed-table-toolbar {
          padding: 0 1em 0 1em;
      }
      div.pagination {
          margin: 0 0 0 1em;
      }
    </style>
    <%- include('../partials/navbar'); %>
    <div id="content" class="container-fluid">
      <%- include('../partials/courseSyncErrorsAndWarnings'); %>
      <div class="card mb-4">
        <div class="card-header bg-primary">
          <div class="row align-items-center justify-content-between">
            <div class="col-auto">
              <span class="text-white">Questions</span>
            </div>
            <div class="col-auto">
              <% if ((authz_data.has_course_permission_edit) && (! course.example_course) && (! locals.needToSync)) { %>
              <form class="d-inline" name="add-question-form" method="POST">
                <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                <button name="__action" value="add_question" class="btn btn-sm btn-light"><i class="fa fa-plus" aria-hidden="true"></i>
                  <span>Add question</span></button>
              </form>
              <% } %>
              <button class="btn btn-sm btn-light" type="button" id="resetFilter">Clear all filters</button>
            </div>
          </div>
        </div>

        <table id="questionsTable"
               data-classes="table table-sm table-hover table-bordered"
               data-filter-control="true"
               data-show-columns="true"
               data-show-columns-toggle-all="true"
               data-pagination="true"
               data-pagination-v-align="top"
               data-page-list="[50,100,200,500,unlimited]"
               data-page-size="50"
               data-smart-display="false"
               data-show-extended-pagination="true"
               data-toolbar=".fixed-table-pagination"
               data-sticky-header="true">
          <thead>
            <tr>
              <th data-field="title"
                  data-sortable="true"
                  data-class="align-middle"
                  data-formatter="titleFormatter"
                  data-filter-control="input"
                  data-filter-custom-search="genericFilterSearch"
                  data-switchable="true">Title</th>
              <th data-field="qid"
                  data-sortable="true"
                  data-class="align-middle"
                  data-filter-control="input"
                  data-switchable="true">QID</th>
              <th data-field="topic"
                  data-sortable="true"
                  data-class="align-middle"
                  data-formatter="topicFormatter"
                  data-filter-control="select"
                  data-filter-data="json:<%= JSON.stringify(all_topics) %>"
                  data-filter-custom-search="elementListFilterSearch"
                  data-switchable="true">Topic</th>
              <th data-field="tags"
                  data-sortable="false"
                  data-class="align-middle"
                  data-formatter="tagsFormatter"
                  data-filter-control="select"
                  data-filter-data="json:<%= JSON.stringify(all_tags) %>"
                  data-filter-custom-search="elementListFilterSearch"
                  data-switchable="true">Tags</th>
              <th data-field="display_type"
                  data-sortable="true"
                  data-class="align-middle"
                  data-formatter="versionFormatter"
                  data-filter-control="select"
                  data-filter-data="json:<%= JSON.stringify(all_versions) %>"
                  data-filter-custom-search="elementListFilterSearch"
                  data-switchable="true">Version</th>
              <% if (locals.course_instance) { %>
              <th data-field="assessments"
                  data-sortable="true"
                  data-class="align-middle"
                  data-formatter="assessmentsFormatter"
                  data-filter-control="select"
                  data-filter-data="json:<%= JSON.stringify(all_assessments) %>"
                  data-filter-custom-search="elementListFilterSearch"
                  data-switchable="true">Assessments</th>
              <% } %>
            </tr>
          </thead>
          </table>
        </div>
      </div>
    </div>
</body>

</html>
