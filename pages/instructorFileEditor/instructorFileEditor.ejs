<head>
    <%- include('../partials/head'); %>
    <script src="/javascripts/lodash.min.js"></script>
    <script src="/javascripts/d3.min.js"></script>
    <link href="/stylesheets/theme.bootstrap.css" rel="stylesheet" />
    <script src="/node_modules/ace-builds/src-min-noconflict/ace.js"></script>
    <script src="./edit/instructorFileEditorClient.js"></script>
    <script src="/javascripts/socket.io.js"></script>
</head>

<body>
    <%- include('../partials/navbar'); %>

    <div class="container">
        <%- include('../partials/navtabs'); %>

        <script>
            $(function() {
                new window.InstructorFileEditor({
                    contents: "<%- fileEdit.editContents %>",
                    aceMode: "ace/mode/<%= fileEdit.aceMode %>",
                    elementId: "file-editor-<%= fileEdit.uuid %>-draft",
                    saveElementId: "file-editor-<%= fileEdit.uuid %>-save-button",
                    <% if (fileEdit.doChoiceDialog) { %>
                    altElementId: "file-editor-<%= fileEdit.uuid %>-disk",
                    <% } %>
                });

                new window.InstructorFileEditor({
                    contents: "<%- fileEdit.diskContents %>",
                    aceMode: "ace/mode/<%= fileEdit.aceMode %>",
                    elementId: "file-editor-<%= fileEdit.uuid %>-disk",
                    readOnly: true,
                });
            });
        </script>

        <form method="POST">
            <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
            <input type="hidden" name="file_edit_user_id" value="<%= fileEdit.userID %>">
            <input type="hidden" name="file_edit_course_id" value="<%= fileEdit.courseID %>">
            <input type="hidden" name="file_edit_dir_name" value="<%= fileEdit.dirName %>">
            <input type="hidden" name="file_edit_file_name" value="<%= fileEdit.fileName %>">
            <input type="hidden" name="file_edit_orig_hash" value="<%= fileEdit.origHash %>">

            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center justify-content-between">
                        <div class="col-auto">
                            Editing file <%= fileEdit.dirName %>/<%= fileEdit.fileName %>
                        </div>
                        <div class="col-auto">
                            <button id="file-editor-<%= fileEdit.uuid %>-save-button" name="__action" value="save_and_sync" class="btn btn-primary" disabled>Save and Sync</button>
                        </div>
                    </div>

                </div>
                <div class="card-body p-0 row">
                    <div class="container">
                        <% if (fileEdit.alertPushSuccess) { %>
                        <div class="alert alert-success alert-dismissible fade show m-2" role="alert">
                            File was saved successfully.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <% } %>

                        <% if (fileEdit.alertPushFailure) { %>
                        <div class="alert alert-danger alert-dismissible fade show m-2" role="alert">

                            <div class="row align-items-center">
                                <div class="col-auto">
                                    Failed to save file.
                                </div>
                                <% if (fileEdit.jobSequenceId != null) { %>
                                <div class="col-auto">
                                    <a class="btn btn-secondary btn-sm" data-toggle="collapse" href="#error-<%= fileEdit.uuid %>" role="button">Detail</a>
                                </div>
                                <% } %>
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <% if (fileEdit.jobSequenceId != null) { %>
                            <div class="row collapse mt-2" id="error-<%= fileEdit.uuid %>">
                                <div class="card card-body">
                                    <%- include('../partials/jobSequenceResults', {job_sequence: fileEdit.jobSequence, job_sequence_enable_live_update: false}); %>
                                </div>
                            </div>
                            <% } %>
                        </div>
                        <% } %>

                        <% if (fileEdit.alertChoiceSameHash) { %>
                        <div class="alert alert-danger alert-dismissible fade show m-2" role="alert">
                            You were editing this file and made changes. You may choose either to continue editing or to discard your changes.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <% } %>

                        <% if (fileEdit.alertChoiceDiffHash) { %>
                        <div class="alert alert-danger alert-dismissible fade show m-2" role="alert">
                            Both you and another user made changes to this file. You may choose either to continue editing your draft or to discard your changes.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <% } %>
                    </div>

                    <div id="file-editor-<%= fileEdit.uuid %>-draft" class="col">
                        <div class="card p-0">
                            <% if (fileEdit.doChoiceDialog) { %>
                            <div class="card-header bg-white text-center">
                                <button id="choose" class="btn btn-warning" type="button">Choose this version (continue editing)</button>
                            </div>
                            <% } %>
                            <div class="card-body p-0">
                                <input type="hidden" name="file_edit_contents">
                                <div class="editor"></div>
                            </div>
                        </div>
                    </div>
                    <% if (fileEdit.doChoiceDialog) { %>
                    <div id="file-editor-<%= fileEdit.uuid %>-disk" class="col">
                        <div class="card p-0">
                            <div class="card-header bg-white text-center">
                                <button name="__action" value="discard_draft" class="btn btn-warning">Choose this version (discard changes)</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="editor"></div>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
        </form>
    </div>
</body>
</html>
