<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/head'); %>
    <link href="/stylesheets/theme.bootstrap.css" rel="stylesheet" />
    <script src="/javascripts/jquery.tablesorter.min.js"></script>
    <script src="/javascripts/jquery.tablesorter.widgets.js"></script>
  </head>
  <body>
    <script>
      $(function () {
          $('[data-toggle="popover"]').popover({sanitize: false})
      });
    </script>
    <%- include('../partials/navbar'); %>
    <div id="content" class="container-fluid">
      <div class="modal fade" id="uploadAssessmentGroupsModal" tabindex="-1" role="dialog" aria-labelledby="uploadAssessmentGroups">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="uploadAssessmentGroupsModalLabel">Upload new group setting</h4>
            </div>
            <div class="modal-body">
              <%- include('csvHelpInstanceGroups'); %>
              <form name="upload-assessment-group-form" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                  <div class="custom-file">
                    <input type="file" name="file" class="custom-file-input" id="uploadAssessmentGroupsFileInput">
                    <label class="custom-file-label" for="uploadAssessmentGroupsFileInput">Choose CSV file</label>
                  </div>
                </div>
                <div class="d-flex justify-content-end">
                  <div class="form-group mb-0">
                    <input type="hidden" name="__action" value="upload_assessment_groups">
                    <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    <div id="content" class="container-fluid">
      <div class="modal fade" id="autoAssessmentGroupsModal" tabindex="-1" role="dialog" aria-labelledby="autoAssessmentGroups">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="autoAssessmentGroupsModalLabel">Auto new group setting</h4>
            </div>
            <div class="modal-body">
              <form name="auto-assessment-group-form" method="POST" enctype="multipart/form-data">
                <div class="radio">
                  <label><input type="radio" name="optradio" checked>Grouping entire class</label>
                </div>
                <div class="radio">
                  <label><input type="radio" name="optradio">Grouping not-assigned students (fill existing groups first)</label>
                </div>
                <div class="radio">
                  <label><input type="radio" name="optradio">Grouping not-assigned students (will not change existing groups; create new groups only)</label>
                </div>
                <div class="d-flex justify-content-end">
                  <div class="form-group mb-0">
                    <input type="hidden" name="__action" value="auto_assessment_groups">
                    <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Group</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="content" class="container-fluid">
        <div class="modal fade" id="copyAssessmentGroupsModal" tabindex="-1" role="dialog" aria-labelledby="copyAssessmentGroups">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title" id="copyAssessmentGroupsModalLabel">Copy group setting</h4>
              </div>
              <div class="modal-body">
                <form name="copy-assessment-group-form" method="POST" enctype="multipart/form-data">
                  <div class="input-group mb-3">
                    <select class="custom-select" name="inputGroupSelect01">
                      <option selected>Choose Assessment...</option>
                      <% assessment_list_rows.forEach(function(row, iRow) {%>
                        <option value = <%= row.id %> ><%= row.tid %>: <%= row.title %></option>
                      <% }); %>    
                    </select>
                  </div>
                  <div class="d-flex justify-content-end">
                    <div class="form-group mb-0">
                      <input type="hidden" name="__action" value="copy_assessment_groups">
                      <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Copy</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>  
      
      <div class="modal fade" id="deleteAssessmentInstanceModal" tabindex="-1" role="dialog" aria-labelledby="deleteAssessmentInstance">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="deleteAssessmentInstanceModalLabel">Delete assessment instance</h4>
            </div>
            <div class="modal-body">
              Are you sure you want to delete assessment
              instance <span class="modal-number"></span>
              of <strong><%= assessment_set.name
              %> <%= assessment.number %></strong>
              for <strong><span class="modal-name"></span></strong>
              (<span class="modal-uid"></span>) with a score
              of <span class="modal-score-perc"></span>%?
            </div>
            <div class="modal-footer">
              <form name="delete-form" method="POST">
                <input type="hidden" name="__action" value="delete">
                <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                <input type="hidden" name="assessment_instance_id" class="modal-assessment-instance-id" value="">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <script>
        $('#deleteAssessmentInstanceModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var uid = button.data('uid'); // Extract info from data-* attributes
            var name = button.data('name');
            var number = button.data('number');
            var score_perc = button.data('score-perc');
            var assessment_instance_id = button.data('assessment-instance-id');
            var modal = $(this);
            modal.find('.modal-uid').text(uid);
            modal.find('.modal-name').text(name);
            modal.find('.modal-number').text(number);
            modal.find('.modal-score-perc').text(score_perc);
            modal.find('.modal-assessment-instance-id').val(assessment_instance_id);
        });
      </script>

      <div class="modal fade" id="deleteAllGroupsModal" tabindex="-1" role="dialog" aria-labelledby="deleteAllAssessmentInstances">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="deleteAllGroupsModalLabel">Delete all exisitng groups</h4>
            </div>
            <div class="modal-body">
              Are you sure you want to delete all exisitng groups
              for <strong><%= assessment_set.name %>
              <%= assessment.number %></strong>? This cannot be
              undone.
            </div>
            <div class="modal-footer">
              <form name="delete-all-form" method="POST">
                <input type="hidden" name="__action" value="delete_all">
                <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete all</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <%= assessment_set.name %> <%= assessment.number %>: Groups
          <div class="ml-auto">
            <button type="button" class="btn btn-sm btn-light" tabindex="0"
               data-toggle="modal" data-target="#deleteAllGroupsModal">
              <i class="fa fa-times" aria-hidden="true"></i> Delete all groups
            </button>
          </div>
        </div>

        <div class="table-responsive pb-0">
          <table class="table">
            <tr>
              <td style="width: 1%">
                <button type="button" class="btn btn-primary text-nowrap" data-toggle="modal" data-target="#uploadAssessmentGroupsModal">
                  <i class="fas fa-upload"></i> Upload
                </button>
              </td>
              <td>
                <p>
                  Upload a CSV format file for group setting.
                </p>
              </td>
              <td style="width: 1%">
                <button type="button" class="btn btn-primary text-nowrap" data-toggle="modal" data-target="#autoAssessmentGroupsModal">
                  <i class="fas fa-robot"></i> Auto
                </button>
              </td>
              <td>
                <p>
                  Quick group students into teams by system.
                </p>
              </td>
              <td style="width: 1%">
                <button type="button" class="btn btn-primary text-nowrap" data-toggle="modal" data-target="#copyAssessmentGroupsModal">
                  <i class="fas fa-copy"></i> Copy
                </button>
              </td>
              <td>
                <p>
                  Copy the group setting from another assessment.
                </p>
              </td>
            </tr>
          </table>
        </div>
        <div class="table-responsive">
          <table id="usersTable" class="table table-sm table-hover tablesorter">
            <thead>
              <tr>
                <th>GID</th>
                <th>Group Name</th>
                <th>#Members</th>
                <th class="text-center">Group Members (UIDs)</th>
                <th class="text-center"></th>
                <th class="text-center"></th>
              </tr>
            </thead>
            <tbody>
              <% groups_rows.forEach(function(row, iRow) { %>
              <tr>
                <td><%= row.gid %></td>
                <td><%= row.groupname %></td>
                <td class="text-center"><%= row.num %></td>
                <td class="text-center"><%= row.uids %></td>
                <td class="text-center">
                  <div class="dropdown">
                    <button type="button" class="btn btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Action <span class="caret"></span>
                    </button>
                    <div id="row<%= iRow %>PopoverOpen"
                         tabindex="0" data-toggle="popover" data-trigger="manual" data-container="body"
                         data-html="true" data-placement="auto" title="Confirm open"
                         data-content="
                                       <p><small>
                                           This will disable auto-closing. The assessment will need to be manually closed.
                                       </small></p>
                                       <form name=&quot;open-form&quot; method=&quot;POST&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__action&quot; value=&quot;open&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__csrf_token&quot; value=&quot;<%= __csrf_token %>&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;assessment_instance_id&quot; value=&quot;<%= row.assessment_instance_id %>&quot;>
                                         <button type=&quot;button&quot; class=&quot;btn btn-secondary&quot; onclick=&quot;$('#row<%= iRow %>PopoverOpen').popover('hide')&quot;>
                                           Cancel
                                         </button>
                                         <button type=&quot;submit&quot; class=&quot;btn btn-success&quot;>Open assessment</button>
                                       </form>
                                       ">
                    </div>
                    <div id="row<%= iRow %>PopoverClose"
                         tabindex="0" data-toggle="popover" data-trigger="manual" data-container="body"
                         data-html="true" data-placement="auto" title="Confirm close"
                         data-content="
                                       <form name=&quot;close-form&quot; method=&quot;POST&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__action&quot; value=&quot;close&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__csrf_token&quot; value=&quot;<%= __csrf_token %>&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;assessment_instance_id&quot; value=&quot;<%= row.assessment_instance_id %>&quot;>
                                         <button type=&quot;button&quot; class=&quot;btn btn-secondary&quot; onclick=&quot;$('#row<%= iRow %>PopoverClose').popover('hide')&quot;>
                                           Cancel
                                         </button>
                                         <button type=&quot;submit&quot; class=&quot;btn btn-danger&quot;>Grade and close</button>
                                       </form>
                                       ">
                    </div>
                    <div id="row<%= iRow %>PopoverRegrade"
                         tabindex="0" data-toggle="popover" data-trigger="manual" data-container="body"
                         data-html="true" data-placement="auto" title="Confirm regrade"
                         data-content="
                                       <form name=&quot;regrade-form&quot; method=&quot;POST&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__action&quot; value=&quot;regrade&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;__csrf_token&quot; value=&quot;<%= __csrf_token %>&quot;>
                                         <input type=&quot;hidden&quot; name=&quot;assessment_instance_id&quot; value=&quot;<%= row.assessment_instance_id %>&quot;>
                                         <button type=&quot;button&quot; class=&quot;btn btn-secondary&quot; onclick=&quot;$('#row<%= iRow %>PopoverRegrade').popover('hide')&quot;>
                                           Cancel
                                         </button>
                                         <button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;>Regrade</button>
                                       </form>
                                       ">
                    </div>

                    <!-- Capture all clicks to dropdown items to prevent scrolling to the top of the page -->
                    <div class="dropdown-menu" onclick="window.event.preventDefault();">

                      <!-- ################################################## -->

                      <% if (authz_data.has_instructor_edit) { %>
                      <a class="dropdown-item"
                         href="#"
                         data-toggle="modal" data-target="#deleteAssessmentInstanceModal"
                         data-uid="<%= row.uid %>" data-name="<%= row.name %>"
                         data-number="<%= row.number %>"
                         data-score-perc="<%= Math.floor(row.score_perc) %>"
                         data-assessment-instance-id="<%= row.assessment_instance_id %>"
                         >
                        <i class="fa fa-times" aria-hidden="true"></i> Delete
                      </a>
                      <% } %>

                      <!-- ################################################## -->

                      <% if (authz_data.has_instructor_edit) { %>
                      <a class="dropdown-item" onclick="$('#row<%= iRow %>PopoverRegrade').popover('show')" href="#">
                        <i class="fa fa-sync" aria-hidden="true"></i> Regrade
                      </a>
                      <% } %>

                      <!-- ################################################## -->

                      <% if (authz_data.has_instructor_edit) { %>
                      <a class="dropdown-item <% if (row.open) { %>disabled<% } %>" <% if (!row.open) { %>onclick="$('#row<%= iRow %>PopoverOpen').popover('show')"<% } %> href="#">
                        <i class="far fa-circle" aria-hidden="true"></i> Re-open
                      </a>
                      <% } %>

                      <!-- ################################################## -->

                      <% if (authz_data.has_instructor_edit) { %>
                      <a class="dropdown-item <% if (!row.open) { %>disabled<% } %>" <% if (row.open) { %>onclick="$('#row<%= iRow %>PopoverClose').popover('show')"<% } %> href="#">
                        <i class="fa fa-ban" aria-hidden="true"></i> Close
                      </a>
                      <% } %>

                      <!-- ################################################## -->

                    </div>
                  </div>
                </td>
                <td class="text-center"><a href="<%= urlPrefix %>/assessment_instance/<%= row.assessment_instance_id %>" class="btn btn-xs btn-info">Details</a></td>
              </tr>
              <% }); %>
            </tbody>
          </table>
          
          <div class="card-footer">
            <small>
              <strong>Not yet assigned students:</strong>
                <ul>
                  <% not_assigned_users_rows.forEach(function(row, iRow) {%>
                  <li><%= row.uid %></li>
                  <% }); %>
                </ul>
              <strong>Group Management</strong>
              <ul>
                <li><strong>Add a group: </strong>...</li>
                <li><strong>Merge groups: </strong>...</li>
                <li><strong>Delete a group: </strong>...</li>
  
                <li><strong>Add a Member: </strong>...</li>
                <li><strong>Move a Member: </strong>...</li>
                <li><strong>Delete a Member: </strong>...</li>
              </ul>
            </small>
          </div>
        </div>
        <script>
          $(function(){
              $("#usersTable").tablesorter({
                  theme: "bootstrap",
                  widthFixed: true,
                  headerTemplate: '{content} {icon}',
                  widgets: ["uitheme"],
                  headers: {
                      7: {sorter: false},
                      8: {sorter: false},
                  },
              });
          });
        </script>
      </div>

    </div>
  </body>
</html>
