<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/head'); %>
  </head>
  <body>
    <%- include('../partials/navbar', {navPage: ''}); %>
    <div id="content" class="container">
      <div class="card mb-4">

        <div class="card-header bg-primary text-white">
          <%= assessment_set.abbreviation %><%= assessment.number %>: <%= assessment.title %>
        </div>

        <div class="card-body">
          <% if (authz_result.mode == 'Exam' || authz_result.mode == 'SEB' || authz_result.password != null ) { %>
          <p class="lead text-center">
            Please wait until instructed to start by a proctor
          </p>
          <% } %>

          <p class="lead text-center">
            This is <strong><%= assessment_set.name %> <%= assessment.number %>: <%= assessment.title %></strong> for <strong><%= course.short_name %></strong>
          </p>

          <% if (authz_result.time_limit_min != undefined) { %>
          <p class="lead text-center">
            The time limit for this assessment is
            <strong>
              <%= authz_result.time_limit_min %>
              <%= (authz_result.time_limit_min == 1) ? 'minute' : 'minutes' %>
            </strong>
          </p>
          <% } %>

          <% if (locals.assessment.require_honor_code) { %>
          <div class="card card-secondary mb-4 test-class-honor-code">
            <ul class="list-group list-group-flush">
              <li class="list-group-item py-2">I certify that I am <%= user.name %> and I am allowed to take this assessment.</li>
              <li class="list-group-item py-2">I pledge on my honor that I will not give or receive any unauthorized assistance on this assessment and that all work will be my own.</li>
            </ul>

            <div class="card-footer text-center border-top-0 py-2">
              <span class="form-check d-inline">
                <input type="checkbox" class="form-check-input" id="certify-pledge">
                <label class="form-check-label font-weight-bold" for="certify-pledge">I certify and pledge the above.</label>
              </span>
            </div>
          </div>
          <% } %>

          <form id="confirm-form" name="confirm-form" method="POST" class="d-flex justify-content-center">
            <input type="hidden" name="__action" value="newInstance">
            <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">
            <div class="d-flex justify-content-center">
              <button id="start-assessment" type="submit" class="btn btn-primary" <% if (locals.assessment.require_honor_code) { %> disabled<% } %>>
                <% if (assessment.multiple_instance) { %>
                  New instance
                <% } else { %>
                  Start assessment
                <% } %>
              </button>
            </div>
          </form>

          <script>
            const certify = $('#certify-pledge')[0];
            const start = $('#start-assessment')[0];
            const form = $('#confirm-form')[0];

            certify.onchange = () => {
              start.disabled = !certify.checked;
            };

            form.onsubmit = () => {
                start.disabled = true;
                start.html = '<i class="fa fa-sync fa-spin fa-fw"></i> Generating assessmentâ€¦';
            };
          </script>

        </div> <!-- card-body -->
        <% if (assessment.multiple_instance && rows.length > 0) { %>
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th style="width: 1%">Instances</th>
                <th></th>
                <th class="text-center">Available credit</th>
                <th class="text-center">Score</th>
              </tr>
            </thead>
            <tbody>
              <% rows.forEach(function(row) { %>
              <tr>
                <td class="align-middle" style="width: 1%">
                  <a href="<%= urlPrefix %><%= row.link %>"
                    class="badge color-<%= row.assessment_set_color %> color-hover">
                    <%= row.label %>
                  </a>
                </td>
                <td class="align-middle">
                  <a href="<%= urlPrefix %><%= row.link %>"><%= row.title %></a>
                </td>
                <td class="text-center align-middle">
                  <% if (row.assessment_instance_open !== false) { %>
                      <%= row.credit_date_string %>
                  <% } else { %>
                      Assessment closed.
                  <% } %>
                  <%- include('../partials/studentAccessRulesPopover', {
                      accessRules: row.access_rules,
                      assessmentSetName: row.assessment_set_name,
                      assessmentNumber: row.assessment_number,
                      }) %>
                </td>
                <td class="text-center align-middle">
                  <% if (row.assessment_instance_id) { %>
                      <%- include('../partials/scorebar', {score: row.assessment_instance_score_perc}) %>
                  <% } else { %>
                      Not started
                  <% } %>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
        <% } %>
      </div>
    </div>
  </body>
</html>
