<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head'); %>
    <script src="<%= node_modules_asset_path('bootstrap-table/dist/bootstrap-table.min.js') %>"></script>
    <script src="<%= node_modules_asset_path('bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js') %>"></script>
    <link href="<%= node_modules_asset_path('bootstrap-table/dist/bootstrap-table.min.css') %>" rel="stylesheet" />
    <link href="<%= node_modules_asset_path('bootstrap-table/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.css') %>" rel="stylesheet" />
  </head>
  <script>
    $(function() {
        let gradeData = <%- JSON.stringify(user_scores_data) %>;
        $('#gradebook-table').bootstrapTable({
            data: gradeData,
            onPreBody: function() {
                $('button.edit-score').popover('hide');
            },
            onResetView: function () {
                $('button.edit-score').popover({
                    sanitize: false,
                    placement: 'auto',
                    container: 'body',
                    html: true,
                    content: function() {
                        var that = this
                        var assessmentInstanceId = $(this).data('ai-id')
                        var score = $(this).data('score')
                        var form = $('<form name="edit-total-score-perc-form" method="POST"></form>')
                        form.append('<input type="hidden" name="__action" value="edit_total_score_perc">')
                        form.append('<input type="hidden" name="__csrf_token" value="<%= __csrf_token %>">')
                        form.append('<input type="hidden" name="assessment_instance_id" value="' + assessmentInstanceId + '">')
                        var formGroup = $('<div class="form-group">')
                        var inputGroup = $('<div class="input-group">')
                        inputGroup.append('<input type="text" class="form-control" name="score_perc" value="' + score + '">')
                        inputGroup.append('<div class="input-group-append"><span class="input-group-text">%</span></div>')
                        formGroup.append(inputGroup)
                        form.append(formGroup)
                        form.append('<p><small>This change will be overwritten if further questions are answered by the student.</small></p>')
                        var cancel = $('<button type="button" class="btn btn-secondary mr-2">Cancel</button>')
                        cancel.on('click', function() {
                            $(that).popover('hide')
                        })
                        form.append(cancel)
                        form.append('<button type="submit" class="btn btn-primary">Change</button>')
                        form.submit(function(e) {
                            e.preventDefault();
                            $.post($(this).attr('action'), $(this).serialize(), function(data) {
                                data.forEach(score => {
                                    $('#gradebook-table').bootstrapTable('updateCellByUniqueId', {
                                        id: score.user_id,
                                        field: `score_${score.assessment_id}`,
                                        value: score.score_perc,
                                    });
                                })
                            }, 'json');
                            $(that).popover('hide');
                        })
                        return form
                    },
                    title: 'Change total percentage score',
                    trigger: 'click',
                }).on('show.bs.popover', function(e) {
                    $('button.edit-score').not(this).popover('hide');
                });
            },
        });
    });
    function gradeFormatter(score, row, index, field) {
        var assessment_instance_id = row[field + '_ai'];
        if (score == null) {
            return "â€”";
        } else {
            var container = $('<div>');
            var link = $('<a/>').attr('href', `<%= urlPrefix %>/assessment_instance/${assessment_instance_id}`)
                .text(Math.floor(score) + '%').appendTo(container);
            if (<%= authz_data.has_instructor_edit %>) {
                var button = $('<button/>').attr('type', 'button').addClass('btn btn-xs btn-secondary edit-score')
                    .attr('tabindex', 0).attr('data-ai-id', assessment_instance_id).attr('data-score', score)
                    .append($('<i class="fa fa-edit" aria-hidden="true"></i>'))
                    .appendTo(container);
            }
            return container.html();
        }
    }
  </script>
  <style>
    .sticky-column {
      position: sticky;
      left: 0;
      background: white;
      box-shadow: inset -1px 0 #dee2e6;
    }
  </style>
  <body>
    <%- include('../partials/navbar'); %>
    <div id="content" class="container-fluid">
      <%- include('../partials/courseInstanceSyncErrorsAndWarnings'); %>
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Users
        </div>

        <div id="table-toolbar" class="p-2 pl-3">
          Download <a href="<%= urlPrefix %>/<%= navPage %>/gradebook/<%= csvFilename %>"><%= csvFilename %></a>
        </div>

        <table id="gradebook-table"
               data-unique-id="user_id"
               data-classes="table table-sm table-hover table-bordered"
               data-minimum-count-columns="0"
               data-search="true"
               data-show-columns="true"
               data-show-columns-toggle-all="true"
               data-toolbar="#table-toolbar"
               data-sticky-header="true">
            <thead>
              <tr>
                <th data-field="user_id"
                    data-visible="false"
                    data-switchable="false"></th>
                <th data-field="uid"
                    data-sortable="true"
                    data-class="sticky-column bg-white text-nowrap"
                    data-switchable="false">UID</th>
                <th data-field="uin"
                    data-sortable="true"
                    data-class="text-nowrap"
                    data-switchable="false">UIN</th>
                <th data-field="user_name"
                    data-sortable="true"
                    data-class="text-nowrap"
                    data-switchable="false">Name</th>
                <th data-field="role"
                    data-sortable="false"
                    data-switchable="false">Role</th>
                <% course_assessments.forEach(function(assessment, iAssessment) { %>
                <th data-field="score_<%= assessment.assessment_id %>"
                    data-sortable="true"
                    data-class="text-nowrap"
                    data-formatter="gradeFormatter"
                    data-sort-order="desc"><%- include('../partials/assessment', {assessment: assessment}); %></th>
                <th data-field="score_<%= assessment.assessment_id %>_ai"
                    data-visible="false"
                    data-switchable="false"></th>
                <% }); %>
              </tr>
            </thead>
        </table>

        <div class="card-footer">
          <p>Download <a href="<%= urlPrefix %>/<%= navPage %>/gradebook/<%= csvFilename %>"><%= csvFilename %></a></p>
          <small>
            <strong>Roles:</strong>
             <ul>
                 <li><strong>Instructor</strong> is a person in charge of the course. They have full permission to see and edit the information of other users.</li>
                 <li><strong>TA</strong> is a teaching assistant. They can see the data of all users, but can only edit their own information.</li>
                 <li><strong>Student</strong> is a student participating in the class. They can only see their own information, and can do assessments.</li>
                 <li><strong>None</strong> is a user who at one point added the course and later removed themselves. They can no longer access the course but their work done within the course has been retained.</li>
            </ul>
          </small>
        </div>

      </div>
    </div>
    <!-- needed for tests since we can't grab it out of javascript -->
    <input type="hidden" name="__csrf_token" value="<%= __csrf_token %>"
  </body>
</html>
