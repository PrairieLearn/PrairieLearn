import prairielearn as pl
import lxml.html
import numpy as np
import chevron


def prepare(element_html, element_index, data):
    element = lxml.html.fragment_fromstring(element_html)
    required_attribs = ['params-name']
    optional_attribs = ['label', 'digits', 'presentation-type']
    pl.check_attribs(element, required_attribs, optional_attribs)


def render(element_html, element_index, data):
    element = lxml.html.fragment_fromstring(element_html)

    # Get the number of digits to output
    digits = pl.get_integer_attrib(element, 'digits', 2)
    # Get the presentation type
    presentation_type = pl.get_string_attrib(element, 'presentation-type', 'f')

    var_name = pl.get_string_attrib(element, 'params-name')
    # Get value of variable, raising exception if variable does not exist
    var_data = data['params'].get(var_name, None)
    if var_data is None:
        raise Exception('No value in data["params"] for variable %s in pl-matrix-latex element' % var_name)

    # If the variable is in a format generated by pl.to_json, convert it
    # back to a standard type (otherwise, do nothing)
    var_data = pl.from_json(var_data)

    # Get the label. Start with blank string if no label is given
    label = pl.get_string_attrib(element, 'label', '')

    if np.isscalar(var_data):
        latex_data = label + '$' + pl.latex_from_2darray(var_data, presentation_type=presentation_type, digits=digits) + '$'
    else:
        # Wrap the variable in an ndarray (if it's already one, this does nothing)
        var_data = np.array(var_data)
        # Check shape of variable
        if var_data.ndim != 2:
            raise Exception('Value in data["params"] for variable %s in pl-matrix-latex element must be 2D array or scalar' % var_name)

    # Create string for latex matrix format
    latex_data = label + '$' + pl.latex_from_2darray(var_data, presentation_type=presentation_type, digits=digits) + '$'

    html_params = {
        'latex_data': latex_data,
        'element_index': element_index,
        'uuid': pl.get_uuid()
    }

    with open('pl-matrix-latex.mustache', 'r', encoding='utf-8') as f:
        html = chevron.render(f, html_params).strip()

    return html
