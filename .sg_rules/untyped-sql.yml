id: untyped-sql
message: You are using an untyped version of a database query.
severity: error
language: TypeScript
rule:
  any:
    # - all:
    #     - kind: call_expression
    #     - has:
    #         field: function
    #         any:
    #           - pattern: queryCursor
    #           - pattern: sqldb.queryCursor
    #     - pattern: $FUNC($$$ARGS)
    - all:
        - kind: call_expression
        - has:
            field: function
            any:
              - pattern: queryRows
              - pattern: sqldb.queryRows
              - pattern: queryRow
              - pattern: sqldb.queryRow
              - pattern: queryOptionalRow
              - pattern: sqldb.queryOptionalRow
        - pattern: $FUNC($A, $B)
    - all:
        - kind: variable_declarator
        - has:
            field: name
            kind: identifier
            pattern: $VAR_NAME
        - has:
            field: value
            any:
              - kind: await_expression
                has:
                  all:
                    - kind: call_expression
                    - has:
                        field: function
                        any:
                          - pattern: sqldb.queryOneRowAsync
                          - pattern: queryOneRowAsync
                          - pattern: sqldb.queryZeroOrOneRowAsync
                          - pattern: queryZeroOrOneRowAsync
                          - pattern: sqldb.queryAsync
                          - pattern: queryAsync
constraints:
  B:
    all:
      - not:
          regex: 'z\..*'
      - not:
          regex: '.*Schema'
