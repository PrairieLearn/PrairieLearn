#!/usr/bin/env node

var colors = require('colors');
var _ = require('lodash');
var ERR = require('async-stacktrace');

var databaseDescribe = require('../tests/databaseDescribe');

if (process.argv.length != 3) {
    process.stderr.write(`Usage: ${process.argv0} <database name>\n`);
    process.exit(1);
}

var args = process.argv.slice(2);

// Disable color if we're not attached to a tty
var coloredOutput = process.stdout.isTTY;

const options = {
    databaseName: args[0],
    outputFormat: 'string',
    coloredOutput: coloredOutput
};

var formatText = function(text, formatter) {
    if (coloredOutput) {
        return formatter(text);
    }
    return text;
};

databaseDescribe.describe(options, (err, description) => {
    if (ERR(err, (err) => console.log(err))) return process.exit(1);

    const sortedKeys = _.sortBy(_.keys(description.tables));

    _.forEach(sortedKeys, (tableName) => {
        var columns = description.tables[tableName];
        process.stdout.write(formatText(`==== ${tableName} ====\n`, colors.bold));
        process.stdout.write(columns);
        process.stdout.write('\n\n\n');
    })
    process.exit(0);
})
