#!/usr/bin/env node

import { Command } from 'commander';

import {
  diffDatabaseAndDirectory,
  diffDatabases,
  diffDirectories,
  diffDirectoryAndDatabase,
} from '../diff.js';

const program = new Command();
program
  .name('pg-diff')
  .usage('[options]')
  .option('--db <db...>', 'Reads a description from the named database (can be specified twice)')
  .option(
    '--dir <dir...>',
    "Reads a description from a directory that's been generated by pg-describe (can be specified twice)",
  )
  .showHelpAfterError();

program.parse(process.argv);
const opts = program.opts();

const options = {
  outputFormat: 'string',
  coloredOutput: process.stdout.isTTY,
};

if (opts.db.length === 2 && !opts.dir) {
  diffDatabases(opts.db[0], opts.db[1], options).then(handleResults, handleError);
} else if (opts.dir.length === 2 && !opts.db) {
  diffDirectories(opts.dir[0], opts.dir[1], options).then(handleResults, handleError);
} else if (opts.db.length === 1 && opts.dir.length === 1) {
  const dbIsFirst = process.argv.lastIndexOf('--db') < process.argv.lastIndexOf('--dir');
  if (dbIsFirst) {
    diffDatabaseAndDirectory(opts.db[0], opts.dir[0], options).then(handleResults, handleError);
  } else {
    diffDirectoryAndDatabase(opts.dir[0], opts.db[0], options).then(handleResults, handleError);
  }
} else {
  program.help({ error: true });
}

function handleResults(results: string) {
  process.stdout.write(results);
  process.exit(0);
}

function handleError(err: any) {
  console.error(err);
  process.exit(1);
}
