name: Images

on:
  push:
    branches:
      - 'master'
      # Build on all code freeze branches since we will deploy from them.
      - '**-code-freeze'
  pull_request:
  merge_group:

concurrency:
  # Ensure that we only run one concurrent job for Pull Requests. This ensures
  # that someone can't kill our throughput by pushing a bunch of commits to a
  # single branch in rapid succession.
  #
  # However, for master builds, we allow maximum concurrency. This is achieved
  # because `github.head_ref` isn't defined there, and `github.run_id` is
  # globally unique in this repo.
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-workspace-images:
    uses: ./.github/workflows/image-builder.yml
    with:
      group: workspaces
      images: prairielearn/workspace-desktop,prairielearn/workspace-jupyterlab,prairielearn/workspace-jupyterlab-python,prairielearn/workspace-rstudio,prairielearn/workspace-xtermjs,prairielearn/workspace-vscode-base,prairielearn/workspace-vscode-cpp,prairielearn/workspace-vscode-python
    secrets: inherit

  build-grader-images:
    uses: ./.github/workflows/image-builder.yml
    with:
      group: graders
      images: prairielearn/grader-c,prairielearn/grader-java,prairielearn/grader-python,prairielearn/grader-r
    secrets: inherit

  build-core-images:
    uses: ./.github/workflows/image-builder.yml
    with:
      group: core
      images: prairielearn/plbase,prairielearn/prairielearn,prairielearn/executor
    secrets: inherit
