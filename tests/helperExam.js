const ERR = require('async-stacktrace');
const _ = require('lodash');
const assert = require('chai').assert;
const request = require('request');
const cheerio = require('cheerio');

const config = require('../lib/config');
const sqldb = require('../prairielib/lib/sql-db');
const sqlLoader = require('../prairielib/lib/sql-loader');
const sql = sqlLoader.loadSqlEquiv(__filename);

// sorted alphabetically by qid
const questionsArray = [
  { qid: 'addNumbers', type: 'Freeform', maxPoints: 5 },
  { qid: 'addVectors', type: 'Calculation', maxPoints: 11 },
  { qid: 'brokenGeneration', type: 'Freeform', maxPoints: 10 },
  { qid: 'fossilFuelsRadio', type: 'Calculation', maxPoints: 17 },
  { qid: 'partialCredit1', type: 'Freeform', maxPoints: 19 },
  { qid: 'partialCredit2', type: 'Freeform', maxPoints: 9 },
  { qid: 'partialCredit3', type: 'Freeform', maxPoints: 13 },
];

const questions = _.keyBy(questionsArray, 'qid');

const assessmentMaxPoints = 84; // must be the sum of maxPoints in questionsArray, but we hard-code it for reference

let res, page, elemList;

module.exports = {
  questionsArray,
  questions,
  assessmentMaxPoints,

  startExam(locals) {
    describe('startExam-1. the locals object', function () {
      it('should be cleared', function () {
        for (var prop in locals) {
          delete locals[prop];
        }
      });
      it('should be initialized', function () {
        locals.siteUrl = 'http://localhost:' + config.serverPort;
        locals.baseUrl = locals.siteUrl + '/pl';
        locals.courseInstanceBaseUrl = locals.baseUrl + '/course_instance/1';
        locals.instructorBaseUrl = locals.courseInstanceBaseUrl + '/instructor';
        locals.instructorAssessmentsUrl = locals.instructorBaseUrl + '/instance_admin/assessments';
        locals.instructorGradebookUrl = locals.instructorBaseUrl + '/instance_admin/gradebook';
        locals.questionBaseUrl = locals.courseInstanceBaseUrl + '/instance_question';
        locals.assessmentsUrl = locals.courseInstanceBaseUrl + '/assessments';
        locals.isStudentPage = true;
        locals.totalPoints = 0;
      });
    });

    describe('startExam-2. the questions', function () {
      it('should have cleared data', function () {
        questionsArray.forEach(function (question) {
          for (var prop in question) {
            if (prop !== 'qid' && prop !== 'type' && prop !== 'maxPoints') {
              delete question[prop];
            }
          }
          question.points = 0;
        });
      });
    });

    describe('startExam-3. the database', function () {
      it('should contain E1', function (callback) {
        sqldb.queryOneRow(sql.select_e1, [], function (err, result) {
          if (ERR(err, callback)) return;
          locals.assessment_id = result.rows[0].id;
          callback(null);
        });
      });
    });

    describe('startExam-4. GET to assessments URL', function () {
      it('should load successfully', function (callback) {
        request(locals.assessmentsUrl, function (error, response, body) {
          if (error) {
            return callback(error);
          }
          if (response.statusCode !== 200) {
            return callback(new Error('bad status: ' + response.statusCode));
          }
          res = response;
          page = body;
          callback(null);
        });
      });
      it('should parse', function () {
        locals.$ = cheerio.load(page);
      });
      it('should contain E1', function () {
        elemList = locals.$('td a:contains("Exam for automatic test suite")');
        assert.lengthOf(elemList, 1);
      });
      it('should have the correct link for E1', function () {
        locals.assessmentUrl = locals.siteUrl + elemList[0].attribs.href;
        assert.equal(
          locals.assessmentUrl,
          locals.courseInstanceBaseUrl + '/assessment/' + locals.assessment_id + '/'
        );
      });
    });

    describe('startExam-5. GET to assessment URL', function () {
      it('should load successfully', function (callback) {
        request(locals.assessmentUrl, function (error, response, body) {
          if (error) {
            return callback(error);
          }
          if (response.statusCode !== 200) {
            return callback(new Error('bad status: ' + response.statusCode));
          }
          res = response;
          page = body;
          callback(null);
        });
      });
      it('should parse', function () {
        locals.$ = cheerio.load(page);
      });
      it('should contain "Exam 1"', function () {
        elemList = locals.$('p.lead strong:contains("Exam 1")');
        assert.lengthOf(elemList, 1);
      });
      it('should contain "QA 101"', function () {
        elemList = locals.$('p.lead strong:contains("QA 101")');
        assert.lengthOf(elemList, 1);
      });
      it('should have a CSRF token', function () {
        elemList = locals.$('form input[name="__csrf_token"]');
        assert.lengthOf(elemList, 1);
        assert.nestedProperty(elemList[0], 'attribs.value');
        locals.__csrf_token = elemList[0].attribs.value;
        assert.isString(locals.__csrf_token);
      });
    });

    describe('startExam-6. POST to assessment URL', function () {
      it('should load successfully', function (callback) {
        var form = {
          __action: 'new_instance',
          __csrf_token: locals.__csrf_token,
        };
        locals.preStartTime = Date.now();
        request.post(
          { url: locals.assessmentUrl, form: form, followAllRedirects: true },
          function (error, response, body) {
            if (error) {
              return callback(error);
            }
            locals.postStartTime = Date.now();
            if (response.statusCode !== 200) {
              return callback(new Error('bad status: ' + response.statusCode));
            }
            res = response;
            page = body;
            callback(null);
          }
        );
      });
      it('should parse', function () {
        locals.$ = cheerio.load(page);
      });
      it('should redirect to the correct path', function () {
        locals.assessmentInstanceUrl = locals.siteUrl + res.req.path;
        assert.equal(res.req.path, '/pl/course_instance/1/assessment_instance/1');
      });
      it('should create one assessment_instance', function (callback) {
        sqldb.query(sql.select_assessment_instances, [], function (err, result) {
          if (ERR(err, callback)) return;
          if (result.rowCount !== 1) {
            return callback(new Error('expected one assessment_instance, got: ' + result.rowCount));
          }
          locals.assessment_instance = result.rows[0];
          callback(null);
        });
      });
      it('should have the correct assessment_instance.assessment_id', function () {
        assert.equal(locals.assessment_instance.assessment_id, locals.assessment_id);
      });
      it(`should create ${questionsArray.length} instance_questions`, function (callback) {
        sqldb.query(sql.select_instance_questions, [], function (err, result) {
          if (ERR(err, callback)) return;
          if (result.rowCount !== questionsArray.length) {
            return callback(
              new Error(
                `expected ${questionsArray.length} instance_questions, got: ` + result.rowCount
              )
            );
          }
          locals.instance_questions = result.rows;
          callback(null);
        });
      });
      questionsArray.forEach(function (question, i) {
        it(`should have question #${i + 1} as QID ${question.qid}`, function () {
          question.id = locals.instance_questions[i].id;
          assert.equal(locals.instance_questions[i].qid, question.qid);
        });
      });
    });

    describe('startExam-7. GET to assessment_instance URL', function () {
      it('should load successfully', function (callback) {
        request(locals.assessmentInstanceUrl, function (error, response, body) {
          if (error) {
            return callback(error);
          }
          if (response.statusCode !== 200) {
            return callback(new Error('bad status: ' + response.statusCode));
          }
          res = response;
          page = body;
          callback(null);
        });
      });
      it('should parse', function () {
        locals.$ = cheerio.load(page);
      });
      questionsArray.forEach(function (question) {
        it(`should link to ${question.qid} question`, function () {
          const urlTail = '/pl/course_instance/1/instance_question/' + question.id + '/';
          question.url = locals.siteUrl + urlTail;
          elemList = locals.$(`td a[href="${urlTail}"]`);
          assert.lengthOf(elemList, 1);
        });
      });
    });
  },
};
